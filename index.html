<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">

  <style>
    body.dark-mode {
      background-color: #181a1f;
      color: #eaeaea;
    }
    .card { border-radius: 1rem; }
    .btn-toggle { cursor: pointer; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Attendance Dashboard</span>
      <button id="darkToggle" class="btn btn-outline-light btn-sm">
        <i class="bi bi-moon"></i> Dark Mode
      </button>
    </div>
  </nav>

  <div class="container-fluid mt-3">

    <!-- Filters -->
    <div class="card shadow-sm p-3 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" class="form-select" multiple></select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-md-2">
          <button id="applyFilters" class="btn btn-primary w-100">
            <i class="bi bi-funnel"></i> Apply
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-md-2"><div class="card p-3 text-center"><h5>Total Hours</h5><p id="totalHours">0</p></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h5>Avg Hours</h5><p id="avgHours">0</p></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h5>Days Count</h5><p id="daysCount">0</p></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h5>Late</h5><p id="lateCount">0</p></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h5>Early Leave</h5><p id="earlyCount">0</p></div></div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-md-4"><canvas id="barChart"></canvas></div>
      <div class="col-md-4"><canvas id="pieChart"></canvas></div>
      <div class="col-md-4"><canvas id="lineChart"></canvas></div>
    </div>

    <!-- Attendance Table -->
    <div class="card shadow-sm p-3 mb-5">
      <h5>Attendance Log</h5>
      <table id="attendanceTable" class="display nowrap" style="width:100%"></table>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
    let CANON=[],DT;

    function computeStatus(r){
      let res=[];
      if(r.signIn){
        const h=new Date(r.signIn).getHours(),m=new Date(r.signIn).getMinutes();
        if(h>8||(h===8&&m>15))res.push("Late");
      }
      if(r.signOut){
        const h=new Date(r.signOut).getHours(),m=new Date(r.signOut).getMinutes();
        if(h<16||(h===16&&m<30))res.push("Early Leave");
      }
      if(!res.length)res.push("On Time");
      return res;
    }

    async function loadData(){
      const csv=await fetch(CSV_URL).then(r=>r.text());
      const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
      CANON=parsed.data.map(r=>({
        month:r["Month"],date:r["Date"],employee:r["Employee Name"],
        signIn:r["Sign In Time"],signOut:r["Sign Out Time"],
        totalHours:parseFloat(r["Total Hours"])||0
      }));
      populateEmployeeFilter();
      applyFilters();
    }

    function populateEmployeeFilter(){
      const sel=document.getElementById("employeeFilter");
      sel.innerHTML="";
      [...new Set(CANON.map(r=>r.employee).filter(Boolean))].sort()
        .forEach(e=>{let o=document.createElement("option");o.value=o.textContent=e;sel.appendChild(o);});
    }

    function getCriteria(){
      return {
        employees:$("#employeeFilter").val()||[],
        start:document.getElementById("startDate").value,
        end:document.getElementById("endDate").value
      };
    }

    function applyFilters(){
      const c=getCriteria();
      const data=CANON.filter(r=>{
        if(c.employees.length && !c.employees.includes(r.employee)) return false;
        if(c.start && r.date < c.start) return false;
        if(c.end && r.date > c.end) return false;
        return true;
      });
      renderTable(data);
    }

    function renderTable(data){
      const tableData=data.map(r=>{
        const st=computeStatus(r);
        const badge=st.map(s=>`<span class="badge ${s==="Late"?"bg-danger":s==="Early Leave"?"bg-warning text-dark":s==="On Time"?"bg-success":"bg-secondary"}">${s}</span>`).join(" ");
        return [r.month,r.date,r.employee,r.signIn||"",r.signOut||"",r.totalHours.toFixed(2),badge];
      });
      if(!DT){
        DT=$("#attendanceTable").DataTable({
          data:tableData,
          columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Total Hours"},{title:"Status"}],
          dom:'Bfrtip',buttons:['csv','excel','pdf','print'],pageLength:10,order:[[1,'asc']]
        });
      } else {
        DT.clear().rows.add(tableData).draw();
      }

      let sum=0,days=new Set(),late=0,early=0;
      data.forEach(r=>{
        const st=computeStatus(r);
        if(st.includes("Late"))late++;
        if(st.includes("Early Leave"))early++;
        if(r.totalHours)sum+=r.totalHours;
        if(r.date)days.add(r.date);
      });
      document.getElementById("totalHours").textContent=sum.toFixed(2);
      document.getElementById("avgHours").textContent=(days.size?sum/days.size:0).toFixed(2);
      document.getElementById("daysCount").textContent=days.size;
      document.getElementById("lateCount").textContent=late;
      document.getElementById("earlyCount").textContent=early;

      renderCharts(data);
    }

    let barChart,pieChart,lineChart;
    function renderCharts(data){
      if(barChart)barChart.destroy(); if(pieChart)pieChart.destroy(); if(lineChart)lineChart.destroy();
      const grouped={}; data.forEach(r=>{if(r.date)grouped[r.date]=(grouped[r.date]||0)+r.totalHours;});
      barChart=new Chart(document.getElementById("barChart"),{type:"bar",data:{labels:Object.keys(grouped),datasets:[{label:"Hours",data:Object.values(grouped),backgroundColor:"#0d6efd"}]}});
      const per={}; data.forEach(r=>{if(r.employee)per[r.employee]=(per[r.employee]||0)+r.totalHours;});
      pieChart=new Chart(document.getElementById("pieChart"),{type:"pie",data:{labels:Object.keys(per),datasets:[{data:Object.values(per),backgroundColor:["#0d6efd","#00c9a7","#ff7e5f","#6f42c1","#ffc107"]}]}});
      lineChart=new Chart(document.getElementById("lineChart"),{type:"line",data:{labels:Object.keys(grouped),datasets:[{label:"Hours",data:Object.values(grouped),borderColor:"#28a745",fill:false}]}});
    }

    document.getElementById("applyFilters").addEventListener("click",applyFilters);
    document.getElementById("darkToggle").addEventListener("click",()=>{
      document.body.classList.toggle("dark-mode");
    });

    loadData();
  </script>
</body>
</html>
