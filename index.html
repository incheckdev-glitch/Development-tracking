<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables (Bootstrap 5 styling) -->
  <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- noUiSlider -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet" />

  <!-- Icons (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    /* Light / Dark theme via CSS vars */
    body {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #101828;
      --muted: #6b7280;
      --brand: #0d6efd;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
    }
    body.dark {
      --bg: #12141a;
      --card: #1a1d24;
      --text: #e7e9ee;
      --muted: #a1a7b3;
      --brand: #6aa8ff;
    }

    .card {
      background: var(--card);
      border: none;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(16,24,40,.06);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(16,24,40,.12); }

    .filter-bar {
      position: sticky; top: 0; z-index: 20;
      background: var(--card);
      border-radius: 16px;
      padding: 16px 16px 8px;
      box-shadow: 0 6px 20px rgba(16,24,40,.06);
      margin-bottom: 20px;
    }

    .kpi h6 { color: var(--muted); margin: 0; font-weight: 600; }
    .kpi h2 { margin: 4px 0 0; font-weight: 800; letter-spacing: .2px; }

    .badge-space { display: inline-flex; gap: 6px; flex-wrap: wrap; }

    /* DT overrides for dark mode */
    body.dark .dataTables_wrapper .dataTables_length,
    body.dark .dataTables_wrapper .dataTables_filter,
    body.dark .dataTables_wrapper .dataTables_info,
    body.dark .dataTables_wrapper .dataTables_processing,
    body.dark .dataTables_wrapper .dataTables_paginate {
      color: var(--text);
    }
    body.dark table.dataTable tbody tr { color: var(--text); }

    .select2-container .select2-selection--multiple {
      min-height: 38px; padding: 4px 6px; border-radius: 8px;
    }
    body.dark .select2-container--default .select2-selection--multiple {
      background: #2a2e37; color: var(--text); border-color: #394150;
    }
    .noUi-target { background: #e9ecef; border-radius: 8px; }
    body.dark .noUi-target { background: #2a2e37; }
    .noUi-connect { background: var(--brand); }
  </style>
</head>
<body>
  <div class="container-fluid p-4" id="reportArea">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
      <h2 class="mb-2">ðŸ“Š Attendance Dashboard</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="themeBtn"><i class="bi bi-moon-stars"></i> Dark</button>
        <button class="btn btn-success" id="reportBtn"><i class="bi bi-file-earmark-arrow-down"></i> Download Report</button>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filter-bar">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4">
          <label class="form-label"><i class="bi bi-people"></i> Employee(s)</label>
          <select id="employeeFilter" multiple></select>
          <div class="form-text" style="color:var(--muted)">Search / multi-select</div>
        </div>
        <div class="col-lg-2">
          <label class="form-label"><i class="bi bi-calendar-event"></i> Start Date</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-lg-2">
          <label class="form-label"><i class="bi bi-calendar-check"></i> End Date</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-lg-3">
          <label class="form-label"><i class="bi bi-hourglass-split"></i> Hour Range</label>
          <div id="hourSlider"></div>
          <div class="form-text" style="color:var(--muted)">Between <span id="hourMinLabel">0</span>h â€“ <span id="hourMaxLabel">12</span>h</div>
        </div>
        <div class="col-lg-1 d-grid">
          <button class="btn btn-primary" id="applyBtn"><i class="bi bi-funnel"></i> Apply</button>
        </div>
        <div class="col-12 d-flex justify-content-between mt-2">
          <div class="col-lg-4 pe-2">
            <label class="form-label"><i class="bi bi-search"></i> Quick Search</label>
            <input type="search" id="quickSearch" class="form-control" placeholder="Type to search in tableâ€¦">
          </div>
          <div>
            <button class="btn btn-outline-warning mt-4" id="resetBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
            <button class="btn btn-outline-secondary mt-4" id="refreshBtn"><i class="bi bi-arrow-repeat"></i> Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3 text-center">
      <div class="col-sm-6 col-lg-2"><div class="card p-3 kpi"><h6>Total Hours</h6><h2 id="totalHours">0</h2></div></div>
      <div class="col-sm-6 col-lg-2"><div class="card p-3 kpi"><h6>Avg Hours/Day</h6><h2 id="avgHours">0</h2></div></div>
      <div class="col-sm-6 col-lg-2"><div class="card p-3 kpi"><h6>Days Count</h6><h2 id="daysCount">0</h2></div></div>
      <div class="col-sm-6 col-lg-2"><div class="card p-3 kpi"><h6>Late Count</h6><h2 id="lateCount">0</h2></div></div>
      <div class="col-sm-6 col-lg-2"><div class="card p-3 kpi"><h6>Early Leaves</h6><h2 id="earlyCount">0</h2></div></div>
    </div>

    <!-- TABLE -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">Attendance Log</h5>
      <table id="attendanceTable" class="table table-striped table-hover w-100">
        <thead>
          <tr>
            <th>Month</th>
            <th>Date</th>
            <th>Employee</th>
            <th>Sign In</th>
            <th>Sign Out</th>
            <th>Total Hours</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- CHARTS -->
    <div class="row g-3">
      <div class="col-lg-6"><div class="card p-3"><h6>Hours per Day</h6><canvas id="barChart" height="140"></canvas></div></div>
      <div class="col-lg-6"><div class="card p-3"><h6>Hours by Employee</h6><canvas id="pieChart" height="140"></canvas></div></div>
      <div class="col-12"><div class="card p-3"><h6>Trend (Line)</h6><canvas id="lineChart" height="120"></canvas></div></div>
    </div>
  </div>

  <!-- JS libs (placed late for faster paint) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- noUiSlider -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
  <!-- html2canvas for report -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
  // ---------- CONFIG ----------
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";

  // ---------- STATE ----------
  let ROWS = [];      // canonical rows
  let DT = null;      // DataTable instance
  let barChart, pieChart, lineChart;
  let hourSlider;     // noUiSlider instance

  // ---------- THEME ----------
  const themeBtn = document.getElementById("themeBtn");
  function applySavedTheme() {
    const saved = localStorage.getItem("themeMode");
    if (saved === "dark") {
      document.body.classList.add("dark");
      themeBtn.innerHTML = '<i class="bi bi-brightness-high"></i> Light';
    }
  }
  function toggleTheme() {
    const dark = document.body.classList.toggle("dark");
    localStorage.setItem("themeMode", dark ? "dark" : "light");
    themeBtn.innerHTML = dark
      ? '<i class="bi bi-brightness-high"></i> Light'
      : '<i class="bi bi-moon-stars"></i> Dark';
  }
  themeBtn.addEventListener("click", toggleTheme);
  applySavedTheme();

  // ---------- CSV PARSING HELPERS ----------
  function normalizeHeaders(row) {
    const o = {};
    Object.keys(row).forEach(k => {
      if (!k) return;
      o[k.replace(/\uFEFF/g,'').trim().toLowerCase()] = (row[k] ?? "").toString().trim();
    });
    return o;
  }
  function parseMDY(s) { // e.g., 9/1/2025 8:41:12
    if (!s) return null;
    const [mdy, time] = s.split(' ');
    if (!mdy) return null;
    const [m,d,y] = mdy.split('/').map(n=>parseInt(n,10));
    let hh=0, mm=0, ss=0;
    if (time) { [hh,mm,ss] = time.split(':').map(n=>parseInt(n||'0',10)); }
    if (!y||!m||!d) return null;
    return new Date(y, m-1, d, hh||0, mm||0, ss||0);
  }
  function parseDateLoose(s) {
    if (!s) return null;
    if (s.includes('/')) return parseMDY(s);
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  function toYMD(dt) {
    if (!dt) return "";
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const d = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function mapRow(n) {
    const month = n["month"] || "";
    const dateStr = n["date"] || "";
    const employee = n["employee name"] || n["employee"] || "";

    const sinRaw = n["sign in time"] || "";
    const soutRaw = n["sign out time"] || "";
    const sin = parseDateLoose(sinRaw);
    const sout = parseDateLoose(soutRaw);

    let total = parseFloat(n["total hours"]);
    if (isNaN(total) && sin && sout) total = (sout - sin) / 36e5;

    let dateDT = null;
    if (dateStr) {
      // supports YYYY-MM-DD or other ISO-like formats
      const d = new Date(dateStr);
      if (!isNaN(d)) dateDT = d;
    }
    if (!dateDT && (sin || sout)) {
      const ref = sin || sout;
      dateDT = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate());
    }

    return {
      month,
      date: dateStr || (dateDT ? toYMD(dateDT) : ""),
      dateDT,
      employee,
      signIn: sinRaw,
      signOut: soutRaw,
      signInDT: sin,
      signOutDT: sout,
      totalHours: isNaN(total) ? 0 : total
    };
  }

  function computeStatus(r) {
    if (!(r.signInDT && r.signOutDT)) return ["Missing"];
    const signInM = r.signInDT.getHours()*60 + r.signInDT.getMinutes();
    const signOutM = r.signOutDT.getHours()*60 + r.signOutDT.getMinutes();
    const statuses = [];
    if (signInM > (8*60 + 15)) statuses.push("Late");
    if (signOutM < (16*60 + 30)) statuses.push("Early Leave");
    if (!statuses.length) statuses.push("On Time");
    return statuses;
  }

  // ---------- UI: SELECT2 + SLIDER ----------
  function initSelect2() {
    $("#employeeFilter").select2({
      placeholder: "Select employeesâ€¦",
      width: "100%",
      allowClear: true
    });
  }
  function populateEmployeeSelect() {
    const sel = document.getElementById("employeeFilter");
    sel.innerHTML = "";
    const names = [...new Set(ROWS.map(r => (r.employee || "").trim()).filter(Boolean))].sort();
    for (const name of names) {
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      sel.appendChild(opt);
    }
    // re-init select2 with new options
    $("#employeeFilter").off("change"); // avoid duplicate bindings
    initSelect2();
  }
  function initHourSlider() {
    const slider = document.getElementById("hourSlider");
    hourSlider = noUiSlider.create(slider, {
      start: [0, 12],
      connect: true,
      step: 0.25,
      range: { min: 0, max: 12 }
    });
    hourSlider.on("update", vals => {
      document.getElementById("hourMinLabel").textContent = parseFloat(vals[0]).toFixed(2);
      document.getElementById("hourMaxLabel").textContent = parseFloat(vals[1]).toFixed(2);
      // NOTE: we do NOT auto-apply; user clicks "Apply"
    });
  }

  // ---------- FILTERS ----------
  function getCriteria() {
    const [minH, maxH] = hourSlider ? hourSlider.get().map(parseFloat) : [0, 12];
    return {
      employees: $("#employeeFilter").val() || [],
      start: document.getElementById("startDate").value,
      end: document.getElementById("endDate").value,
      minH, maxH,
      q: document.getElementById("quickSearch").value.toLowerCase().trim()
    };
  }

  function applyFilters() {
    const c = getCriteria();
    const startDT = c.start ? new Date(c.start) : null;
    const endDT = c.end ? new Date(c.end + "T23:59:59") : null;

    const filtered = ROWS.filter(r => {
      if (c.employees.length && !c.employees.includes(r.employee)) return false;
      if (startDT && r.dateDT && r.dateDT < startDT) return false;
      if (endDT && r.dateDT && r.dateDT > endDT) return false;
      if (r.totalHours < c.minH || r.totalHours > c.maxH) return false;
      if (c.q) {
        const blob = `${r.employee} ${r.date} ${r.signIn} ${r.signOut}`.toLowerCase();
        if (!blob.includes(c.q)) return false;
      }
      return true;
    });

    renderAll(filtered);
  }

  function resetFilters() {
    $("#employeeFilter").val(null).trigger("change");
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    if (hourSlider) hourSlider.set([0, 12]);
    document.getElementById("quickSearch").value = "";
    applyFilters();
  }

  // ---------- RENDER ----------
  function renderAll(rows) {
    renderTable(rows);
    renderKPIsAndCharts(rows);
  }

  function renderTable(rows) {
    const tbody = document.querySelector("#attendanceTable tbody");
    tbody.innerHTML = "";

    let total = 0, days = new Set(), late = 0, early = 0;

    for (const r of rows) {
      const st = computeStatus(r);
      if (st.includes("Late")) late++;
      if (st.includes("Early Leave")) early++;
      total += (r.totalHours || 0);
      if (r.date) days.add(r.date);

      const badge = st.map(s =>
        `<span class="badge ${s==="Late"?"bg-danger":s==="Early Leave"?"bg-warning text-dark":s==="On Time"?"bg-success":"bg-secondary"}">${s}</span>`
      ).join(" ");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.month || ""}</td>
        <td>${r.date || ""}</td>
        <td>${r.employee || ""}</td>
        <td>${r.signIn || ""}</td>
        <td>${r.signOut || ""}</td>
        <td>${isFinite(r.totalHours)? r.totalHours.toFixed(2):""}</td>
        <td class="badge-space">${badge}</td>
      `;
      tbody.appendChild(tr);
    }

    // KPIs (partial here; charts do full compute)
    document.getElementById("totalHours").textContent = total.toFixed(2);
    document.getElementById("avgHours").textContent = days.size ? (total / days.size).toFixed(2) : "0";
    document.getElementById("daysCount").textContent = String(days.size);
    document.getElementById("lateCount").textContent = String(late);
    document.getElementById("earlyCount").textContent = String(early);

    if (DT) { DT.destroy(); DT = null; }
    DT = $("#attendanceTable").DataTable({
      dom: 'Bfrtip',
      buttons: ['copyHtml5','csvHtml5','excelHtml5','pdfHtml5','print'],
      pageLength: 10,
      order: [[1, 'asc']]
    });

    // Quick search drives DataTables only (does not change charts)
    document.getElementById("quickSearch").oninput = (e) => {
      DT.search(e.target.value).draw();
    };
  }

  function renderKPIsAndCharts(rows) {
    // Aggregate
    const byDate = {};
    const byEmp = {};
    let late = 0, early = 0;

    for (const r of rows) {
      const d = r.date || (r.dateDT ? toYMD(r.dateDT) : "");
      byDate[d] = (byDate[d] || 0) + (r.totalHours || 0);
      byEmp[r.employee || ""] = (byEmp[r.employee || ""] || 0) + (r.totalHours || 0);
      const st = computeStatus(r);
      if (st.includes("Late")) late++;
      if (st.includes("Early Leave")) early++;
    }

    // destroy if exist
    [barChart, pieChart, lineChart].forEach(c => { if (c) c.destroy(); });

    // Bar: per day
    const dLabels = Object.keys(byDate).filter(Boolean).sort();
    const dValues = dLabels.map(k => byDate[k]);
    barChart = new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: { labels: dLabels, datasets: [{ label: "Hours", data: dValues, backgroundColor: "#0d6efd" }] }
    });

    // Pie: per employee
    const eLabels = Object.keys(byEmp).filter(Boolean).sort();
    const eValues = eLabels.map(k => byEmp[k]);
    pieChart = new Chart(document.getElementById("pieChart"), {
      type: "pie",
      data: { labels: eLabels, datasets: [{ data: eValues }] }
    });

    // Line: trend
    lineChart = new Chart(document.getElementById("lineChart"), {
      type: "line",
      data: { labels: dLabels, datasets: [{ label: "Hours", data: dValues, fill: false, borderColor: "#28a745" }] }
    });
  }

  // ---------- REPORT ----------
  async function downloadReport() {
    const el = document.getElementById("reportArea");
    const canvas = await html2canvas(el, {
      scale: 2,
      backgroundColor: document.body.classList.contains("dark") ? "#12141a" : "#ffffff"
    });
    const imgData = canvas.toDataURL("image/png");
    const pdf = pdfMake.createPdf({
      content: [{ image: imgData, width: 520 }],
      pageMargins: [12,12,12,12],
      pageOrientation: "landscape"
    });
    pdf.download("Attendance_Report.pdf");
  }

  // ---------- LOAD ----------
  async function loadData() {
    try {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const data = parsed.data || [];
      ROWS = data.map(r => mapRow(normalizeHeaders(r)))
                 .filter(r => r.employee || r.date || r.signIn || r.signOut);
      populateEmployeeSelect();
      applyFilters();          // initial render with all data
    } catch (e) {
      console.error("CSV load failed", e);
      ROWS = [];
      populateEmployeeSelect();
      renderAll([]);
    }
  }

  // ---------- INIT ----------
  document.getElementById("applyBtn").addEventListener("click", applyFilters);
  document.getElementById("resetBtn").addEventListener("click", resetFilters);
  document.getElementById("refreshBtn").addEventListener("click", loadData);
  document.getElementById("reportBtn").addEventListener("click", downloadReport);

  initHourSlider();
  initSelect2(); // initial (empty) so styling is ready
  loadData();
  </script>
</body>
</html>
