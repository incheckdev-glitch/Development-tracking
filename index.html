<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS LIBS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

  <style>
    body.dark-mode { background: #181a1f; color: #eee; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .filter-bar { position: sticky; top: 0; z-index:10; background: inherit; padding:10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>

<body>
  <div class="container-fluid p-4" id="reportArea">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>📊 Attendance Dashboard</h2>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">🌙/☀️</button>
        <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="card shadow filter-bar mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-lg-3">
          <label class="form-label">Quick Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search..."/>
        </div>
        <div class="col-12 text-end mt-3">
          <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-4 text-center" id="kpiCards">
      <!-- Cards will be injected here -->
    </div>

    <!-- TABLE -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>

    <!-- HOLIDAY MANAGER -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <h5>📅 Holiday Manager</h5>
        <div class="input-group mb-3">
          <input type="date" id="holidayDate" class="form-control" />
          <input type="text" id="holidayName" class="form-control" placeholder="Holiday Name (optional)" />
          <button class="btn btn-primary" onclick="addHoliday()">Add</button>
        </div>
        <ul id="holidayList" class="list-group"></ul>
      </div>
    </div>
  </div>

  <!-- JS LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- APP SCRIPT -->
  <script>
    // Use your CSV link including the sheet ID
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?output=csv";

    let CANON = [];
    let DT = null;
    let barChartHandle = null, pieChartHandle = null, lineChartHandle = null;
    let customHolidays = JSON.parse(localStorage.getItem("holidays") || "[]");

    function toggleDark() {
      document.body.classList.toggle("dark-mode");
    }

    function normalizeDate(d) {
      if (!d) return "";
      const s = String(d).trim();
      if (s.includes("/")) {
        const parts = s.split("/");
        if (parts.length === 3) {
          const [p1, p2, p3] = parts;
          // assume dd/mm/yyyy
          return `${p3}-${String(p2).padStart(2, "0")}-${String(p1).padStart(2, "0")}`;
        }
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        return s;
      }
      return "";
    }

    function parsePunchWithDate(dateISO, value) {
      if (!value) return null;
      const s = String(value).trim();
      if (!s || s === "-" || s.toLowerCase() === "null") return null;
      if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) {
        const t = s.length === 5 ? s + ":00" : s;
        const dt = new Date(`${dateISO}T${t}`);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    function mapRow(r) {
      const dateISO = normalizeDate(r["date"] || "");
      const signInRaw = r["sign in"] || "";
      const signOutRaw = r["sign out"] || "";
      const signInDT = dateISO ? parsePunchWithDate(dateISO, signInRaw) : null;
      const signOutDT = dateISO ? parsePunchWithDate(dateISO, signOutRaw) : null;
      const totalHours = r["total hours"]
        ? parseFloat(r["total hours"])
        : (signInDT && signOutDT ? (signOutDT - signInDT) / 36e5 : 0);

      return {
        month: r["month"] || (dateISO ? dateISO.slice(0, 7) : ""),
        date: dateISO,
        employee: r["employee"] || "",
        signIn: signInRaw,
        signOut: signOutRaw,
        signInDT,
        signOutDT,
        totalHours
      };
    }

    function renderHolidayList() {
      const list = document.getElementById("holidayList");
      list.innerHTML = "";
      customHolidays.sort((a, b) => a.date.localeCompare(b.date));
      customHolidays.forEach((h, i) => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${h.date}${h.name ? " - " + h.name : ""}</span>
                        <button class="btn btn-sm btn-danger" onclick="removeHoliday(${i})">Remove</button>`;
        list.appendChild(li);
      });
      localStorage.setItem("holidays", JSON.stringify(customHolidays));
    }

    function addHoliday() {
      const date = document.getElementById("holidayDate").value;
      const name = document.getElementById("holidayName").value;
      if (!date) {
        alert("Please choose a date");
        return;
      }
      if (customHolidays.some((h) => h.date === date)) {
        alert("Holiday already exists");
        return;
      }
      customHolidays.push({ date, name });
      renderHolidayList();
      applyFilters();
    }

    function removeHoliday(idx) {
      customHolidays.splice(idx, 1);
      renderHolidayList();
      applyFilters();
    }

    function computeStatus(r) {
      if (r.status) return r.status;
      if (!r.signInDT && !r.signOutDT) return ["Absent"];
      if ((r.signInDT && !r.signOutDT) || (!r.signInDT && r.signOutDT)) return ["Needs Correction"];

      const status = [];
      // You can refine your rules further
      if (r.totalHours > 0 && r.totalHours < 4) status.push("Half-day");
      if (r.totalHours >= 9) status.push("Overtime");
      if (!status.length) status.push("On Time");
      return status;
    }

    function getCriteria() {
      return {
        employees: $("#employeeFilter").val() || [],
        start: document.getElementById("startDate").value,
        end: document.getElementById("endDate").value,
        q: (document.getElementById("quickSearch").value || "").toLowerCase()
      };
    }

    function applyFilters() {
      const c = getCriteria();
      const filtered = CANON.filter((r) => {
        if (c.employees.length && !c.employees.includes(r.employee)) return false;
        if (c.start && r.date < c.start) return false;
        if (c.end && r.date > c.end) return false;
        if (c.q && !`${r.employee} ${r.date}`.toLowerCase().includes(c.q)) return false;
        return true;
      });
      renderTable(filtered);
    }

    function resetFilters() {
      $("#employeeFilter").val(null).trigger("change");
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("quickSearch").value = "";
      applyFilters();
    }

    function renderTable(data) {
      const rows = data.map((r) => {
        const st = computeStatus(r);
        const badge = st
          .map((label) => {
            let cls = "bg-secondary";
            if (label === "On Time") cls = "bg-success";
            else if (label === "Absent") cls = "bg-dark";
            else if (label === "Half-day") cls = "bg-info text-dark";
            else if (label === "Overtime") cls = "bg-primary";
            else if (label === "Needs Correction") cls = "bg-danger text-white";
            return `<span class="badge ${cls}">${label}</span>`;
          })
          .join(" ");
        return [
          r.month || "",
          r.date || "",
          r.employee || "",
          r.signIn || "",
          r.signOut || "",
          isFinite(r.totalHours) ? r.totalHours.toFixed(2) : "",
          badge
        ];
      });

      if (!DT) {
        DT = $("#attendanceTable").DataTable({
          data: rows,
          columns: [
            { title: "Month" },
            { title: "Date" },
            { title: "Employee" },
            { title: "Sign In" },
            { title: "Sign Out" },
            { title: "Total Hours" },
            { title: "Status" }
          ],
          dom: "Bfrtip",
          buttons: ["csv", "excel", "pdf", "print", "colvis"],
          pageLength: 10,
          order: [[1, "asc"]],
          createdRow: (row, rowData) => {
            if (rowData[6].includes("Holiday")) $(row).addClass("holiday-row");
            if (rowData[6].includes("Weekend")) $(row).addClass("weekend-row");
          }
        });
      } else {
        DT.clear().rows.add(rows).draw();
      }

      // KPI logic
      let sum = 0, late = 0, early = 0, absent = 0, holidayCount = 0;
      const workingDays = new Set();

      data.forEach((r) => {
        // sum, late/early/absent
        const st = computeStatus(r);
        if (st.includes("Late")) late++;
        if (st.includes("Early Leave")) early++;
        if (st.includes("Absent")) absent++;
        if (r.totalHours) sum += r.totalHours;

        // working days & holiday count
        if (r.date) {
          const dow = new Date(`${r.date}T00:00:00`).getDay();
          const isWeekend = dow === 0 || dow === 6;
          const isHoliday = customHolidays.some((h) => h.date === r.date);
          if (isHoliday) {
            holidayCount++;
          }
          if (!isWeekend && !isHoliday) {
            workingDays.add(r.date);
          }
        }
      });

      // Build KPI cards
      const kpiHtml = `
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3>${sum.toFixed(2)}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3>${workingDays.size ? (sum / workingDays.size).toFixed(2) : "0.00"}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Working Days</h5><h3>${workingDays.size}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Holidays</h5><h3>${holidayCount}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3>${late}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3>${early}</h3></div></div></div>
        <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Absent</h5><h3>${absent}</h3></div></div></div>
      `;
      document.getElementById("kpiCards").innerHTML = kpiHtml;

      renderCharts(data);
    }

    function renderCharts(data) {
      if (barChartHandle) barChartHandle.destroy();
      if (pieChartHandle) pieChartHandle.destroy();
      if (lineChartHandle) lineChartHandle.destroy();

      const byDate = {}, byEmp = {};
      data.forEach((r) => {
        if (r.date) byDate[r.date] = (byDate[r.date] || 0) + (r.totalHours || 0);
        if (r.employee) byEmp[r.employee] = (byEmp[r.employee] || 0) + (r.totalHours || 0);
      });

      barChartHandle = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: Object.keys(byDate),
          datasets: [{ label: "Hours", data: Object.values(byDate), backgroundColor: "#0d6efd" }]
        }
      });

      pieChartHandle = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
          labels: Object.keys(byEmp),
          datasets: [{
            data: Object.values(byEmp),
            backgroundColor: ["#0d6efd","#00c9a7","#ff7e5f","#6f42c1","#ffc107","#20c997","#fd7e14"]
          }]
        }
      });

      lineChartHandle = new Chart(document.getElementById("lineChart"), {
        type: "line",
        data: {
          labels: Object.keys(byDate),
          datasets: [{ label: "Hours", data: Object.values(byDate), borderColor: "#28a745", fill: false }]
        }
      });
    }

    function populateEmployeeFilter() {
      const sel = document.getElementById("employeeFilter");
      sel.innerHTML = "";
      const employees = [...new Set(CANON.map((r) => r.employee).filter(Boolean))].sort();
      employees.forEach((emp) => {
        const opt = document.createElement("option");
        opt.value = emp;
        opt.textContent = emp;
        sel.appendChild(opt);
      });
      $("#employeeFilter").select2({
        placeholder: "Select employees...",
        allowClear: true,
        width: "100%"
      });
    }

    async function downloadFullReport() {
      const el = document.getElementById("reportArea");
      const canvas = await html2canvas(el, {
        scale: 2,
        backgroundColor: document.body.classList.contains("dark-mode") ? "#181a1f" : "#fff"
      });
      const img = canvas.toDataURL("image/png");
      pdfMake.createPdf({ content: [{ image: img, width: 500 }] }).download("Attendance_Report.pdf");
    }

    async function loadData() {
      renderHolidayList();
      const res = await fetch(CSV_URL);
      if (!res.ok) {
        alert("Error loading CSV: " + res.statusText);
        return;
      }
      const csv = await res.text();
      const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
      const baseRows = parsed.data.map((r) => mapRow(r)).filter((r) => r.employee && r.date);
      CANON = baseRows;
      populateEmployeeFilter();
      applyFilters();
    }

    // Kick off
    loadData();
  </script>
</body>
</html>
