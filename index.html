<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“Š Attendance & Leave Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body.dark-mode { background: #181a1f; color: #eee; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>
<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸ“Š Attendance & Leave Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">ğŸŒ™/â˜€ï¸</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="card shadow filter-bar mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-lg-3">
        <label class="form-label">Employee</label>
        <select id="employeeFilter" multiple></select>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control" />
      </div>
      <div class="col-lg-3">
        <label class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control" />
      </div>
      <div class="col-lg-3">
        <label class="form-label">Quick Search</label>
        <input type="text" id="quickSearch" class="form-control" placeholder="Search..." />
      </div>
      <div class="col-12 text-end mt-3">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Total Hours</h6><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Avg Hours</h6><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Workdays</h6><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Late</h6><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Early Leaves</h6><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Absent</h6><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- LEAVE + HOLIDAY KPI CARDS -->
  <div class="row mb-4 text-center">
    <div class="col-md-3"><div class="card shadow"><div class="card-body"><h6>Annual Leaves</h6><h3 id="annualCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card shadow"><div class="card-body"><h6>Sick Leaves</h6><h3 id="sickCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card shadow"><div class="card-body"><h6>Unpaid Leaves</h6><h3 id="unpaidCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card shadow"><div class="card-body"><h6>Holidays</h6><h3 id="holidayCount">0</h3></div></div></div>
  </div>

  <!-- TABLE -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="row">
    <div class="col-lg-4"><div class="card shadow p-3"><h6>Hours per Day</h6><canvas id="barChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h6>Hours by Employee</h6><canvas id="pieChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h6>Trend</h6><canvas id="lineChart"></canvas></div></div>
  </div>

  <!-- MANAGERS -->
  <div class="card shadow my-4"><div class="card-body">
    <h5>ğŸ“… Holiday Manager</h5>
    <input type="date" id="holidayDate" class="form-control mb-2" />
    <input type="text" id="holidayName" class="form-control mb-2" placeholder="Holiday name" />
    <button class="btn btn-primary mb-3" onclick="addHoliday()">â• Add Holiday</button>
    <ul id="holidayList" class="list-group"></ul>
  </div></div>

  <div class="card shadow my-4"><div class="card-body">
    <h5>ğŸ–ï¸ Leave Manager</h5>
    <input type="date" id="leaveDate" class="form-control mb-2" />
    <input type="text" id="leaveEmployee" class="form-control mb-2" placeholder="Employee name" />
    <select id="leaveType" class="form-control mb-2"><option>Annual Leave</option><option>Sick Leave</option><option>Unpaid Leave</option></select>
    <button class="btn btn-primary mb-3" onclick="addLeave()">â• Add Leave</button>
    <ul id="leaveList" class="list-group"></ul>
  </div></div>

  <div class="card shadow my-4"><div class="card-body">
    <h5>ğŸ’¼ Balances</h5>
    <input type="text" id="balEmployee" class="form-control mb-2" placeholder="Employee name" />
    <input type="number" id="balAnnual" class="form-control mb-2" placeholder="Annual" />
    <input type="number" id="balSick" class="form-control mb-2" placeholder="Sick" />
    <input type="number" id="balUnpaid" class="form-control mb-2" placeholder="Unpaid" />
    <button class="btn btn-primary mb-3" onclick="updateBalance()">ğŸ’¾ Update Balance</button>
    <ul id="balanceList" class="list-group"></ul>
  </div></div>
</div>

<!-- LIBS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- FRONTEND APP -->
<script>
const API_BASE   = "YOUR_DEPLOYED_SCRIPT_URL"; // replace with your WebApp URL
const API_SECRET = "a9fj32klsdfj0932LKJSDF90wef9";

let ATT=[], HOL=[], LEAVES=[], BAL=[]; let DT=null;

function toggleDark(){ document.body.classList.toggle("dark-mode"); }

async function fetchSheet(sheet){ const url=`${API_BASE}?secret=${API_SECRET}&sheet=${sheet}`; const res=await fetch(url); const j=await res.json(); return j.ok?j.data:[]; }
async function postSheet(sheet,action,payload){ const res=await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:API_SECRET,sheet,action,payload})}); return res.json(); }

function computeStatus(row){
  if(row.Type){ return [row.Type]; }
  if(HOL.some(h=>h.Date===row.Date)&&!row.SignIn&&!row.SignOut){ return ["Holiday"]; }
  const dow=new Date(row.Date).getDay();
  if((dow===0||dow===6)&&!row.SignIn&&!row.SignOut){ return ["Weekend"]; }
  if(!row.SignIn&&!row.SignOut)return["Absent"];
  let s=[]; const inDT=row.SignIn?new Date(row.SignIn):null; const outDT=row.SignOut?new Date(row.SignOut):null;
  if(inDT && (inDT.getHours()>8||(inDT.getHours()===8&&inDT.getMinutes()>15))) s.push("Late");
  if(outDT && (outDT.getHours()<16||(outDT.getHours()===16&&outDT.getMinutes()<30))) s.push("Early Leave");
  if(row.TotalHours<4&&row.TotalHours>0)s.push("Half-day");
  if(row.TotalHours>=9)s.push("Overtime");
  if(!s.length)s.push("On Time");
  return s;
}

function renderTable(data){
  const rows=data.map(r=>{
    const st=computeStatus(r);
    const badge=st.map(l=>`<span class="badge bg-secondary">${l}</span>`).join(" ");
    return [r.Month,r.Date,r.Employee,r.SignIn||"",r.SignOut||"",r.TotalHours||"",badge];
  });
  if(!DT){ DT=$("#attendanceTable").DataTable({data:rows,columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Hours"},{title:"Status"}],dom:"Bfrtip",buttons:["csv","excel","pdf","print"],pageLength:10}); }
  else { DT.clear().rows.add(rows).draw(); }
  updateKPIs(data); renderManagers();
}

function updateKPIs(data){
  let sum=0, days=0, late=0, early=0, absent=0, annual=0, sick=0, unpaid=0, hol=0;
  data.forEach(r=>{
    const st=computeStatus(r);
    if(st.includes("Late"))late++;
    if(st.includes("Early Leave"))early++;
    if(st.includes("Absent"))absent++;
    if(st.includes("Annual Leave"))annual++;
    if(st.includes("Sick Leave"))sick++;
    if(st.includes("Unpaid Leave"))unpaid++;
    if(st.includes("Holiday"))hol++;
    if(r.TotalHours>0){ sum+=r.TotalHours; days++; }
  });
  $("#totalHours").text(sum.toFixed(2));
  $("#avgHours").text(days? (sum/days).toFixed(2):0);
  $("#daysCount").text(days);
  $("#lateCount").text(late); $("#earlyCount").text(early); $("#absentCount").text(absent);
  $("#annualCount").text(annual); $("#sickCount").text(sick); $("#unpaidCount").text(unpaid); $("#holidayCount").text(hol);
}

function applyFilters(){ renderTable(ATT); }
function resetFilters(){ $("#employeeFilter").val(null).trigger("change"); $("#startDate").val("");$("#endDate").val("");$("#quickSearch").val("");renderTable(ATT); }

async function loadData(){
  ATT=await fetchSheet("AttendanceSummary"); HOL=await fetchSheet("Holidays"); LEAVES=await fetchSheet("Leaves"); BAL=await fetchSheet("Balances");
  const employees=[...new Set(ATT.map(r=>r.Employee))].sort();
  $("#employeeFilter").empty(); employees.forEach(e=>$("#employeeFilter").append(`<option value="${e}">${e}</option>`));
  $("#employeeFilter").select2({placeholder:"Select employees"});
  renderTable(ATT);
}

async function addHoliday(){ await postSheet("Holidays","add",{Date:$("#holidayDate").val(),Name:$("#holidayName").val()}); loadData(); }
async function addLeave(){
  const emp=$("#leaveEmployee").val(); const type=$("#leaveType").val();
  await postSheet("Leaves","add",{Date:$("#leaveDate").val(),Employee:emp,Type:type});
  // deduct balance automatically
  let bal=BAL.find(b=>b.Employee===emp);
  if(bal){ if(type==="Annual Leave" && bal.Annual>0) bal.Annual--; if(type==="Sick Leave" && bal.Sick>0) bal.Sick--; if(type==="Unpaid Leave" && bal.Unpaid>0) bal.Unpaid--; await postSheet("Balances","update",bal); }
  loadData();
}
async function updateBalance(){ await postSheet("Balances","update",{Employee:$("#balEmployee").val(),Annual:$("#balAnnual").val(),Sick:$("#balSick").val(),Unpaid:$("#balUnpaid").val()}); loadData(); }

function renderManagers(){
  $("#holidayList").empty(); HOL.forEach(h=>$("#holidayList").append(`<li class="list-group-item d-flex justify-content-between">${h.Date} - ${h.Name}<button class="btn btn-sm btn-danger" onclick="removeHoliday('${h.Date}')">âœ–</button></li>`));
  $("#leaveList").empty(); LEAVES.forEach(l=>$("#leaveList").append(`<li class="list-group-item d-flex justify-content-between">${l.Date} - ${l.Employee} (${l.Type})<button class="btn btn-sm btn-danger" onclick="removeLeave('${l.Date}','${l.Employee}','${l.Type}')">âœ–</button></li>`));
  $("#balanceList").empty(); BAL.forEach(b=>$("#balanceList").append(`<li class="list-group-item d-flex justify-content-between">${b.Employee}: A:${b.Annual} S:${b.Sick} U:${b.Unpaid}<button class="btn btn-sm btn-danger" onclick="removeBalance('${b.Employee}')">âœ–</button></li>`));
}

async function removeHoliday(date){ await postSheet("Holidays","remove",{Date:date}); loadData(); }
async function removeLeave(date,emp,type){ await postSheet("Leaves","remove",{Date:date,Employee:emp}); // restore balance
  let bal=BAL.find(b=>b.Employee===emp);
  if(bal){ if(type==="Annual Leave") bal.Annual++; if(type==="Sick Leave") bal.Sick++; if(type==="Unpaid Leave") bal.Unpaid++; await postSheet("Balances","update",bal); }
  loadData();
}
async function removeBalance(emp){ await postSheet("Balances","remove",{Employee:emp}); loadData(); }

async function downloadFullReport(){ const el=document.getElementById("reportArea"); const canvas=await html2canvas(el,{scale:2}); const img=canvas.toDataURL("image/png"); pdfMake.createPdf({content:[{image:img,width:500}]}).download("Report.pdf"); }

loadData();
</script>
</body>
</html>
