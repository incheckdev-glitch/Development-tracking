<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📊 Attendance & Leave Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .kpi-card { border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; background: white; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .kpi-value { font-size: 1.8rem; font-weight: bold; }
    .holiday-row { background:#f0f9ff!important; }
    .weekend-row { background:#f8d7da!important; }
  </style>
</head>
<body>
<div class="container-fluid py-3">
  <h2 class="mb-4">📊 Attendance & Leave Dashboard</h2>

  <!-- KPI Cards -->
  <div class="row text-center">
    <div class="col kpi-card"><div>Total Hours</div><div id="kpiTotalHours" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Avg Hours</div><div id="kpiAvgHours" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Workdays</div><div id="kpiWorkdays" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Late</div><div id="kpiLate" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Early</div><div id="kpiEarly" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Absent</div><div id="kpiAbsent" class="kpi-value">0</div></div>
  </div>

  <!-- Leave KPIs -->
  <div class="row text-center">
    <div class="col kpi-card"><div>Annual</div><div id="kpiAnnual" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Sick</div><div id="kpiSick" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Unpaid</div><div id="kpiUnpaid" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Holidays</div><div id="kpiHoliday" class="kpi-value">0</div></div>
  </div>

  <!-- Attendance -->
  <h4 class="mt-4">📅 Attendance Records</h4>
  <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%">
    <thead><tr><th>Month</th><th>Date</th><th>Employee</th><th>Sign In</th><th>Sign Out</th><th>Total Hours</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Holidays -->
  <h4 class="mt-4">🎉 Holidays</h4>
  <table id="tableHolidays" class="table table-bordered"><thead><tr><th>Date</th><th>Name</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Leaves -->
  <h4 class="mt-4">📝 Leaves</h4>
  <table id="tableLeaves" class="table table-bordered"><thead><tr><th>Date</th><th>Employee</th><th>Type</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Balances -->
  <h4 class="mt-4">📌 Leave Balances</h4>
  <table id="tableBalances" class="table table-bordered"><thead><tr><th>Employee</th><th>Annual</th><th>Sick</th><th>Unpaid</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Settings -->
  <h4 class="mt-4">⚙️ Settings</h4>
  <table id="tableSettings" class="table table-bordered"><thead><tr><th>Late After</th><th>Early Before</th><th>Half-day Max</th><th>Overtime Min</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Charts -->
  <h4 class="mt-4">📈 Analytics</h4>
  <div class="row">
    <div class="col-md-6"><canvas id="chartHours"></canvas></div>
    <div class="col-md-6"><canvas id="chartLeaves"></canvas></div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chunks 2-7 will follow -->
<script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📊 Attendance & Leave Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .kpi-card { border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; background: white; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .kpi-value { font-size: 1.8rem; font-weight: bold; }
    .holiday-row { background:#f0f9ff!important; }
    .weekend-row { background:#f8d7da!important; }
  </style>
</head>
<body>
<div class="container-fluid py-3">
  <h2 class="mb-4">📊 Attendance & Leave Dashboard</h2>

  <!-- KPI Cards -->
  <div class="row text-center">
    <div class="col kpi-card"><div>Total Hours</div><div id="kpiTotalHours" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Avg Hours</div><div id="kpiAvgHours" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Workdays</div><div id="kpiWorkdays" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Late</div><div id="kpiLate" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Early</div><div id="kpiEarly" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Absent</div><div id="kpiAbsent" class="kpi-value">0</div></div>
  </div>

  <!-- Leave KPIs -->
  <div class="row text-center">
    <div class="col kpi-card"><div>Annual</div><div id="kpiAnnual" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Sick</div><div id="kpiSick" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Unpaid</div><div id="kpiUnpaid" class="kpi-value">0</div></div>
    <div class="col kpi-card"><div>Holidays</div><div id="kpiHoliday" class="kpi-value">0</div></div>
  </div>

  <!-- Attendance -->
  <h4 class="mt-4">📅 Attendance Records</h4>
  <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%">
    <thead><tr><th>Month</th><th>Date</th><th>Employee</th><th>Sign In</th><th>Sign Out</th><th>Total Hours</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Holidays -->
  <h4 class="mt-4">🎉 Holidays</h4>
  <table id="tableHolidays" class="table table-bordered"><thead><tr><th>Date</th><th>Name</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Leaves -->
  <h4 class="mt-4">📝 Leaves</h4>
  <table id="tableLeaves" class="table table-bordered"><thead><tr><th>Date</th><th>Employee</th><th>Type</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Balances -->
  <h4 class="mt-4">📌 Leave Balances</h4>
  <table id="tableBalances" class="table table-bordered"><thead><tr><th>Employee</th><th>Annual</th><th>Sick</th><th>Unpaid</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Settings -->
  <h4 class="mt-4">⚙️ Settings</h4>
  <table id="tableSettings" class="table table-bordered"><thead><tr><th>Late After</th><th>Early Before</th><th>Half-day Max</th><th>Overtime Min</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <!-- Charts -->
  <h4 class="mt-4">📈 Analytics</h4>
  <div class="row">
    <div class="col-md-6"><canvas id="chartHours"></canvas></div>
    <div class="col-md-6"><canvas id="chartLeaves"></canvas></div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chunks 2-7 will follow -->
<script>
/* ----------------------------------------------------------
 * Chunk 2 – Config & Global Stores
 * ---------------------------------------------------------- */

// Your Apps Script Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycby4i9AoZgoPGKQ4eEwCzm40DPP5YtIFKXoPgVipCuR2t90e5aZpYb2WLJ5Pk3X4fARQ/exec";

// The same secret you put in Google Script
const API_SECRET = "a9fj32klsdfj0932LKJSDF90wef9";

// Global stores for all sheet data
let ATTENDANCE = [];   // from AttendanceSummary
let HOLIDAYS = [];     // from Holidays
let LEAVES = [];       // from Leaves
let BALANCES = [];     // from Balances
let SETTINGS = {};     // from Settings

// Canonical merged rows
let CANON = [];

/* Loading overlay */
function showLoading(flag) {
  let el = document.getElementById("loadingOverlay");
  if (!el) {
    el = document.createElement("div");
    el.id = "loadingOverlay";
    el.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:#0008;color:#fff;display:flex;align-items:center;justify-content:center;font-size:2em;z-index:9999;display:none;";
    el.innerText = "Loading...";
    document.body.appendChild(el);
  }
  el.style.display = flag ? "flex" : "none";
}
/* ----------------------------------------------------------
 * Chunk 3 – Fetch & Loaders
 * ---------------------------------------------------------- */

/* Wrapper for GET requests */
async function fetchSheet(sheet, extraParams = {}) {
  const params = new URLSearchParams({
    secret: API_SECRET,
    sheet,
    ...extraParams
  });
  const res = await fetch(`${API_URL}?${params.toString()}`);
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

/* Attendance loader (paginated) */
async function loadAttendance() {
  let start = 0;
  let limit = 500;
  let total = Infinity;
  let rows = [];

  while (start < total) {
    const { data, total: t } = await fetchSheet("AttendanceSummary", { start, limit });
    rows = rows.concat(data);
    total = t;
    start += limit;
  }
  ATTENDANCE = rows;
}

/* Other sheets loaders */
async function loadHolidays() {
  const { data } = await fetchSheet("Holidays");
  HOLIDAYS = data;
}
async function loadLeaves() {
  const { data } = await fetchSheet("Leaves");
  LEAVES = data;
}
async function loadBalances() {
  const { data } = await fetchSheet("Balances");
  BALANCES = data;
}
async function loadSettings() {
  const { data } = await fetchSheet("Settings");
  if (data && data.length) {
    SETTINGS = {
      lateAfter: data[0].LateAfter || "09:00",
      earlyBefore: data[0].EarlyBefore || "16:00",
      halfDayMax: parseFloat(data[0].HalfDayMax || 4),
      overtimeMin: parseFloat(data[0].OvertimeMin || 9)
    };
  }
}

/* Master loader */
async function loadAllData() {
  try {
    showLoading(true);

    await loadAttendance();
    await loadHolidays();
    await loadLeaves();
    await loadBalances();
    await loadSettings();

    console.log("Fetched data", { ATTENDANCE, HOLIDAYS, LEAVES, BALANCES, SETTINGS });

    processAndRender();

  } catch (err) {
    console.error("Load error", err);
    alert("Error loading data: " + err.message);
  } finally {
    showLoading(false);
  }
}

/* Bootstrap */
window.addEventListener("DOMContentLoaded", loadAllData);
/* ----------------------------------------------------------
 * Chunk 4 – Processing Attendance & Status Computation
 * ---------------------------------------------------------- */

/* UTIL: Build date range (inclusive) */
function buildDateRange(minDate, maxDate) {
  const out = [];
  let d = new Date(minDate);
  const end = new Date(maxDate);
  while (d <= end) {
    out.push(d.toISOString().slice(0, 10));
    d.setDate(d.getDate() + 1);
  }
  return out;
}

/* UTIL: Get unique employees */
function getEmployees() {
  return [...new Set(ATTENDANCE.map(r => r.Employee).filter(Boolean))].sort();
}

/* Expand attendance: fill gaps with holidays, weekends, leaves, absent */
function generateFullRows() {
  if (!ATTENDANCE.length) return [];

  const datesSorted = ATTENDANCE.map(r => r.Date).filter(Boolean).sort();
  const minDate = datesSorted[0];
  const maxDate = datesSorted[datesSorted.length - 1];
  const employees = getEmployees();
  const allDays = buildDateRange(minDate, maxDate);

  // Map existing rows
  const index = new Map();
  ATTENDANCE.forEach(r => index.set(`${r.Date}|${r.Employee}`, r));

  const full = [];

  allDays.forEach(day => {
    employees.forEach(emp => {
      const key = `${day}|${emp}`;
      if (index.has(key)) {
        full.push(Object.assign({}, index.get(key)));
      } else {
        const dow = new Date(day).getDay();
        if (HOLIDAYS.some(h => h.Date === day)) {
          full.push({ Date: day, Month: day.slice(0, 7), Employee: emp, SignIn: "", SignOut: "", TotalHours: 0, status: ["Holiday"] });
        } else if (LEAVES.some(l => l.Date === day && l.Employee === emp)) {
          const type = LEAVES.find(l => l.Date === day && l.Employee === emp).Type;
          full.push({ Date: day, Month: day.slice(0, 7), Employee: emp, SignIn: "", SignOut: "", TotalHours: 0, status: [type + " Leave"] });
        } else if (dow === 0 || dow === 6) {
          full.push({ Date: day, Month: day.slice(0, 7), Employee: emp, SignIn: "", SignOut: "", TotalHours: 0, status: ["Weekend"] });
        } else {
          full.push({ Date: day, Month: day.slice(0, 7), Employee: emp, SignIn: "", SignOut: "", TotalHours: 0, status: ["Absent"] });
        }
      }
    });
  });

  return full;
}

/* Compute status for a row */
function computeStatus(row) {
  if (row.status) return row.status; // already pre-assigned

  const lateT = SETTINGS.lateAfter.split(":").map(Number);
  const earlyT = SETTINGS.earlyBefore.split(":").map(Number);
  const half = SETTINGS.halfDayMax;
  const over = SETTINGS.overtimeMin;

  let status = [];
  let inTime = row.SignIn ? new Date(row.SignIn) : null;
  let outTime = row.SignOut ? new Date(row.SignOut) : null;

  if (!inTime && !outTime) return ["Absent"];
  if ((inTime && !outTime) || (!inTime && outTime)) return ["Needs Correction"];

  const inMin = inTime.getHours() * 60 + inTime.getMinutes();
  const outMin = outTime.getHours() * 60 + outTime.getMinutes();

  if (inMin > (lateT[0] * 60 + lateT[1])) status.push("Late");
  if (outMin < (earlyT[0] * 60 + earlyT[1])) status.push("Early Leave");
  if (row.TotalHours > 0 && row.TotalHours < half) status.push("Half-day");
  if (row.TotalHours >= over) status.push("Overtime");

  if (!status.length) status.push("On Time");
  return status;
}

/* PROCESS + Render pipeline */
function processAndRender() {
  CANON = generateFullRows();
  CANON.forEach(r => r.status = computeStatus(r));
  renderTableAndKPIs(CANON);
}
/* ----------------------------------------------------------
 * Chunk 6 – Managers (Holidays, Leaves, Balances, Settings)
 * ---------------------------------------------------------- */

/* API POST Helper */
async function postToAPI(sheet, action, payload) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ secret: API_SECRET, sheet, action, payload })
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "API error");
  return json;
}

/* ---------------- HOLIDAYS ---------------- */
async function addHoliday(date, name) {
  await postToAPI("Holidays", "add", { Date: date, Name: name });
  await loadHolidays();
  processAndRender();
}
async function removeHoliday(date) {
  await postToAPI("Holidays", "remove", { Date: date });
  await loadHolidays();
  processAndRender();
}
function renderHolidaysManager() {
  const tbody = document.querySelector("#tableHolidays tbody");
  tbody.innerHTML = "";
  HOLIDAYS.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.Date}</td>
      <td>${h.Name}</td>
      <td><button class="btn btn-sm btn-danger">Remove</button></td>
    `;
    tr.querySelector("button").onclick = () => removeHoliday(h.Date);
    tbody.appendChild(tr);
  });
}

/* ---------------- LEAVES ---------------- */
async function addLeave(date, employee, type) {
  await postToAPI("Leaves", "add", { Date: date, Employee: employee, Type: type });
  await loadLeaves();
  processAndRender();
}
async function removeLeave(date, employee) {
  await postToAPI("Leaves", "remove", { Date: date, Employee: employee });
  await loadLeaves();
  processAndRender();
}
function renderLeavesManager() {
  const tbody = document.querySelector("#tableLeaves tbody");
  tbody.innerHTML = "";
  LEAVES.forEach(l => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.Date}</td>
      <td>${l.Employee}</td>
      <td>${l.Type}</td>
      <td><button class="btn btn-sm btn-danger">Remove</button></td>
    `;
    tr.querySelector("button").onclick = () => removeLeave(l.Date, l.Employee);
    tbody.appendChild(tr);
  });
}

/* ---------------- BALANCES ---------------- */
async function updateBalance(employee, annual, sick, unpaid) {
  await postToAPI("Balances", "update", {
    Employee: employee,
    Annual: parseInt(annual, 10),
    Sick: parseInt(sick, 10),
    Unpaid: parseInt(unpaid, 10)
  });
  await loadBalances();
  processAndRender();
}
async function removeBalance(employee) {
  await postToAPI("Balances", "remove", { Employee: employee });
  await loadBalances();
  processAndRender();
}
function renderBalancesManager() {
  const tbody = document.querySelector("#tableBalances tbody");
  tbody.innerHTML = "";
  BALANCES.forEach(b => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.Employee}</td>
      <td><input type="number" value="${b.Annual}" style="width:70px"></td>
      <td><input type="number" value="${b.Sick}" style="width:70px"></td>
      <td><input type="number" value="${b.Unpaid}" style="width:70px"></td>
      <td>
        <button class="btn btn-sm btn-success">Save</button>
        <button class="btn btn-sm btn-danger">Remove</button>
      </td>
    `;
    const [annual, sick, unpaid] = tr.querySelectorAll("input");
    tr.querySelector(".btn-success").onclick = () =>
      updateBalance(b.Employee, annual.value, sick.value, unpaid.value);
    tr.querySelector(".btn-danger").onclick = () =>
      removeBalance(b.Employee);
    tbody.appendChild(tr);
  });
}

/* ---------------- SETTINGS ---------------- */
async function updateSettings(lateAfter, earlyBefore, halfDayMax, overtimeMin) {
  await postToAPI("Settings", "update", {
    LateAfter: lateAfter,
    EarlyBefore: earlyBefore,
    HalfDayMax: parseFloat(halfDayMax),
    OvertimeMin: parseFloat(overtimeMin)
  });
  await loadSettings();
  processAndRender();
}
function renderSettingsManager() {
  const tbody = document.querySelector("#tableSettings tbody");
  tbody.innerHTML = "";
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="time" value="${SETTINGS.lateAfter}"></td>
    <td><input type="time" value="${SETTINGS.earlyBefore}"></td>
    <td><input type="number" value="${SETTINGS.halfDayMax}" style="width:70px"></td>
    <td><input type="number" value="${SETTINGS.overtimeMin}" style="width:70px"></td>
    <td><button class="btn btn-sm btn-success">Save</button></td>
  `;
  const [lateAfter, earlyBefore, halfDayMax, overtimeMin] = tr.querySelectorAll("input");
  tr.querySelector("button").onclick = () =>
    updateSettings(lateAfter.value, earlyBefore.value, halfDayMax.value, overtimeMin.value);
  tbody.appendChild(tr);
}

/* ---------------- REFRESH HOOK ---------------- */
function refreshManagers() {
  renderHolidaysManager();
  renderLeavesManager();
  renderBalancesManager();
  renderSettingsManager();
}
/* ----------------------------------------------------------
 * Chunk 7 – Filters, Apply & Integration
 * ---------------------------------------------------------- */

/* Reset filters */
function resetFilters() {
  document.getElementById("filterEmployee").value = "";
  document.getElementById("filterStart").value = "";
  document.getElementById("filterEnd").value = "";
  document.getElementById("filterSearch").value = "";
  processAndRender();
}

/* Apply filters */
function applyFilters(data) {
  let start = document.getElementById("filterStart").value;
  let end = document.getElementById("filterEnd").value;
  let emp = document.getElementById("filterEmployee").value;
  let search = document.getElementById("filterSearch").value.toLowerCase();

  return data.filter(r => {
    if (start && r.Date < start) return false;
    if (end && r.Date > end) return false;
    if (emp && r.Employee !== emp) return false;

    if (search) {
      let str = [
        r.Date,
        r.Employee,
        r.SignIn,
        r.SignOut,
        r.TotalHours,
        (r.status || []).join(" ")
      ].join(" ").toLowerCase();
      if (!str.includes(search)) return false;
    }
    return true;
  });
}

/* Process and Render with filters */
function processAndRender() {
  // Expand rows with absent/holiday/leave/weekend fill
  CANON = generateFullRows();

  // Compute status for each row
  CANON.forEach(r => r.status = computeStatus(r));

  // Apply filters
  const filtered = applyFilters(CANON);

  // Render
  renderTableAndKPIs(filtered);

  // Refresh managers for Holidays, Leaves, Balances, Settings
  refreshManagers();

  // Populate employee filter dropdown dynamically
  populateEmployeeFilter();
}

/* Populate Employee Filter */
function populateEmployeeFilter() {
  const sel = document.getElementById("filterEmployee");
  const old = sel.value;
  sel.innerHTML = `<option value="">All Employees</option>`;
  getEmployees().forEach(emp => {
    const opt = document.createElement("option");
    opt.value = emp;
    opt.textContent = emp;
    if (emp === old) opt.selected = true;
    sel.appendChild(opt);
  });
}
