<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body.dark-mode { background:#181a1f; color:#eee; }
    .card { transition:all 0.3s ease; }
    .card:hover { transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,0.1); }
    .filter-bar { position:sticky; top:0; z-index:10; background:inherit; padding:10px; }
    .holiday-row { background:#ffeeba!important; }
    .weekend-row { background:#f0f0f0!important; }
  </style>
</head>
<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä Attendance Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">üåô/‚òÄÔ∏è</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      <button class="btn btn-primary" onclick="saveToServer()">üíæ Save</button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Days</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Late</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Early</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- Leave & Holiday Summary -->
  <div class="row mb-4 text-center">
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Annual Leave</h5><h3 id="alCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Sick Leave</h5><h3 id="slCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Unpaid Leave</h5><h3 id="ulCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Holidays</h5><h3 id="holidayCount">0</h3></div></div></div>
  </div>

  <!-- Table -->
  <div class="card mb-4"><div class="card-body">
    <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
  </div></div>

  <!-- Balances -->
  <div class="card mb-4"><div class="card-body">
    <h5>Employee Balances</h5>
    <table class="table table-bordered" id="balanceTable">
      <thead><tr><th>Employee</th><th>AL</th><th>SL</th></tr></thead>
      <tbody></tbody>
    </table>
  </div></div>
</div>

<script>
const CSV_SUMMARY="https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
const API_URL="https://script.google.com/macros/s/AKfycbwJQUkt5YlHZZk5fwKBU-p3ltTgkPpyj_KpSKayGX6Aqqp-wjO54dKi8RlNrzGCMwIw1A/exec";
const API_TOKEN="a9fj32klsdfj0932LKJSDF90wef9";

let CANON=[], table, HOLIDAYS=[], LEAVES=[], BALANCES=[];

// Helpers
function normalizeDate(d){if(!d) return "";const s=String(d).trim();if(s.includes("/")){const [m,dd,y]=s.split("/");return `${y}-${m.padStart(2,"0")}-${dd.padStart(2,"0")}`;}return s;}
function parseTime(dateStr,timeStr){if(!dateStr||!timeStr) return null;return new Date(`${dateStr}T${timeStr}`);}
function toggleDark(){document.body.classList.toggle("dark-mode");}
function computeStatus(r){
  const status=[];
  if(LEAVES.some(l=>l.date===r.date && l.employee===r.employee)){const t=LEAVES.find(l=>l.date===r.date&&l.employee===r.employee).type;status.push(t);return status;}
  if(!r.signIn && !r.signOut) status.push("Absent");
  return status.length?status:["On Time"];
}

// Load Data
async function loadData(){
  // 1) Attendance
  const res=await fetch(CSV_SUMMARY);const raw=Papa.parse(await res.text(),{header:true}).data;
  CANON = raw.map(row=>{
    const r={};for(const k in row){if(!k) continue;r[k.trim()]=row[k];}
    const d=normalizeDate(r["Date"]);
    return {
      month:r["Month"]||"",date:d,employee:r["Employee Name"]||"",
      signIn:r["Sign In Time"]||"",signOut:r["Sign Out Time"]||"",
      signInDT:parseTime(d,r["Sign In Time"]),signOutDT:parseTime(d,r["Sign Out Time"]),
      totalHours:parseFloat(r["Total Hours"]||0)
    };
  }).filter(r=>r.employee && r.date);

  // 2) Holidays / Leaves / Balances
  const apiRes=await fetch(`${API_URL}?token=${API_TOKEN}`);
  const j=await apiRes.json();
  if(j.ok){HOLIDAYS=j.holidays;LEAVES=j.leaves;BALANCES=j.balances;}else{console.warn("API error",j);}

  renderTable(CANON);
  renderBalances();
}

// Render Attendance Table
function renderTable(data){
  if(table){table.destroy();document.getElementById("attendanceTable").innerHTML="";}
  const rows=data.map(r=>{
    const st=computeStatus(r);
    return [r.month,r.date,r.employee,r.signIn,r.signOut,(r.totalHours?r.totalHours.toFixed(2):"0.00"),st.join(",")];
  });
  table=$("#attendanceTable").DataTable({
    data:rows,
    columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Hours"},{title:"Status"}],
    dom:"Bfrtip",buttons:["copy","csv","excel","print"],scrollX:true,
    createdRow:(row,rowData)=>{if(rowData[6].includes("Holiday")) $(row).addClass("holiday-row");}
  });

  // KPIs
  let total=0,days=0,late=0,early=0,abs=0,al=0,sl=0,ul=0;
  data.forEach(r=>{
    const st=computeStatus(r);
    if(st.includes("Absent")) abs++;
    if(st.includes("Annual Leave")) al++;
    if(st.includes("Sick Leave")) sl++;
    if(st.includes("Unpaid Leave")) ul++;
    if(!st.includes("Absent")&&!st.includes("Annual Leave")&&!st.includes("Sick Leave")&&!st.includes("Unpaid Leave")){
      total+=r.totalHours||0;days++;
    }
  });
  document.getElementById("totalHours").textContent=total.toFixed(1);
  document.getElementById("daysCount").textContent=days;
  document.getElementById("avgHours").textContent=days?(total/days).toFixed(1):0;
  document.getElementById("absentCount").textContent=abs;
  document.getElementById("alCount").textContent=al;
  document.getElementById("slCount").textContent=sl;
  document.getElementById("ulCount").textContent=ul;
  document.getElementById("holidayCount").textContent=HOLIDAYS.length;
}

// Render Balances
function renderBalances(){
  const tb=document.querySelector("#balanceTable tbody");tb.innerHTML="";
  BALANCES.forEach(b=>{
    tb.innerHTML+=`<tr><td>${b.employee}</td><td>${b.al}</td><td>${b.sl}</td></tr>`;
  });
}

// PDF
async function downloadFullReport(){
  const el=document.getElementById("reportArea");
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");
}

// Save
async function saveToServer(){
  const body={holidays:HOLIDAYS,leaves:LEAVES,balances:BALANCES,settings:[]};
  const res=await fetch(`${API_URL}?token=${API_TOKEN}`,{method:"POST",body:JSON.stringify(body)});
  alert("Saved: "+await res.text());
}

// Start
loadData();
</script>
</body>
</html>
