<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .sidebar { min-height: 100vh; background: #343a40; color: white; padding: 20px; }
    .sidebar h4 { color: #ffc107; }
    .card { border-radius: 15px; }
    .filter-bar { margin-bottom: 20px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <h4>Dashboard</h4>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link text-white" href="#summary">Summary</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#charts">Charts</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#table">Attendance Table</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4">Employee Attendance (AttendanceSummary)</h2>

      <!-- Filter Bar -->
      <div class="card shadow p-3 mb-4 filter-bar">
        <div class="row g-3 align-items-center">
          <div class="col-md-3">
            <label class="form-label">Filter by Employee</label>
            <select id="employeeFilter" class="form-select">
              <option value="">All Employees</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-3">
            <button class="btn btn-secondary w-100" onclick="resetFilters()">Reset</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="loadData()">ðŸ”„ Refresh Data</button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div id="summary" class="row mb-4">
        <div class="col-md-4"><div class="card shadow p-3"><h5>Total Hours</h5><h3 id="totalHours">Loading...</h3></div></div>
        <div class="col-md-4"><div class="card shadow p-3"><h5>Average Hours/Day</h5><h3 id="avgHours">Loading...</h3></div></div>
        <div class="col-md-4"><div class="card shadow p-3"><h5>Attendance Days</h5><h3 id="daysCount">Loading...</h3></div></div>
      </div>

      <!-- Charts -->
      <div id="charts" class="row mb-4">
        <div class="col-md-6"><div class="card shadow p-3"><h5>Hours Worked per Day</h5><canvas id="barChart"></canvas></div></div>
        <div class="col-md-6"><div class="card shadow p-3"><h5>Total Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
        <div class="col-md-12 mt-4"><div class="card shadow p-3"><h5>Trend: Total Hours Over Time</h5><canvas id="lineChart"></canvas></div></div>
      </div>

      <!-- Table -->
      <div id="table" class="card shadow p-3">
        <h5>Attendance Log</h5>
        <table id="attendanceTable" class="table table-striped" style="width:100%">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";

let allData = [];
let dataTable = null;
let barChart, pieChart, lineChart;

function loadData() {
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      allData = results.data;
      console.log("Loaded", allData.length, "rows");
      populateFilters();
      renderDashboard(allData);
    }
  });
}

function populateFilters() {
  const employeeSet = new Set(allData.map(r => r["Employee Name"] || r["Employee Name "] || "").filter(Boolean));
  const select = document.getElementById("employeeFilter");
  select.innerHTML = '<option value="">All Employees</option>';
  employeeSet.forEach(emp => select.insertAdjacentHTML("beforeend", `<option value="${emp}">${emp}</option>`));
}

function applyFilters() {
  const empFilter = document.getElementById("employeeFilter").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  let filtered = allData.filter(r => {
    let ok = true;
    if (empFilter && (r["Employee Name"] || r["Employee Name "]) !== empFilter) ok = false;
    if (start && new Date(r["Date"]) < new Date(start)) ok = false;
    if (end && new Date(r["Date"]) > new Date(end)) ok = false;
    return ok;
  });

  renderDashboard(filtered);
}

function resetFilters() {
  document.getElementById("employeeFilter").value = "";
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  renderDashboard(allData);
}

function renderDashboard(data) {
  // Summary + Charts prep
  const tableBody = document.querySelector("#attendanceTable tbody");
  const headerRow = document.getElementById("headerRow");
  tableBody.innerHTML = ""; headerRow.innerHTML = "";

  if (!data.length) { tableBody.innerHTML = "<tr><td colspan='6'>No data</td></tr>"; return; }

  const keys = Object.keys(data[0]);
  keys.forEach(k => headerRow.insertAdjacentHTML("beforeend", `<th>${k}</th>`));

  let totalHours = 0, countHours = 0;
  const dailyTotals = {}, empTotals = {};

  data.forEach(row => {
    const hours = parseFloat(row["Total Hours"] || 0) || 0;
    if(hours > 0){ totalHours += hours; countHours++; }

    if(row["Date"]) dailyTotals[row["Date"]] = (dailyTotals[row["Date"]] || 0) + hours;
    if(row["Employee Name"] || row["Employee Name "]) {
      let emp = row["Employee Name"] || row["Employee Name "];
      empTotals[emp] = (empTotals[emp] || 0) + hours;
    }

    const tr = `<tr>${keys.map(k => `<td>${row[k] || ""}</td>`).join("")}</tr>`;
    tableBody.insertAdjacentHTML("beforeend", tr);
  });

  // KPIs
  const daysCount = Object.keys(dailyTotals).length;
  const avgHours = countHours > 0 ? (totalHours / countHours).toFixed(2) : 0;
  document.getElementById("totalHours").textContent = totalHours.toFixed(2);
  document.getElementById("avgHours").textContent = avgHours;
  document.getElementById("daysCount").textContent = daysCount;

  // Destroy old charts if exist
  [barChart, pieChart, lineChart].forEach(ch => { if(ch) ch.destroy(); });

  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: { labels: Object.keys(dailyTotals), datasets: [{ label: "Total Hours", data: Object.values(dailyTotals), backgroundColor:"#007bff" }] }
  });

  pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: { labels: Object.keys(empTotals), datasets: [{ data: Object.values(empTotals), backgroundColor:["#007bff","#28a745","#ffc107","#dc3545","#6f42c1"] }] }
  });

  lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: { labels: Object.keys(dailyTotals), datasets: [{ label: "Hours", data: Object.values(dailyTotals), fill:false, borderColor:"#007bff" }] }
  });

  // DataTable refresh
  if (dataTable) { dataTable.destroy(); }
  dataTable = $('#attendanceTable').DataTable({
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
    pageLength: 10
  });
}

// Load on start
loadData();
</script>
</body>
</html>
