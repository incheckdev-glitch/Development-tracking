<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* Theme & layout (dark/light) */
    :root {
      --priority-high:#ef4444; --priority-medium:#f59e0b; --priority-low:#10b981;
      --status-resolved:#10b981; --status-underdev:#3b82f6; --status-rejected:#ef4444;
      --status-onhold:#f59e0b; --status-notstarted:#6b7280;
      --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --border:#1e2643; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff; --card:#ffffff; --muted:#5a678c; --text:#0d1326;
      --accent:#2563eb; --border:#e7eaf6; --shadow:0 10px 24px rgba(16,24,40,.08);
    }
    body { margin:0; font-family:Inter,system-ui; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; gap:12px; padding:10px 16px;
      background:var(--card); border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
    .brand { font-weight:700; display:flex; gap:8px; align-items:center; }
    .logo { width:28px; height:28px; border-radius:8px; background:var(--accent); display:grid; place-items:center; color:#fff; font-weight:800; }
    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; }
    .btn, .select, .input { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:inherit; font:inherit; }
    .btn { cursor:pointer; font-weight:600; }
    .btn.primary { background:var(--accent); border:none; color:#fff; }
    .wrap { padding:18px; max-width:1400px; margin:auto; display:grid; gap:18px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow); }

    .grid { display:grid; gap:16px; }
    .cols-4 { grid-template-columns:repeat(4,1fr); }
    @media(max-width:900px){ .cols-4{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:600px){ .cols-4{ grid-template-columns:1fr } }

    .kpi { text-align:center; cursor:pointer; }
    .kpi .label{ font-size:12px; color:var(--muted); text-transform:uppercase; }
    .kpi .value{ font-size:26px; font-weight:800; }
    .kpi .sub{ font-size:12px; color:var(--muted); }

    .charts{ display:grid; grid-template-columns:repeat(2,1fr); gap:16px }
    @media(max-width:900px){ .charts{ grid-template-columns:1fr } }

    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ text-align:left; padding:12px 10px; background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; }
    tbody td{ padding:10px; border-bottom:1px solid var(--border); }
    tr:hover{ background:rgba(255,255,255,.05) }
    .table-wrap{ max-height:460px; overflow:auto; border:1px solid var(--border); border-radius:10px; }

    .dropdown{ position:relative; }
    .dropdown-content{ display:none; position:absolute; right:0; background:var(--card); border:1px solid var(--border); padding:10px; border-radius:8px; box-shadow:var(--shadow); }
    .dropdown:hover .dropdown-content{ display:block; }
    .dropdown-content label{ display:flex; gap:6px; font-size:13px; margin:4px 0; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">IC</div> InCheck Issues</div>
    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search‚Ä¶" />
      <select id="themeSelect" class="select"><option value="system">System</option><option value="dark">Dark</option><option value="light">Light</option></select>
      <button id="refreshNow" class="btn">üîÑ Refresh</button>
      <button id="createTicketBtn" class="btn primary">‚ûï Create Ticket</button>
      <div class="dropdown">
        <button class="btn">üëÅ Columns</button>
        <div class="dropdown-content" id="columnToggles">
          <label><input type="checkbox" value="desc"> Description</label>
          <label><input type="checkbox" value="location"> Issue Location</label>
          <label><input type="checkbox" value="file"> Media URL Reference</label>
          <label><input type="checkbox" value="type"> Type</label>
          <label><input type="checkbox" value="related"> Issue Related</label>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid cols-4" id="kpis"></div>
    <div class="charts">
      <div class="card"><canvas id="byModule"></canvas></div>
      <div class="card"><canvas id="byPriority"></canvas></div>
      <div class="card"><canvas id="byStatus"></canvas></div>
      <div class="card"><canvas id="byType"></canvas></div>
    </div>
    <div class="card">
      <strong>Issues</strong> <span id="rowCount" class="muted"></span>
      <div class="table-wrap">
        <table id="issuesTable">
          <thead><tr id="tableHead"></tr></thead>
          <tbody><tr><td>Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_zyuaejPwZomAhzvaDOUwajunj7jYsAeWR4_yFQsYtubfaFCa6tWKeqP7hklvSRDM97BOyoPWTVSh/pub?output=csv";

  const els = {
    tableHead: document.querySelector('#tableHead'),
    tableBody: document.querySelector('#issuesTable tbody'),
    rowCount: document.querySelector('#rowCount'),
    columnToggles: document.querySelector('#columnToggles'),
    kpis: document.querySelector('#kpis'),
    charts: {}
  };

  let rows = [], filtered = [];
  let visibleOptional = new Set();

  function normalizeRow(raw){
    const lower={}; for(const k in raw){ if(!k) continue; lower[k.toLowerCase().trim()] = String(raw[k] ?? '').trim(); }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('incheck id'),
      ref: pick('youtrack reference'),
      module: pick('module'),
      title: pick('title'),
      desc: pick('description'),
      location: pick('issue location'),
      file: pick('media url reference'),
      type: pick('type'),
      priority: pick('priority'),
      related: pick('issue related'),
      status: pick('task status')
    };
  }

  function renderTable(){
    els.tableHead.innerHTML = `
      <th>ID</th><th>Youtrack Ref</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th>
      ${visibleOptional.has('desc')?'<th>Description</th>':''}
      ${visibleOptional.has('location')?'<th>Location</th>':''}
      ${visibleOptional.has('file')?'<th>Media URL</th>':''}
      ${visibleOptional.has('type')?'<th>Type</th>':''}
      ${visibleOptional.has('related')?'<th>Related</th>':''}
    `;
    els.tableBody.innerHTML = filtered.map(r=>`
      <tr>
        <td>${r.id||'-'}</td>
        <td>${r.ref||'-'}</td>
        <td>${r.module||'-'}</td>
        <td>${r.title||'-'}</td>
        <td>${r.priority||'-'}</td>
        <td>${r.status||'-'}</td>
        ${visibleOptional.has('desc')?`<td>${r.desc||'-'}</td>`:''}
        ${visibleOptional.has('location')?`<td>${r.location||'-'}</td>`:''}
        ${visibleOptional.has('file')?`<td>${r.file?`<a href="${r.file}" target="_blank">Link</a>`:'-'}</td>`:''}
        ${visibleOptional.has('type')?`<td>${r.type||'-'}</td>`:''}
        ${visibleOptional.has('related')?`<td>${r.related||'-'}</td>`:''}
      </tr>
    `).join('');
    els.rowCount.textContent = `${filtered.length} rows`;
  }

  function renderKpis(){
    const total=filtered.length; const counts={};
    filtered.forEach(r=>{ counts[r.status]=(counts[r.status]||0)+1; });
    els.kpis.innerHTML='';
    const add=(label,val)=>{
      const pct = total ? Math.round((val*100)/total) : 0;
      const d=document.createElement('div');
      d.className='card kpi';
      d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div><div class="sub">${pct}%</div>`;
      d.onclick=()=>{ applyFilters({status:label}); };
      els.kpis.appendChild(d);
    };
    add('Total Issues', total);
    Object.entries(counts).forEach(([s,v])=> add(s,v));
  }

  function drawCharts(){
    const ctx=(id)=>document.getElementById(id);
    const group=(key)=>filtered.reduce((a,r)=>{a[r[key]||'Unspecified']=(a[r[key]||'Unspecified']||0)+1;return a;},{});
    const make=(id,type,data)=>{ if(els.charts[id]) els.charts[id].destroy();
      els.charts[id]=new Chart(ctx(id),{type,data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]},
        options:{responsive:true,plugins:{legend:{display:type!=='bar'}}}}); };
    make('byModule','bar',group('module'));
    make('byPriority','doughnut',group('priority'));
    make('byStatus','bar',group('status'));
    make('byType','bar',group('type'));
  }

  function applyFilters(extra={}){
    const q=document.getElementById('searchInput').value.toLowerCase();
    filtered=rows.filter(r=>{
      const hay=[r.id,r.ref,r.module,r.title,r.desc,r.status,r.priority].join(' ').toLowerCase();
      return (!q || hay.includes(q)) && (!extra.status || r.status===extra.status);
    });
    renderTable(); renderKpis(); drawCharts();
  }

  async function loadSheet(){
    const res=await fetch(SHEET_URL); const text=await res.text();
    rows=Papa.parse(text,{header:true,skipEmptyLines:true}).data.map(normalizeRow);
    filtered=[...rows];
    renderTable(); renderKpis(); drawCharts();
  }

  els.columnToggles.addEventListener('change', e=>{
    if(e.target.checked) visibleOptional.add(e.target.value); else visibleOptional.delete(e.target.value);
    renderTable();
  });
  document.getElementById('searchInput').addEventListener('input',()=>applyFilters());

  loadSheet();
});
</script>
</body>
</html>
