<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ========== CSS LIBS ========== -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- ========== JS LIBS ========== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ========== PAGE STYLE ========== -->
  <style>
    body.dark-mode { background:#181a1f; color:#eee; }
    .card { transition:all 0.3s ease; }
    .card:hover { transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,0.1); }
    .filter-bar { position:sticky; top:0; z-index:10; background:inherit; padding:10px; }
    .holiday-row { background-color:#ffeeba !important; }
    .weekend-row { background-color:#f0f0f0 !important; }
  </style>
</head>
<body>
<div class="container-fluid p-4" id="reportArea">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📊 Attendance Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">🌙/☀️</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      <button class="btn btn-primary" onclick="saveToServer()">💾 Save</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow filter-bar mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-lg-3"><label class="form-label">Employee</label><select id="employeeFilter" multiple></select></div>
      <div class="col-lg-3"><label class="form-label">Start Date</label><input type="date" id="startDate" class="form-control" /></div>
      <div class="col-lg-3"><label class="form-label">End Date</label><input type="date" id="endDate" class="form-control" /></div>
      <div class="col-lg-3"><label class="form-label">Quick Search</label><input type="text" id="quickSearch" class="form-control" placeholder="Search..." /></div>
      <div class="col-12 text-end mt-3">
        <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
        <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Days Count</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- Attendance Table -->
  <div class="card shadow mb-4"><div class="card-body">
    <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
  </div></div>

  <!-- Charts -->
  <div class="row">
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
  </div>

  <!-- Settings -->
  <div class="card shadow my-4"><div class="card-body row g-3">
    <h5>⚙️ Settings</h5>
    <div class="col-md-3"><label class="form-label">Late After</label><input type="time" id="lateThreshold" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Early Leave Before</label><input type="time" id="earlyThreshold" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Half-day Max Hours</label><input type="number" id="halfDayHours" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Overtime Min Hours</label><input type="number" id="overtimeHours" class="form-control" /></div>
  </div></div>

  <!-- Holiday Manager -->
  <div class="card shadow mb-4"><div class="card-body">
    <h5>📅 Holiday Manager</h5>
    <div class="input-group mb-3">
      <input type="date" id="holidayDate" class="form-control" />
      <input type="text" id="holidayName" class="form-control" placeholder="Holiday Name" />
      <button class="btn btn-primary" onclick="addHoliday()">Add</button>
    </div>
    <ul id="holidayList" class="list-group"></ul>
  </div></div>

  <!-- Leave Manager -->
  <div class="card shadow mb-4"><div class="card-body">
    <h5>🏖️ Leave Manager</h5>
    <div class="input-group mb-3">
      <input type="date" id="leaveDate" class="form-control" />
      <input type="text" id="leaveEmployee" class="form-control" placeholder="Employee" />
      <select id="leaveType" class="form-select"><option>AL</option><option>SL</option><option>UL</option></select>
      <button class="btn btn-primary" onclick="addLeave()">Add</button>
    </div>
    <ul id="leaveList" class="list-group"></ul>
  </div></div>
</div>

<!-- ========== APP SCRIPT ========== -->
<script>
const API_URL="https://script.google.com/macros/s/AKfycbwJQUkt5YlHZZk5fwKBU-p3ltTgkPpyj_KpSKayGX6Aqqp-wjO54dKi8RlNrzGCMwIw1A/exec";
const API_TOKEN="a9fj32klsdfj0932LKJSDF90wef9";
const CSV_SUMMARY="https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";

let HOLIDAYS=[], LEAVES=[], SETTINGS={};
let CANON=[];
let table,barChartHandle,pieChartHandle,lineChartHandle;

// Helpers
function normalizeDate(d){ if(!d) return ""; const parts=d.split(/[\/\-]/); if(parts.length===3){ let [m,d2,y]=parts; if(y.length===2) y="20"+y; return `${y}-${m.padStart(2,"0")}-${d2.padStart(2,"0")}`; } return d; }
function parseTime(dateStr,timeStr){ if(!dateStr||!timeStr) return null; return new Date(`${dateStr}T${timeStr}`); }

// Toggle dark mode
function toggleDark(){ document.body.classList.toggle("dark-mode"); }

// Status compute
function computeStatus(r){
  let s=[]; if(r.signInDT && SETTINGS.lateThreshold){ const t=new Date(r.date+"T"+SETTINGS.lateThreshold); if(r.signInDT>t) s.push("Late"); }
  if(r.signOutDT && SETTINGS.earlyThreshold){ const t=new Date(r.date+"T"+SETTINGS.earlyThreshold); if(r.signOutDT<t) s.push("Early Leave"); }
  if(r.totalHours && SETTINGS.halfDayHours && r.totalHours<SETTINGS.halfDayHours) s.push("Half Day");
  if(r.totalHours && SETTINGS.overtimeHours && r.totalHours>SETTINGS.overtimeHours) s.push("Overtime");
  if(!r.signIn) s.push("Absent");
  return s;
}

// Holiday + Leave UI
function renderHolidays(){const ul=document.getElementById("holidayList");ul.innerHTML="";HOLIDAYS.forEach((h,i)=>{const li=document.createElement("li");li.className="list-group-item d-flex justify-content-between align-items-center";li.innerHTML=`${h.date} - ${h.name}<button class="btn btn-sm btn-danger">X</button>`;li.querySelector("button").onclick=()=>{HOLIDAYS.splice(i,1);renderHolidays();};ul.appendChild(li);});}
function renderLeaves(){const ul=document.getElementById("leaveList");ul.innerHTML="";LEAVES.forEach((l,i)=>{const li=document.createElement("li");li.className="list-group-item d-flex justify-content-between align-items-center";li.innerHTML=`${l.date} - ${l.employee} (${l.type})<button class="btn btn-sm btn-danger">X</button>`;li.querySelector("button").onclick=()=>{LEAVES.splice(i,1);renderLeaves();};ul.appendChild(li);});}
function addHoliday(){const d=document.getElementById("holidayDate").value;const n=document.getElementById("holidayName").value;if(d&&n){HOLIDAYS.push({date:d,name:n});renderHolidays();}}
function addLeave(){const d=document.getElementById("leaveDate").value;const e=document.getElementById("leaveEmployee").value;const t=document.getElementById("leaveType").value;if(d&&e){LEAVES.push({date:d,employee:e,type:t});renderLeaves();}}

// Load + Save to server
async function loadFromServer(){try{const r=await fetch(`${API_URL}?token=${API_TOKEN}`);const j=await r.json();if(j.ok){HOLIDAYS=j.holidays;LEAVES=j.leaves;SETTINGS={};j.settings.forEach(s=>SETTINGS[s.key]=s.value);renderHolidays();renderLeaves();}}catch(e){console.error(e);}}
async function saveToServer(){try{const body={holidays:HOLIDAYS,leaves:LEAVES,balances:[],settings:Object.entries(SETTINGS).map(([k,v])=>({key:k,value:v}))};const r=await fetch(`${API_URL}?token=${API_TOKEN}`,{method:"POST",body:JSON.stringify(body),headers:{"Content-Type":"application/json"}});const j=await r.json();if(!j.ok) throw new Error(j.error);alert("✅ Saved to Google Sheets");}catch(e){alert("❌ Save failed");console.error(e);}}

// Table + KPIs
function renderTable(data){
  if(table){table.destroy();document.getElementById("attendanceTable").innerHTML="";}
  const rows=data.map(r=>{const st=computeStatus(r);const badge=st.map(s=>`<span class="badge bg-secondary">${s}</span>`).join(" ");return [r.month||"",r.date||"",r.employee||"",r.signIn||"",r.signOut||"", (r.totalHours? r.totalHours.toFixed(2):"0.00"),badge];});
  table=$("#attendanceTable").DataTable({data:rows,columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Hours"},{title:"Status"}],dom:"Bfrtip",buttons:["copy","csv","excel","print"],scrollX:true});
  // KPIs
  let total=0,days=0,late=0,early=0,abs=0;data.forEach(r=>{if(!r.date) return;const st=computeStatus(r);if(!st.includes("Absent")){total+=r.totalHours||0;days++;}if(st.includes("Late")) late++;if(st.includes("Early Leave")) early++;if(st.includes("Absent")) abs++;});
  document.getElementById("totalHours").textContent=total.toFixed(1);document.getElementById("daysCount").textContent=days;document.getElementById("avgHours").textContent=days?(total/days).toFixed(1):0;document.getElementById("lateCount").textContent=late;document.getElementById("earlyCount").textContent=early;document.getElementById("absentCount").textContent=abs;
  if(barChartHandle) barChartHandle.destroy();if(pieChartHandle) pieChartHandle.destroy();if(lineChartHandle) lineChartHandle.destroy();
  const byDate={},byEmp={};data.forEach(r=>{if(r.date) byDate[r.date]=(byDate[r.date]||0)+(r.totalHours||0);if(r.employee) byEmp[r.employee]=(byEmp[r.employee]||0)+(r.totalHours||0);});
  barChartHandle=new Chart(document.getElementById("barChart"),{type:"bar",data:{labels:Object.keys(byDate),datasets:[{label:"Hours",data:Object.values(byDate)}]}});
  pieChartHandle=new Chart(document.getElementById("pieChart"),{type:"pie",data:{labels:Object.keys(byEmp),datasets:[{data:Object.values(byEmp)}]}});
  lineChartHandle=new Chart(document.getElementById("lineChart"),{type:"line",data:{labels:Object.keys(byDate),datasets:[{label:"Hours",data:Object.values(byDate)}]}});
}

// Filters
function getCriteria(){return{employees:$("#employeeFilter").val()||[],start:document.getElementById("startDate").value,end:document.getElementById("endDate").value,q:(document.getElementById("quickSearch").value||"").toLowerCase()};}
function applyFilters(){const c=getCriteria();const f=CANON.filter(r=>{if(c.employees.length&&!c.employees.includes(r.employee)) return false;if(c.start&&r.date<c.start) return false;if(c.end&&r.date>c.end) return false;if(c.q&&!`${r.employee} ${r.date}`.toLowerCase().includes(c.q)) return false;return true;});renderTable(f);}
function resetFilters(){$("#employeeFilter").val(null).trigger("change");document.getElementById("startDate").value="";document.getElementById("endDate").value="";document.getElementById("quickSearch").value="";applyFilters();}

// Load data from CSV summary
async function loadData(){
  loadFromServer();
  const res=await fetch(CSV_SUMMARY);const csv=Papa.parse(await res.text(),{header:true}).data;
  CANON=csv.map(r=>{const d=normalizeDate(r["Date"]);const sin=parseTime(d,r["Sign In Time"]);const sout=parseTime(d,r["Sign Out Time"]);const hours=parseFloat(r["Total Hours"]||0);return {month:r["Month"]|| (d?d.slice(0,7):""),date:d,employee:r["Employee Name"]||"",signIn:r["Sign In Time"]||"",signOut:r["Sign Out Time"]||"",signInDT:sin,signOutDT:sout,totalHours:hours};}).filter(r=>r.employee&&r.date);
  populateEmployeeFilter();applyFilters();
}
function populateEmployeeFilter(){const sel=document.getElementById("employeeFilter");sel.innerHTML="";[...new Set(CANON.map(r=>r.employee).filter(Boolean))].sort().forEach(emp=>{const o=document.createElement("option");o.value=emp;o.textContent=emp;sel.appendChild(o);});$("#employeeFilter").select2({placeholder:"Select employees...",allowClear:true,width:"100%"});}

// Download report
async function downloadFullReport(){const el=document.getElementById("reportArea");const canvas=await html2canvas(el,{scale:2});const img=canvas.toDataURL("image/png");pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");}

// Start
loadData();
</script>
</body>
</html>
