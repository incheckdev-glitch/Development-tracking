<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!-- DataTables Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f5f6fa; }
    .sidebar { height: 100vh; background: #343a40; color: white; padding: 20px; }
    .sidebar h4 { color: #ffc107; }
    .card { border-radius: 15px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <h4>Dashboard</h4>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link text-white" href="#summary">Summary</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#charts">Charts</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#table">Attendance Table</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4">Employee Attendance (Live from Google Sheet)</h2>

      <!-- Summary -->
      <div id="summary" class="row mb-4">
        <div class="col-md-4">
          <div class="card shadow p-3"><h5>Total Hours</h5><h3 id="totalHours">Loading...</h3></div>
        </div>
        <div class="col-md-4">
          <div class="card shadow p-3"><h5>Average Hours/Day</h5><h3 id="avgHours">Loading...</h3></div>
        </div>
        <div class="col-md-4">
          <div class="card shadow p-3"><h5>Attendance Days</h5><h3 id="daysCount">Loading...</h3></div>
        </div>
      </div>

      <!-- Charts -->
      <div id="charts" class="row mb-4">
        <div class="col-md-6">
          <div class="card shadow p-3"><h5>Hours Worked per Day</h5><canvas id="barChart"></canvas></div>
        </div>
        <div class="col-md-6">
          <div class="card shadow p-3"><h5>Total Hours by Employee</h5><canvas id="pieChart"></canvas></div>
        </div>
        <div class="col-md-12 mt-4">
          <div class="card shadow p-3"><h5>Trend: Total Hours Over Time</h5><canvas id="lineChart"></canvas></div>
        </div>
      </div>

      <!-- Attendance Table -->
      <div id="table" class="card shadow p-3">
        <h5>Attendance Log</h5>
        <table id="attendanceTable" class="table table-striped" style="width:100%">
          <thead>
            <tr>
              <th>Month</th>
              <th>Date</th>
              <th>Employee</th>
              <th>Sign In</th>
              <th>Sign Out</th>
              <th>Total Hours</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?output=csv";

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      // normalize headers (trim spaces)
      const data = results.data.map(r => {
        return {
          Month: r["Month"]?.trim(),
          Date: r["Date"]?.trim(),
          Employee: r["Employee Name"]?.trim(),
          SignIn: r["Sign In Time"]?.trim(),
          SignOut: r["Sign Out Time"]?.trim(),
          Hours: parseFloat(r["Total Hours"]) || 0
        };
      }).filter(r => r.Employee && r.Date);

      const tableBody = document.querySelector("#attendanceTable tbody");
      tableBody.innerHTML = "";
      let totalHours = 0;
      let countHours = 0;
      const dailyTotals = {};
      const empTotals = {};

      data.forEach(row => {
        if(row.Hours > 0){ totalHours += row.Hours; countHours++; }
        dailyTotals[row.Date] = (dailyTotals[row.Date] || 0) + row.Hours;
        empTotals[row.Employee] = (empTotals[row.Employee] || 0) + row.Hours;

        const tr = `<tr>
          <td>${row.Month}</td>
          <td>${row.Date}</td>
          <td>${row.Employee}</td>
          <td>${row.SignIn}</td>
          <td>${row.SignOut}</td>
          <td>${row.Hours || ""}</td>
        </tr>`;
        tableBody.insertAdjacentHTML("beforeend", tr);
      });

      // KPIs
      const daysCount = Object.keys(dailyTotals).length;
      const avgHours = countHours > 0 ? (totalHours / countHours).toFixed(2) : 0;
      document.getElementById("totalHours").textContent = totalHours.toFixed(2);
      document.getElementById("avgHours").textContent = avgHours;
      document.getElementById("daysCount").textContent = daysCount;

      // Charts
      new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: { labels: Object.keys(dailyTotals),
                datasets: [{ label: "Total Hours", data: Object.values(dailyTotals) }] }
      });

      new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: { labels: Object.keys(empTotals),
                datasets: [{ data: Object.values(empTotals) }] }
      });

      new Chart(document.getElementById("lineChart"), {
        type: "line",
        data: { labels: Object.keys(dailyTotals),
                datasets: [{ label: "Hours", data: Object.values(dailyTotals), fill:false, borderColor:"blue" }] }
      });

      // DataTable with export buttons
      $('#attendanceTable').DataTable({
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
      });
    }
  });
</script>
</body>
</html>
