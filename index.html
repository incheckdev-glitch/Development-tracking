<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance & Leave Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ======================= CSS LIBS ======================= -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

  <!-- ======================= JS LIBS ======================= -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body.dark-mode {
      background: #181a1f;
      color: #eee;
    }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .filter-bar { position: sticky; top: 0; z-index: 10; background: inherit; padding: 10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>

<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- ======= HEADER ======= -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä Attendance & Leave Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">üåô/‚òÄÔ∏è</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>
  </div>

  <!-- ======= FILTERS ======= -->
  <div class="card shadow filter-bar mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-lg-3">
        <label class="form-label">Employee</label>
        <select id="employeeFilter" multiple></select>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control"/>
      </div>
      <div class="col-lg-3">
        <label class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control"/>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Quick Search</label>
        <input type="text" id="quickSearch" class="form-control" placeholder="Search..."/>
      </div>
      <div class="col-12 text-end mt-3">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  <!-- ======= KPI CARDS ======= -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Workdays</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- ======= BALANCE CARDS ======= -->
  <div class="row mb-4 text-center">
    <h5>üìå Leave Balances (Company-wide)</h5>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Annual Leaves</h5><h3 id="annualLeavesCard">0</h3></div></div></div>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Sick Leaves</h5><h3 id="sickLeavesCard">0</h3></div></div></div>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Unpaid Leaves</h5><h3 id="unpaidLeavesCard">0</h3></div></div></div>
  </div>

  <div class="row mb-4 text-center">
    <h5>üìå Leave Balances (Filtered Employees)</h5>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Annual Leaves</h5><h3 id="annualLeavesCardFiltered">0</h3></div></div></div>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Sick Leaves</h5><h3 id="sickLeavesCardFiltered">0</h3></div></div></div>
    <div class="col-md-4"><div class="card shadow"><div class="card-body"><h5>Unpaid Leaves</h5><h3 id="unpaidLeavesCardFiltered">0</h3></div></div></div>
  </div>
  <!-- ======= TABLE ======= -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
    </div>
  </div>

  <!-- ======= CHARTS ======= -->
  <div class="row">
    <div class="col-lg-4">
      <div class="card shadow p-3">
        <h5>Hours per Day</h5>
        <canvas id="barChart"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow p-3">
        <h5>Hours by Employee</h5>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow p-3">
        <h5>Trend</h5>
        <canvas id="lineChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ======= SETTINGS ======= -->
  <div class="card shadow my-4">
    <div class="card-body row g-3">
      <h5>‚öôÔ∏è Settings</h5>
      <div class="col-md-3">
        <label class="form-label">Late After (HH:MM)</label>
        <input type="time" id="lateThreshold" class="form-control"/>
      </div>
      <div class="col-md-3">
        <label class="form-label">Early Leave Before (HH:MM)</label>
        <input type="time" id="earlyThreshold" class="form-control"/>
      </div>
      <div class="col-md-3">
        <label class="form-label">Half-day Max Hours</label>
        <input type="number" id="halfDayHours" class="form-control"/>
      </div>
      <div class="col-md-3">
        <label class="form-label">Overtime Min Hours</label>
        <input type="number" id="overtimeHours" class="form-control"/>
      </div>
    </div>
  </div>

  <!-- ======= HOLIDAY MANAGER ======= -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5>üìÖ Holiday Manager</h5>
      <div class="input-group mb-3">
        <input type="date" id="holidayDate" class="form-control"/>
        <input type="text" id="holidayName" class="form-control" placeholder="Holiday Name"/>
        <button class="btn btn-primary" onclick="addHoliday()">Add</button>
      </div>
      <ul id="holidayList" class="list-group"></ul>
    </div>
  </div>

  <!-- ======= LEAVE MANAGER ======= -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5>üèñÔ∏è Leave Manager</h5>
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <input type="date" id="leaveDate" class="form-control"/>
        </div>
        <div class="col-md-3">
          <select id="leaveEmployee" class="form-control"></select>
        </div>
        <div class="col-md-3">
          <select id="leaveType" class="form-control">
            <option value="Annual">Annual Leave</option>
            <option value="Sick">Sick Leave</option>
            <option value="Unpaid">Unpaid Leave</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="addLeave()">Add Leave</button>
        </div>
      </div>
      <ul id="leaveList" class="list-group"></ul>
    </div>
  </div>

  <!-- ======= BALANCE MANAGER ======= -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5>‚öñÔ∏è Leave Balances</h5>
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <select id="balanceEmployee" class="form-control"></select>
        </div>
        <div class="col-md-2">
          <input type="number" id="balanceAnnual" class="form-control" placeholder="Annual"/>
        </div>
        <div class="col-md-2">
          <input type="number" id="balanceSick" class="form-control" placeholder="Sick"/>
        </div>
        <div class="col-md-2">
          <input type="number" id="balanceUnpaid" class="form-control" placeholder="Unpaid"/>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="updateBalance()">Update</button>
        </div>
      </div>
      <ul id="balanceList" class="list-group"></ul>
    </div>
  </div>
<script>
/* ==========================================================
 * CONFIGURATION
 * ========================================================== */

// Base URL of your deployed Apps Script Web App
const API_BASE = "https://script.google.com/macros/s/AKfycby4i9AoZgoPGKQ4eEwCzm40DPP5YtIFKXoPgVipCuR2t90e5aZpYb2WLJ5Pk3X4fARQ/exec";

// Secret token (must match your doGet/doPost verification)
const API_SECRET = "a9fj32klsdfj0932LKJSDF90wef9";

// Canonical attendance data
let CANON = [];

// Holidays, Leaves, and Balances
let HOLIDAYS = [];
let LEAVES   = [];
let BALANCES = [];

// DataTable handle
let DT = null;

// Chart handles
let barChartHandle  = null;
let pieChartHandle  = null;
let lineChartHandle = null;


/* ==========================================================
 * GENERAL HELPERS
 * ========================================================== */

/**
 * Toggle dark mode on and off
 */
function toggleDark() {
  document.body.classList.toggle("dark-mode");
}

/**
 * Normalize a date string to YYYY-MM-DD
 */
function normalizeDate(d) {
  if (!d) return "";
  const s = String(d).trim();

  // Case: DD/MM/YYYY
  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length === 3) {
      const dd = parts[0];
      const mm = parts[1];
      const yy = parts[2];
      return yy + "-" + String(mm).padStart(2, "0") + "-" + String(dd).padStart(2, "0");
    }
  }

  // Case: Already normalized
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    return s;
  }

  return "";
}

/**
 * Compute attendance status based on thresholds
 */
function computeStatus(row, settings) {
  if (row.status) return row.status;

  const lateParts  = settings.late.split(":").map(Number);
  const earlyParts = settings.early.split(":").map(Number);

  const half = parseFloat(settings.half);
  const over = parseFloat(settings.over);

  if (!row.signInDT && !row.signOutDT) {
    return ["Absent"];
  }

  if ((row.signInDT && !row.signOutDT) || (!row.signInDT && row.signOutDT)) {
    return ["Needs Correction"];
  }

  const inMinutes = row.signInDT ? row.signInDT.getHours() * 60 + row.signInDT.getMinutes() : null;
  const outMinutes = row.signOutDT ? row.signOutDT.getHours() * 60 + row.signOutDT.getMinutes() : null;

  const status = [];

  if (inMinutes && inMinutes > (lateParts[0] * 60 + lateParts[1])) {
    status.push("Late");
  }

  if (outMinutes && outMinutes < (earlyParts[0] * 60 + earlyParts[1])) {
    status.push("Early Leave");
  }

  if (row.totalHours > 0 && row.totalHours < half) {
    status.push("Half-day");
  }

  if (row.totalHours >= over) {
    status.push("Overtime");
  }

  if (status.length === 0) {
    status.push("On Time");
  }

  return status;
}

/**
 * Parse a single row from AttendanceSummary
 */
function parseRow(r) {
  const dateISO = normalizeDate(r[1]);

  const signInRaw  = r[3];
  const signOutRaw = r[4];

  const signInDT   = dateISO && signInRaw  ? new Date(signInRaw)  : null;
  const signOutDT  = dateISO && signOutRaw ? new Date(signOutRaw) : null;

  const totalHours = parseFloat(r[5]) || 0;

  return {
    month:     r[0],
    date:      dateISO,
    employee:  r[2],
    signIn:    signInRaw,
    signOut:   signOutRaw,
    signInDT:  signInDT,
    signOutDT: signOutDT,
    totalHours: totalHours
  };
}


/* ==========================================================
 * API HELPERS
 * ========================================================== */

/**
 * Fetch data from a sheet
 */
async function apiFetch(sheet) {
  const url = API_BASE + "?secret=" + API_SECRET + "&sheet=" + sheet;
  const res = await fetch(url);
  return res.json();
}

/**
 * Post data to a sheet (add/remove/update)
 */
async function apiPost(sheet, action, payload) {
  const res = await fetch(API_BASE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      secret: API_SECRET,
      sheet:  sheet,
      action: action,
      payload: payload
    })
  });
  return res.json();
}


/* ==========================================================
 * HOLIDAY MANAGER
 * ========================================================== */

function renderHolidayList() {
  const list = document.getElementById("holidayList");
  list.innerHTML = "";

  HOLIDAYS.forEach(function(h, i) {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${h.date} - ${h.name}</span>
      <button class="btn btn-sm btn-danger" onclick="removeHoliday(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
}

async function addHoliday() {
  const date = document.getElementById("holidayDate").value;
  const name = document.getElementById("holidayName").value;

  if (!date) {
    alert("Please pick a date");
    return;
  }

  const resp = await apiPost("Holidays", "add", { date: date, name: name });

  if (resp.ok) {
    HOLIDAYS.push({ date: date, name: name });
    renderHolidayList();
  }
}

async function removeHoliday(idx) {
  const h = HOLIDAYS[idx];
  const resp = await apiPost("Holidays", "remove", { date: h.date });

  if (resp.ok) {
    HOLIDAYS.splice(idx, 1);
    renderHolidayList();
  }
}


/* ==========================================================
 * LEAVE MANAGER
 * ========================================================== */

function renderLeaveList() {
  const list = document.getElementById("leaveList");
  list.innerHTML = "";

  LEAVES.forEach(function(l, i) {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${l.date} - ${l.employee} (${l.type})</span>
      <button class="btn btn-sm btn-danger" onclick="removeLeave(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
}

async function addLeave() {
  const date     = document.getElementById("leaveDate").value;
  const employee = document.getElementById("leaveEmployee").value;
  const type     = document.getElementById("leaveType").value;

  if (!date || !employee) {
    alert("Fill required fields");
    return;
  }

  const resp = await apiPost("Leaves", "add", {
    date: date,
    employee: employee,
    type: type
  });

  if (resp.ok) {
    LEAVES.push({ date: date, employee: employee, type: type });
    renderLeaveList();
  }
}

async function removeLeave(idx) {
  const l = LEAVES[idx];
  const resp = await apiPost("Leaves", "remove", { date: l.date, employee: l.employee });

  if (resp.ok) {
    LEAVES.splice(idx, 1);
    renderLeaveList();
  }
}


/* ==========================================================
 * BALANCE MANAGER
 * ========================================================== */

function renderBalances() {
  const list = document.getElementById("balanceList");
  list.innerHTML = "";

  BALANCES.forEach(function(b, i) {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${b.employee}: Annual ${b.annual}, Sick ${b.sick}, Unpaid ${b.unpaid}</span>
      <button class="btn btn-sm btn-danger" onclick="removeBalance(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
}

async function updateBalance() {
  const employee = document.getElementById("balanceEmployee").value;
  const annual   = document.getElementById("balanceAnnual").value;
  const sick     = document.getElementById("balanceSick").value;
  const unpaid   = document.getElementById("balanceUnpaid").value;

  if (!employee) {
    alert("Pick an employee");
    return;
  }

  const payload = {
    employee: employee,
    annual: annual,
    sick: sick,
    unpaid: unpaid
  };

  const resp = await apiPost("Balances", "update", payload);

  if (resp.ok) {
    const idx = BALANCES.findIndex(b => b.employee === employee);
    if (idx >= 0) {
      BALANCES[idx] = payload;
    } else {
      BALANCES.push(payload);
    }
    renderBalances();
  }
}

async function removeBalance(idx) {
  const b = BALANCES[idx];
  const resp = await apiPost("Balances", "remove", { employee: b.employee });

  if (resp.ok) {
    BALANCES.splice(idx, 1);
    renderBalances();
  }
}


/* ==========================================================
 * TABLE RENDER + KPIs
 * ========================================================== */

function renderTable(data) {
  const settings = JSON.parse(localStorage.getItem("settings") || '{"late":"08:15","early":"16:30","half":4,"over":9}');

  const rows = data.map(function(r) {
    const st = computeStatus(r, settings);
    let badge = "";

    st.forEach(function(label) {
      let cls = "bg-secondary";

      if (label === "Late") {
        cls = "bg-danger";
      } else if (label === "Early Leave") {
        cls = "bg-warning text-dark";
      } else if (label === "On Time") {
        cls = "bg-success";
      } else if (label === "Absent") {
        cls = "bg-dark";
      } else if (label === "Needs Correction") {
        cls = "bg-danger text-white";
      } else if (label === "Half-day") {
        cls = "bg-info text-dark";
      } else if (label === "Overtime") {
        cls = "bg-primary";
      } else if (label === "Holiday") {
        cls = "bg-secondary";
      } else if (label === "Weekend") {
        cls = "bg-light text-dark";
      }

      badge += `<span class="badge ${cls}">${label}</span> `;
    });

    return [
      r.month,
      r.date,
      r.employee,
      r.signIn,
      r.signOut,
      r.totalHours.toFixed(2),
      badge
    ];
  });

  if (!DT) {
    DT = $("#attendanceTable").DataTable({
      data: rows,
      columns: [
        { title: "Month" },
        { title: "Date" },
        { title: "Employee" },
        { title: "Sign In" },
        { title: "Sign Out" },
        { title: "Total Hours" },
        { title: "Status" }
      ],
      dom: "Bfrtip",
      buttons: ["csv", "excel", "pdf", "print"],
      pageLength: 10,
      order: [[1, "asc"]],
      createdRow: function(row, rowData) {
        const statusHtml = rowData[6] || "";
        if (statusHtml.includes("Holiday")) $(row).addClass("holiday-row");
        if (statusHtml.includes("Weekend")) $(row).addClass("weekend-row");
      }
    });
  } else {
    DT.clear().rows.add(rows).draw();
  }
}


/* ==========================================================
 * LOAD SEQUENCE
 * ========================================================== */

async function loadData() {
  const a = await apiFetch("AttendanceSummary");
  CANON = a.data.map(parseRow);

  const h = await apiFetch("Holidays");
  HOLIDAYS = h.data.map(r => ({ date: r[0], name: r[1] }));

  const l = await apiFetch("Leaves");
  LEAVES = l.data.map(r => ({ date: r[0], employee: r[1], type: r[2] }));

  const b = await apiFetch("Balances");
  BALANCES = b.data.map(r => ({
    employee: r[0],
    annual: r[1],
    sick: r[2],
    unpaid: r[3]
  }));

  renderTable(CANON);
  renderHolidayList();
  renderLeaveList();
  renderBalances();
}

loadData();
</script>
</body>
</html>
