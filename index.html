<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- vis.js Timeline -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.js"></script>

  <style>
    body { background: #f4f6f9; font-family: 'Segoe UI', Tahoma, sans-serif; }
    .sidebar { min-height: 100vh; background: #1e1f26; color: #fff; padding: 20px; }
    .sidebar h4 { color: #00c9a7; }
    .sidebar .nav-link { color: #bbb; }
    .sidebar .nav-link:hover { color: #fff; background: #2c2f38; border-radius: 5px; }
    .card { border-radius: 15px; }
    .kpi-card { color: white; border: none; }
    .kpi-blue { background: linear-gradient(135deg, #007bff, #00c6ff); }
    .kpi-green { background: linear-gradient(135deg, #28a745, #00e68a); }
    .kpi-orange { background: linear-gradient(135deg, #ff7e5f, #feb47b); }
    .kpi-purple { background: linear-gradient(135deg, #6f42c1, #b47bff); }
    .kpi-red { background: linear-gradient(135deg, #dc3545, #ff6b6b); }
    .filter-bar { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .table-soft-danger { background-color: #fcebea !important; }
    .table-soft-warning { background-color: #fff8e5 !important; }
    /* Dark mode */
    body.dark { background: #121212; color: #e0e0e0; }
    body.dark .card, body.dark .filter-bar { background: #1e1e1e; color: #e0e0e0; }
    body.dark .sidebar { background: #000; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar d-flex flex-column">
      <h4>üìä Dashboard</h4>
      <ul class="nav flex-column mt-3">
        <li class="nav-item"><a class="nav-link" href="#summary">Summary</a></li>
        <li class="nav-item"><a class="nav-link" href="#charts">Charts</a></li>
        <li class="nav-item"><a class="nav-link" href="#timeline">Timeline</a></li>
        <li class="nav-item"><a class="nav-link" href="#table">Table</a></li>
      </ul>
      <hr>
      <button class="btn btn-outline-light mt-auto" onclick="toggleDarkMode()">üåô/‚òÄÔ∏è</button>
    </div>

    <!-- Main -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4">Employee Attendance</h2>

      <!-- Filters -->
      <div class="filter-bar">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Employee(s)</label>
            <select id="employeeFilter" class="form-select" multiple></select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Hour Range</label>
            <input type="text" id="hourRange" readonly class="form-control-plaintext">
            <input type="range" id="minHours" min="0" max="12" value="0" step="0.25" oninput="updateHourLabel()">
            <input type="range" id="maxHours" min="0" max="12" value="12" step="0.25" oninput="updateHourLabel()">
          </div>
          <div class="col-md-2">
            <label class="form-label">Shift</label>
            <select id="shiftFilter" class="form-select">
              <option value="">All</option>
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
            </select>
          </div>
          <div class="col-md-1">
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">Reset</button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div id="summary" class="row mb-4 text-center">
        <div class="col-md-2"><div class="card kpi-card kpi-blue p-3"><h6>Total Hours</h6><h2 id="totalHours">0</h2></div></div>
        <div class="col-md-2"><div class="card kpi-card kpi-green p-3"><h6>Avg Hours/Day</h6><h2 id="avgHours">0</h2></div></div>
        <div class="col-md-2"><div class="card kpi-card kpi-orange p-3"><h6>Attendance Days</h6><h2 id="daysCount">0</h2></div></div>
        <div class="col-md-2"><div class="card kpi-card kpi-purple p-3"><h6>Late Count</h6><h2 id="lateCount">0</h2></div></div>
        <div class="col-md-2"><div class="card kpi-card kpi-red p-3"><h6>Early Leave</h6><h2 id="earlyCount">0</h2></div></div>
        <div class="col-md-2"><button class="btn btn-primary mt-3" onclick="downloadReport()">üì• Download Report</button></div>
      </div>

      <!-- Charts -->
      <div id="charts" class="row mb-4">
        <div class="col-md-6"><div class="card shadow p-3"><h6>Hours Worked per Day</h6><canvas id="barChart"></canvas></div></div>
        <div class="col-md-6"><div class="card shadow p-3"><h6>Total Hours by Employee</h6><canvas id="pieChart"></canvas></div></div>
        <div class="col-md-12 mt-4"><div class="card shadow p-3"><h6>Trend Over Time</h6><canvas id="lineChart"></canvas></div></div>
      </div>

      <!-- Timeline -->
      <div id="timeline" class="card shadow p-3 mb-4">
        <h6>Attendance Timeline</h6>
        <div id="timelineView" style="height:300px;"></div>
      </div>

      <!-- Table -->
      <div id="table" class="card shadow p-3">
        <h6>Attendance Log</h6>
        <input type="search" id="quickSearch" class="form-control mb-2" placeholder="Quick search...">
        <table id="attendanceTable" class="table table-striped table-hover" style="width:100%">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
// === CONFIG ===
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";

let allData = [];
let dataTable = null;
let barChart, pieChart, lineChart, timeline;

// === LOAD DATA ===
function loadData() {
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      allData = results.data;
      populateEmployeeFilter();
      applyFilters();
    }
  });
}

function populateEmployeeFilter() {
  const employeeSet = new Set(allData.map(r => r["Employee Name"]).filter(Boolean));
  const select = document.getElementById("employeeFilter");
  select.innerHTML = '';
  employeeSet.forEach(emp => select.insertAdjacentHTML("beforeend", `<option value="${emp}">${emp}</option>`));
}

// === FILTERING ===
function updateHourLabel() {
  document.getElementById("hourRange").value = 
    document.getElementById("minHours").value + " - " + document.getElementById("maxHours").value + "h";
}
updateHourLabel();

function applyFilters() {
  const empFilter = Array.from(document.getElementById("employeeFilter").selectedOptions).map(o => o.value);
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const minHours = parseFloat(document.getElementById("minHours").value);
  const maxHours = parseFloat(document.getElementById("maxHours").value);
  const shift = document.getElementById("shiftFilter").value;

  let filtered = allData.filter(r => {
    let ok = true;
    if (empFilter.length && !empFilter.includes(r["Employee Name"])) ok = false;
    if (start && new Date(r["Date"]) < new Date(start)) ok = false;
    if (end && new Date(r["Date"]) > new Date(end)) ok = false;
    if (r["Total Hours"]) {
      const h = parseFloat(r["Total Hours"]);
      if (h < minHours || h > maxHours) ok = false;
    }
    if (shift && r["Sign In Time"]) {
      const signIn = new Date(r["Sign In Time"]);
      if (shift=="morning" && signIn.getHours()>=12) ok = false;
      if (shift=="afternoon" && signIn.getHours()<12) ok = false;
    }
    return ok;
  });

  renderDashboard(filtered);
}

function resetFilters() {
  document.getElementById("employeeFilter").value = "";
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  document.getElementById("minHours").value = 0;
  document.getElementById("maxHours").value = 12;
  document.getElementById("shiftFilter").value = "";
  updateHourLabel();
  renderDashboard(allData);
}

// === DASHBOARD ===
function renderDashboard(data) {
  let totalHours = 0, countHours = 0, lateCount = 0, earlyCount = 0;
  const dailyTotals = {}, empTotals = {}, timelineItems = [];

  data.forEach(row => {
    const hours = parseFloat(row["Total Hours"] || 0) || 0;
    if(hours > 0){ totalHours += hours; countHours++; }
    if(row["Date"]) dailyTotals[row["Date"]] = (dailyTotals[row["Date"]] || 0) + hours;
    if(row["Employee Name"]) empTotals[row["Employee Name"]] = (empTotals[row["Employee Name"]] || 0) + hours;

    if (row["Sign In Time"] && row["Sign Out Time"]) {
      timelineItems.push({
        id: row["Employee Name"]+row["Date"],
        content: row["Employee Name"],
        start: row["Sign In Time"],
        end: row["Sign Out Time"]
      });
    }
  });

  // KPIs
  document.getElementById("totalHours").textContent = totalHours.toFixed(2);
  document.getElementById("avgHours").textContent = countHours > 0 ? (totalHours / countHours).toFixed(2) : 0;
  document.getElementById("daysCount").textContent = Object.keys(dailyTotals).length;

  // Charts
  [barChart, pieChart, lineChart].forEach(ch => { if(ch) ch.destroy(); });

  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: { labels: Object.keys(dailyTotals), datasets: [{ label: "Total Hours", data: Object.values(dailyTotals), backgroundColor:"#4dabf7" }] }
  });

  pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: { labels: Object.keys(empTotals), datasets: [{ data: Object.values(empTotals), backgroundColor:["#4dabf7","#51cf66","#ffd43b","#ff6b6b","#845ef7"] }] }
  });

  lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: { labels: Object.keys(dailyTotals), datasets: [{ label: "Hours", data: Object.values(dailyTotals), fill:false, borderColor:"#4dabf7" }] }
  });

  // Timeline
  if (timeline) timeline.destroy();
  timeline = new vis.Timeline(document.getElementById("timelineView"), new vis.DataSet(timelineItems), {
    stack: true, showCurrentTime: false, zoomMin: 1000*60*60, zoomMax: 1000*60*60*24
  });

  // Table
  if (dataTable) { dataTable.destroy(); }
  const tableBody = document.querySelector("#attendanceTable tbody");
  const headerRow = document.getElementById("headerRow");
  tableBody.innerHTML = ""; headerRow.innerHTML = "";

  if (!data.length) { 
    tableBody.innerHTML = "<tr><td colspan='7'>No data</td></tr>"; 
    return; 
  }

  const keys = Object.keys(data[0]);
  keys.forEach(k => headerRow.insertAdjacentHTML("beforeend", `<th>${k}</th>`));
  headerRow.insertAdjacentHTML("beforeend", "<th>Status</th>");

  data.forEach(row => {
    const hours = parseFloat(row["Total Hours"] || 0) || 0;
    let rowClass = "";
    if(hours > 0 && hours < 7) rowClass = "table-soft-danger";
    if(hours > 9) rowClass = "table-soft-warning";

    // Status
    let status = '<span class="badge bg-secondary">Missing</span>';
    if (row["Sign In Time"] && row["Sign Out Time"]) {
      const signIn = new Date(row["Sign In Time"]);
      const signOut = new Date(row["Sign Out Time"]);
      const signInLimit = new Date(signIn); signInLimit.setHours(8,15,0,0);
      const signOutLimit = new Date(signOut); signOutLimit.setHours(16,30,0,0);
      if (signIn > signInLimit) { status = '<span class="badge bg-danger"
