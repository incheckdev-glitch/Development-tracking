<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.1/css/fixedHeader.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"/>

  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b;
      --card:#ffffff; --line:#e2e8f0;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --accent:#7c3aed; --absent:#b91c1c;
      --heat-none:#e2e8f0; --heat-low:#c7d2fe; --heat-mid:#93c5fd; --heat-high:#60a5fa;
    }
    body.dark-mode{
      --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8;
      --card:#111827; --line:#1f2937;
      --heat-none:#1f2937; --heat-low:#4f46e5; --heat-mid:#0284c7; --heat-high:#22d3ee;
    }
    body{ background:var(--bg); color:var(--fg); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; }
    .glass{ background:var(--card); border:1px solid var(--line); border-radius:14px; }
    .chip{ background:rgba(148,163,184,.12); padding:.5rem .75rem; border-radius:9999px; display:inline-block; }
    .filter-bar{ position:sticky; top:0; z-index:20; padding:12px; backdrop-filter:saturate(1.2) blur(4px); }

    .status-badge{ padding:.2rem .5rem; border-radius:999px; font-weight:600; font-size:.85rem; display:inline-block; }
    .status-Present{ background:rgba(22,163,74,.12); color:var(--good); border:1px solid rgba(22,163,74,.35); }
    .status-Late{ background:rgba(245,158,11,.12); color:var(--warn); border:1px solid rgba(245,158,11,.35); }
    .status-Left_Early{ background:rgba(239,68,68,.12); color:var(--bad); border:1px solid rgba(239,68,68,.35); }
    .status-Late_Left_Early{ background:rgba(245,158,11,.12); color:var(--warn); border:1px solid rgba(245,158,11,.35); }
    .status-Half_Day{ background:rgba(124,58,237,.12); color:var(--accent); border:1px solid rgba(124,58,237,.35); }
    .status-Absent{ background:rgba(185,28,28,.12); color:var(--absent); border:1px solid rgba(185,28,28,.35); }
    .status-Need_Correction{ background:rgba(245,158,11,.18); color:var(--warn); border:1px dashed rgba(245,158,11,.45); cursor:pointer; }

    #heatmap{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .heat-cell{ height:42px; border-radius:8px; display:flex; align-items:flex-start; justify-content:flex-end; padding:4px; font-size:.8rem; color:var(--fg); }
    .heat-cell .d{ opacity:.85; font-weight:600; }

    table.dataTable thead th{ color:var(--fg); }
    table.dataTable{ color:var(--fg); }
    .select2-container--default .select2-selection--multiple{ background:var(--card); border-color:var(--line); color:var(--fg); }
  </style>
</head>
<body>
  <div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h2 class="mb-0">üìä Attendance Intelligence</h2>
        <small id="buildStamp" class="text-secondary"></small>
        <div><small id="lastSync" class="text-secondary"></small></div>
      </div>
      <div class="d-flex gap-2">
        <button id="themeBtn" class="btn btn-outline-secondary"><i id="themeIcon" class="bi bi-moon-stars"></i></button>
        <button id="refreshBtn" class="btn btn-outline-primary"><i class="bi bi-arrow-repeat me-1"></i>Refresh</button>
        <button id="pdfBtn" class="btn btn-success"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</button>
        <button id="packBtn" class="btn btn-outline-success"><i class="bi bi-box-arrow-down me-1"></i>Export Pack</button>
        <button id="packsMonthlyBtn" class="btn btn-outline-success"><i class="bi bi-archive me-1"></i>Monthly Packs</button>
        <button id="icsBtn" class="btn btn-outline-dark"><i class="bi bi-calendar2-event me-1"></i>ICS Absences</button>
        <button id="settingsBtn" class="btn btn-outline-dark"><i class="bi bi-gear me-1"></i>Settings</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card p-3 h-100">
          <div class="text-secondary">Working Days</div>
          <div class="fs-3 fw-bold" id="kpiDays">0</div>
          <small id="kpiDaysNote" class="text-secondary"></small>
          <div class="mt-2"><canvas id="sparkDays" width="110" height="50"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 h-100">
          <div class="text-secondary">Total Hours <small id="kpiHoursVar" class="ms-1"></small></div>
          <div class="fs-3 fw-bold" id="kpiHours">0</div>
          <small class="text-secondary">vs Target: <span id="kpiVar"></span></small>
          <div class="mt-2"><canvas id="sparkHours" width="110" height="50"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 h-100">
          <div class="text-secondary">On-time Rate <small id="kpiOntimeVar" class="ms-1"></small></div>
          <div class="fs-3 fw-bold" id="kpiOntime">0%</div>
          <small class="text-secondary">Absent: <b id="kpiAbsent">0</b> ‚Ä¢ Half: <b id="kpiHalf">0</b></small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 h-100">
          <div class="text-secondary">Late / Early Minutes</div>
          <div class="d-flex gap-3">
            <span>Late: <b id="kpiLateM">0</b></span>
            <span>Early: <b id="kpiEarlyM">0</b></span>
          </div>
          <small id="kpiUpdated" class="text-secondary"></small>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card filter-bar mb-3">
      <div class="card-body row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Month</label>
          <select id="monthFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Status</label>
          <select id="statusFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Quick Search</label>
          <input id="quickSearch" class="form-control" placeholder="Name, status, date..." />
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Display</label>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="policySwitch">
            <label class="form-check-label" for="policySwitch">Recompute Status by Policy</label>
          </div>
          <div class="form-check form-switch mt-1">
            <input class="form-check-input" type="checkbox" id="decimalSwitch">
            <label class="form-check-label" for="decimalSwitch">Hours in Decimals</label>
          </div>
        </div>
        <div class="col-lg-3 text-end">
          <button id="applyBtn" class="btn btn-primary">Apply</button>
          <button id="resetBtn" class="btn btn-warning">Reset</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><small class="text-secondary" id="stickyTotals"></small></div>
      </div>
      <table id="attendanceTable" class="display nowrap" style="width:100%"></table>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
      <div class="col-lg-6"><div class="card p-3"><h6 class="mb-2">Hours by Employee</h6><canvas id="chartByEmp" height="220"></canvas></div></div>
      <div class="col-lg-6"><div class="card p-3"><h6 class="mb-2">Hours over Time</h6><canvas id="chartOverTime" height="220"></canvas></div></div>
      <div class="col-lg-6"><div class="card p-3"><h6 class="mb-2">Over/Under Time by Employee</h6><canvas id="chartOverUnder" height="220"></canvas></div></div>
      <div class="col-lg-6"><div class="card p-3"><h6 class="mb-2">Late vs Early Minutes (Employee)</h6><canvas id="chartLateEarly" height="220"></canvas></div></div>
    </div>

    <!-- Heatmap -->
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Calendar Heatmap</h6>
        <input type="month" id="heatmapMonth" class="form-control" style="max-width:200px" />
      </div>
      <div id="heatmap"></div>
    </div>

    <!-- Anomalies -->
    <div class="card p-3 mb-5">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">üêû Anomalies (Missing punches on working days)</h6>
        <span class="badge text-bg-danger" id="anomalyBadge">0</span>
      </div>
      <div class="row g-3" id="anomaliesBody"></div>
    </div>
  </div>

  <!-- Employee Drawer -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="empDrawer">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="empDrawerLabel">Employee</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="empMeta" class="mb-3"></div>
      <canvas id="empChart" height="160" class="mb-3"></canvas>
      <div class="table-responsive">
        <table class="table table-sm" id="empTable"></table>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Policy & Calendar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-md-3"><label class="form-label">Day Start</label><input id="setStart" type="time" class="form-control" value="08:00"></div>
        <div class="col-md-3"><label class="form-label">Day End</label><input id="setEnd" type="time" class="form-control" value="16:45"></div>
        <div class="col-md-3"><label class="form-label">Late Grace (min)</label><input id="setGraceMin" type="number" class="form-control" value="20"></div>
        <div class="col-md-3"><label class="form-label">Early Grace (min)</label><input id="setEarlyGraceMin" type="number" class="form-control" value="0"></div>
        <div class="col-md-3"><label class="form-label">Break (min)</label><input id="setBreakMin" type="number" class="form-control" value="30"></div>
        <div class="col-md-3"><label class="form-label">Target Hours / day</label><input id="setWorkdayHours" type="number" step="0.01" class="form-control" value="8.75"></div>
        <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input id="setUseCalcTarget" class="form-check-input" type="checkbox"><label class="form-check-label">Use Start/End - Break</label></div></div>
        <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input id="setAbsentEnabled" class="form-check-input" type="checkbox" checked><label class="form-check-label">Mark Absent on working day</label></div></div>
        <div class="col-md-3"><label class="form-label">Half-day threshold (h)</label><input id="setHalfDayHours" type="number" step="0.25" class="form-control" value="4"></div>
        <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input id="setHalfDayUseNet" class="form-check-input" type="checkbox" checked><label class="form-check-label">Half-day uses Net</label></div></div>

        <div class="col-12"><hr></div>

        <!-- Approval controls -->
        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check">
            <input id="setRequireApproval" class="form-check-input" type="checkbox">
            <label class="form-check-label">Corrections require approval</label>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Approval Password</label>
          <input id="setApprovalPass" class="form-control" type="password" placeholder="Enter to override queue">
          <div class="form-text">Password to bypass queue when approval is ON (default: 12345678).</div>
        </div>

        <div class="col-12"><hr></div>

        <div class="col-12">
          <label class="form-label">Weekend (check days off)</label>
          <div id="weekendChecks" class="row g-2"></div>
        </div>

        <div class="col-12">
          <label class="form-label">Holidays (YYYY-MM-DD, one per line)</label>
          <textarea id="holidayText" rows="5" class="form-control"></textarea>
          <div class="d-flex gap-2 mt-2">
            <input id="holidayAdd" class="form-control" placeholder="YYYY-MM-DD" style="max-width:200px;">
            <button id="holidayAddBtn" class="btn btn-outline-secondary">Add</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="settingsReset" class="btn btn-outline-danger">Reset Defaults</button>
        <button id="settingsSave" class="btn btn-primary">Save</button>
      </div>
    </div></div>
  </div>

  <!-- Correction Modal -->
  <div class="modal fade" id="corrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Fix missing punch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-12"><label class="form-label">Employee</label><input id="corrEmp" class="form-control" readonly></div>
          <div class="col-12"><label class="form-label">Date</label><input id="corrDate" class="form-control" readonly></div>
          <div class="col-12" id="grpIn"><label class="form-label">Sign-In (HH:mm or HH:mm:ss)</label><input id="corrIn" class="form-control" placeholder="08:00"></div>
          <div class="col-12" id="grpOut"><label class="form-label">Sign-Out (HH:mm or HH:mm:ss)</label><input id="corrOut" class="form-control" placeholder="16:45"></div>
          <div class="col-12 d-flex align-items-center gap-2 mt-2">
            <input id="corrApprovalPass" type="password" class="form-control" placeholder="Approval password to save immediately (optional)">
            <span class="badge bg-secondary" id="approvalModeBadge">Queue</span>
          </div>
        </div>
        <div id="corrAlert" class="alert alert-danger d-none mt-3"></div>
        <div class="form-text mt-2">Writes back to Google Sheets or queues for approval (based on Settings).</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="corrSave" class="btn btn-primary">Apply</button>
      </div>
    </div></div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.1/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
/** ============== CONFIG ============== **/
const PUBLISHED_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=390845393&single=true&output=csv";
const REFRESH_MS = 300_000; // 5 min
const TZ = "Asia/Beirut";
const BUILD = "v3-approval+cohorts+overtime+ics+5min";

/** Writeback & Queue API **/
const WRITEBACK = {
  url: 'https://script.google.com/macros/s/AKfycbx0X1tu8FU4tfo65KDpCQyT2UVSWI8FQiNckE1BO71Ynhklrw18orUehMAHpQ3-Y2OPnw/exec',
  token: '3f529bb0b4ea4de2b3f38b7f65d9a2dc9fcd7e9a2e6c4acfb3fbf05f9e2f8c11'
};
async function sendWriteback(kind, payload){
  const qs = new URLSearchParams({ token: WRITEBACK.token, kind });
  const res = await fetch(`${WRITEBACK.url}?${qs.toString()}`, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({
      kind,
      employee: payload.Employee,
      date: payload.Date,
      time: (kind==='IN' ? payload.In : payload.Out)
    }),
    cache: 'no-store'
  });
  const txt = await res.text(); let j={}; try{ j=JSON.parse(txt);}catch{}
  if (!j.ok) throw new Error(j.error || 'writeback_failed');
  return j;
}
async function sendQueue(payload, reason=''){
  const qs = new URLSearchParams({ token: WRITEBACK.token, action: 'queue' });
  const res = await fetch(`${WRITEBACK.url}?${qs.toString()}`, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({
      employee: payload.Employee,
      date: payload.Date,
      in: payload.In || '',
      out: payload.Out || '',
      reason: reason || 'Missing punch fix'
    }),
    cache: 'no-store'
  });
  const txt = await res.text(); let j={}; try{ j=JSON.parse(txt);}catch{}
  if (!j.ok) throw new Error(j.error || 'queue_failed');
  return j;
}

/** Defaults & persisted settings **/
const DEFAULT_POLICY = {
  dayStart:'08:00', dayEnd:'16:45', graceMin:20, earlyGraceMin:0, breakMin:30,
  workdayHours:8.75, useCalcTarget:false, recompute:true,
  markAbsentOnWorkingDay:true, halfDayThresholdHours:4, halfDayUseNet:true,
  requireApproval:false, approvalPass:'12345678'
};
const DEFAULT_WEEKEND = [6,7]; // 1=Mon..7=Sun
const DEFAULT_HOLIDAYS = [];
const DEFAULT_PREFS = { hoursFormat:'hms' };
const LS_KEYS = {
  policy:'attendance_policy_v2', weekend:'attendance_weekend_v1',
  holidays:'attendance_holidays_v1', prefs:'attendance_prefs_v1', csv:'attendance_csv_v1'
};

function loadLS(key, def){ try{ const v = JSON.parse(localStorage.getItem(key)||"null"); return v ?? def; } catch{ return def; } }
function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let POLICY = loadLS(LS_KEYS.policy, DEFAULT_POLICY);
let WEEKEND = loadLS(LS_KEYS.weekend, DEFAULT_WEEKEND);
let HOLIDAYS = loadLS(LS_KEYS.holidays, DEFAULT_HOLIDAYS);
let PREFS = loadLS(LS_KEYS.prefs, DEFAULT_PREFS);
let HOLIDAYS_SET = new Set(HOLIDAYS);

function candidateURLs(){ const t=Date.now(); return [`${PUBLISHED_CSV}&cachebust=${t}`]; }

/** ============== STATE ============== **/
let CANON = [];
let DT = null, chartByEmp=null, chartOverTime=null, chartOverUnder=null, chartLateEarly=null, empChart=null;
let lastFiltered = [];
const { DateTime } = luxon;

/** ============== THEME ============== **/
function applyTheme(mode){
  document.body.classList.toggle('dark-mode', mode==='dark');
  localStorage.setItem('theme', mode);
  document.getElementById('themeIcon').className = (mode==='dark') ? 'bi bi-brightness-high' : 'bi bi-moon-stars';
  renderHeatmap();
}
function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved) applyTheme(saved); else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
}

/** ============== HELPERS ============== **/
function hmsFromHours(hours){
  if(!isFinite(hours)) return '';
  const sign = hours<0 ? '-' : '';
  const total = Math.abs(hours);
  const h = Math.floor(total);
  const m = Math.round((total - h) * 60);
  return `${sign}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function fmtHours(hours){ return PREFS.hoursFormat==='decimal' ? (isFinite(hours)? hours.toFixed(2): '') : hmsFromHours(hours); }
function normalizeHeaders(r){ const o={}; for(const k in r){ if(!k) continue; o[k.trim().toLowerCase()] = r[k]; } return o; }
function toISODate(s){
  if(!s) return "";
  const x = String(s).trim(); if(!x) return "";
  const candidates = [
    DateTime.fromFormat(x,'d/M/yyyy'), DateTime.fromFormat(x,'d/M/yy'),
    DateTime.fromFormat(x,'yyyy-MM-dd'), DateTime.fromFormat(x,'d-M-yyyy'),
    DateTime.fromFormat(x,'M/d/yyyy'), DateTime.fromISO(x)
  ];
  for(const t of candidates){ if(t.isValid) return t.toISODate(); }
  const d = new Date(x); return isNaN(d)? "" : d.toISOString().slice(0,10);
}
function parsePunchWithDate(dateISO,val){
  if(!dateISO||!val) return null;
  const s = String(val).trim(); if(!s || s==='-') return null;
  const a=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd H:mm'); if(a.isValid) return a;
  const b=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd H:mm:ss'); if(b.isValid) return b;
  const c=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd h:mm a'); if(c.isValid) return c;
  const iso=DateTime.fromISO(s); if(iso.isValid) return iso;
  const d=new Date(`${dateISO}T${s.length===5?s+':00':s}`); return isNaN(d)?null:DateTime.fromJSDate(d);
}
function isWorkingDay(isoDate){
  if(!isoDate) return false;
  if(HOLIDAYS_SET.has(isoDate)) return false;
  const wd = DateTime.fromISO(isoDate).weekday; // 1=Mon..7=Sun
  return !WEEKEND.includes(wd);
}

/** ============== STATUS & METRICS ============== **/
function computeStatusByPolicy(dateISO, signIn, signOut){
  if(!dateISO) return '';
  const start = DateTime.fromISO(`${dateISO}T${POLICY.dayStart}:00`);
  const end   = DateTime.fromISO(`${dateISO}T${POLICY.dayEnd}:00`);
  const inDT  = signIn? parsePunchWithDate(dateISO, signIn) : null;
  const outDT = signOut? parsePunchWithDate(dateISO, signOut) : null;

  if(POLICY.markAbsentOnWorkingDay && isWorkingDay(dateISO) && !inDT && !outDT) return 'Absent';
  if((!inDT && outDT) || (inDT && !outDT)) return 'Need Correction';
  if(!inDT || !outDT) return '';

  let hours = outDT.diff(inDT,'hours').hours;
  if(POLICY.halfDayUseNet) hours -= (POLICY.breakMin/60);
  if(POLICY.halfDayThresholdHours>0 && hours>0 && hours < POLICY.halfDayThresholdHours) return 'Half Day';

  const lateMin = inDT.diff(start,'minutes').minutes;
  const earlyMin = end.diff(outDT,'minutes').minutes;
  const late = lateMin > POLICY.graceMin;
  const leftEarly = earlyMin > POLICY.earlyGraceMin;

  if(late && leftEarly) return 'Late & Left Early';
  if(late) return 'Late';
  if(leftEarly) return 'Left Early';
  return 'Present';
}
function explainStatus(dateISO, signIn, signOut){
  const start = DateTime.fromISO(`${dateISO}T${POLICY.dayStart}:00`);
  const end   = DateTime.fromISO(`${dateISO}T${POLICY.dayEnd}:00`);
  const inDT  = signIn? parsePunchWithDate(dateISO, signIn) : null;
  const outDT = signOut? parsePunchWithDate(dateISO, signOut) : null;
  const s = computeStatusByPolicy(dateISO, signIn, signOut);
  if(s==='Absent') return 'No punches on a working day';
  if(s==='Need Correction') return (!inDT && outDT) ? 'Missing Sign-In' : (inDT && !outDT) ? 'Missing Sign-Out' : 'Missing punch';
  if(!inDT || !outDT) return 'Missing one punch';
  let lateMin  = Math.max(0, Math.round(inDT.diff(start,'minutes').minutes));
  let earlyMin = Math.max(0, Math.round(end.diff(outDT,'minutes').minutes));
  let hours = outDT.diff(inDT,'hours').hours;
  let net   = POLICY.halfDayUseNet ? (hours - POLICY.breakMin/60) : hours;
  const parts = [];
  parts.push(`Worked ${fmtHours(hours)} (net ${fmtHours(net)})`);
  if(lateMin>0)  parts.push(`Late by ${lateMin}m (grace ${POLICY.graceMin}m)`);
  if(earlyMin>0) parts.push(`Left early by ${earlyMin}m (grace ${POLICY.earlyGraceMin}m)`);
  if(net < POLICY.halfDayThresholdHours) parts.push(`Under half-day threshold ${POLICY.halfDayThresholdHours}h`);
  return parts.join(' ‚Ä¢ ');
}
function lateEarlyMinutes(dateISO, signIn, signOut){
  const start = DateTime.fromISO(`${dateISO}T${POLICY.dayStart}:00`);
  const end   = DateTime.fromISO(`${dateISO}T${POLICY.dayEnd}:00`);
  const inDT  = signIn? parsePunchWithDate(dateISO, signIn) : null;
  const outDT = signOut? parsePunchWithDate(dateISO, signOut) : null;
  let lateM=0, earlyM=0;
  if(inDT)  lateM  = Math.max(0, Math.round(inDT.diff(start,'minutes').minutes));
  if(outDT) earlyM = Math.max(0, Math.round(end.diff(outDT,'minutes').minutes));
  return {lateM, earlyM};
}

/** ============== MAP ROW ============== **/
function mapRow(r){
  const month = r['month name'] || r['month'] || '';
  const dateISO = toISODate(r['date'] || r['day'] || '');
  const siRaw = r['first in'] || r['sign in'] || r['in'] || '';
  const soRaw = r['last out']  || r['sign out'] || r['out'] || '';
  const hoursRaw = r['hours'];
  let total = !isNaN(parseFloat(hoursRaw)) ? parseFloat(hoursRaw) : NaN;
  if(!isFinite(total)){
    const si=dateISO?parsePunchWithDate(dateISO,siRaw):null;
    const so=dateISO?parsePunchWithDate(dateISO,soRaw):null;
    total = (si&&so)? so.diff(si,'hours').hours : 0;
  }
  const statusCSV = r['status'] || '';
  return {
    month: month || (dateISO?DateTime.fromISO(dateISO).toFormat('LLLL'):''), date: dateISO,
    employee: r['employee name']||r['employee']||r['name']||'',
    signIn: siRaw||'', signOut: soRaw||'', totalHours: total, status: statusCSV
  };
}

/** ============== KPIs & CHARTS ============== **/
function aggregateBy(data, keyFn, valFn){
  const m=new Map(); for(const r of data){ const k=keyFn(r); const v=valFn(r)||0; m.set(k,(m.get(k)||0)+v);} return Object.fromEntries(m);
}
function monthKey(iso){ return (iso||'').slice(0,7); }

function computeCohorts(data){
  const months = Array.from(new Set(data.map(r=>monthKey(r.date)).filter(Boolean))).sort();
  const curr = months.slice(-1)[0]; const prev = months.slice(-2)[0];
  function metrics(rows){
    const wd = new Set(rows.map(d=>d.date).filter(isWorkingDay)).size;
    const hours = rows.reduce((a,b)=> a+(isFinite(b.totalHours)?b.totalHours:0),0);
    const statusCounts = rows.reduce((acc,r)=>{ const s=computeStatusByPolicy(r.date,r.signIn,r.signOut); acc[s]=(acc[s]||0)+1; return acc; },{});
    const ontime = (rows.length? Math.round(100*(statusCounts['Present']||0)/rows.length) : 0);
    return {wd, hours, ontime};
  }
  const rowsCurr = data.filter(r=> monthKey(r.date)===curr);
  const rowsPrev = data.filter(r=> monthKey(r.date)===prev);
  return {curr, prev, mc:metrics(rowsCurr), mp:metrics(rowsPrev)};
}
function arrowDelta(curr, prev, suffix=''){
  if(prev===0 || prev===undefined || isNaN(prev)) return '';
  const diff = curr - prev; const sign = diff>0 ? '‚ñ≤' : diff<0 ? '‚ñº' : '‚Ä¢';
  const pct = prev!==0 ? Math.round((diff/prev)*100) : 0;
  return `${sign} ${pct}%${suffix}`;
}

function renderKPIs(data){
  const uniqueWorkingDays = new Set(data.map(d=>d.date).filter(isWorkingDay)).size;
  const hours = data.reduce((a,b)=> a + (isFinite(b.totalHours)? b.totalHours : 0), 0);
  const counts = data.reduce((acc,r)=>{
    const s = computeStatusByPolicy(r.date,r.signIn,r.signOut);
    acc.abs += (s==='Absent');
    acc.half += (s==='Half Day');
    if(s==='Present') acc.present++;
    acc.total++;
    const m = lateEarlyMinutes(r.date,r.signIn,r.signOut);
    acc.lateM += m.lateM; acc.earlyM += m.earlyM;
    return acc;
  }, {abs:0,half:0, present:0, total:0, lateM:0, earlyM:0});
  const ontimeRate = counts.total? Math.round(100*counts.present/counts.total) : 0;

  document.getElementById('kpiDays').textContent  = uniqueWorkingDays.toLocaleString();
  document.getElementById('kpiHours').textContent = fmtHours(hours);
  document.getElementById('kpiAbsent').textContent = counts.abs;
  document.getElementById('kpiHalf').textContent = counts.half;
  document.getElementById('kpiOntime').textContent = `${ontimeRate}%`;
  document.getElementById('kpiLateM').textContent = counts.lateM;
  document.getElementById('kpiEarlyM').textContent = counts.earlyM;

  const targetPerDay = POLICY.useCalcTarget ?
    (DateTime.fromFormat(POLICY.dayEnd,'H:mm').diff(DateTime.fromFormat(POLICY.dayStart,'H:mm'),'hours').hours - (POLICY.breakMin/60)) :
    POLICY.workdayHours;
  const expected = uniqueWorkingDays * targetPerDay;
  const delta = hours - expected;
  const emoji = delta >= 0 ? '‚úÖ' : '‚ö†Ô∏è';
  document.getElementById('kpiVar').textContent = `${emoji} ${delta>=0?'+':''}${fmtHours(delta)}`;
  document.getElementById('kpiDaysNote').textContent = `Excludes weekends (${WEEKEND.join(',')}) and ${HOLIDAYS_SET.size} holidays`;
  document.getElementById('kpiUpdated').textContent = DateTime.now().setZone(TZ).toFormat('yyyy-LL-dd HH:mm:ss ZZZZ');

  const cohorts = computeCohorts(data);
  if(cohorts.prev){
    document.getElementById('kpiHoursVar').textContent = arrowDelta(cohorts.mc.hours, cohorts.mp.hours);
    document.getElementById('kpiOntimeVar').textContent = arrowDelta(cohorts.mc.ontime, cohorts.mp.ontime, '');
  } else {
    document.getElementById('kpiHoursVar').textContent = '';
    document.getElementById('kpiOntimeVar').textContent = '';
  }

  document.getElementById('stickyTotals').textContent =
    `Rows: ${data.length} ‚Ä¢ Hours: ${fmtHours(hours)} ‚Ä¢ On-time: ${ontimeRate}%`;

  igniteSpark('sparkDays', uniqueWorkingDays || 1);
  igniteSpark('sparkHours', Math.round(hours) || 1);
}

function renderCharts(data){
  const byEmp = aggregateBy(data, r=>r.employee, r=>r.totalHours);
  const empLabels = Object.keys(byEmp).sort((a,b)=> byEmp[b]-byEmp[a]).slice(0,20);
  const empData = empLabels.map(k=> byEmp[k]);

  const byDate = aggregateBy(data, r=>r.date, r=>r.totalHours);
  const dateLabels = Object.keys(byDate).sort();
  const dateData = dateLabels.map(k=> byDate[k]);

  const perEmpDays = aggregateBy(data, r=>r.employee, r=> isWorkingDay(r.date)?1:0);
  const targetPerDay = POLICY.useCalcTarget ?
    (DateTime.fromFormat(POLICY.dayEnd,'H:mm').diff(DateTime.fromFormat(POLICY.dayStart,'H:mm'),'hours').hours - (POLICY.breakMin/60)) :
    POLICY.workdayHours;
  const over = [], under = [];
  empLabels.forEach(emp=>{
    const exp = (perEmpDays[emp]||0)*targetPerDay;
    const actual = byEmp[emp]||0;
    const d = actual-exp;
    over.push(Math.max(0,d));
    under.push(Math.max(0,-d));
  });

  const lateMap={}, earlyMap={};
  data.forEach(r=>{
    const {lateM, earlyM} = lateEarlyMinutes(r.date,r.signIn,r.signOut);
    lateMap[r.employee]=(lateMap[r.employee]||0)+lateM;
    earlyMap[r.employee]=(earlyMap[r.employee]||0)+earlyM;
  });
  const leLabels = Object.keys(lateMap).sort((a,b)=> (lateMap[b]+(earlyMap[b]||0))-(lateMap[a]+(earlyMap[a]||0))).slice(0,20);
  const lateVals = leLabels.map(e=> lateMap[e]||0);
  const earlyVals= leLabels.map(e=> earlyMap[e]||0);

  chartByEmp && chartByEmp.destroy();
  chartOverTime && chartOverTime.destroy();
  chartOverUnder && chartOverUnder.destroy();
  chartLateEarly && chartLateEarly.destroy();

  chartByEmp = new Chart(document.getElementById('chartByEmp'), {
    type:'bar', data:{ labels:empLabels, datasets:[{ label:'Hours', data:empData }] },
    options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#64748b'}}, y:{ ticks:{ color:'#64748b'}}}}
  });
  chartOverTime = new Chart(document.getElementById('chartOverTime'), {
    type:'line', data:{ labels:dateLabels, datasets:[{ label:'Hours', data:dateData, tension:.3, fill:false }] },
    options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#64748b'}}, y:{ ticks:{ color:'#64748b'}}}}
  });
  chartOverUnder = new Chart(document.getElementById('chartOverUnder'), {
    type:'bar',
    data:{ labels:empLabels, datasets:[
      { label:'Overtime', data:over, stack:'x' },
      { label:'Undertime', data:under, stack:'x' }
    ]},
    options:{ plugins:{ legend:{ position:'bottom' }}, scales:{ x:{ stacked:true }, y:{ stacked:true } } }
  });
  chartLateEarly = new Chart(document.getElementById('chartLateEarly'), {
    type:'bar',
    data:{ labels:leLabels, datasets:[
      { label:'Late minutes', data:lateVals },
      { label:'Early minutes', data:earlyVals }
    ]},
    options:{ plugins:{ legend:{ position:'bottom' } } }
  });

  renderHeatmap();
}
function igniteSpark(id, value){
  const c = document.getElementById(id); if(!c) return;
  const ctx = c.getContext('2d');
  const data = Array.from({length:8}, (_,i)=> Math.max(1, Math.round((i+1)*(value/10))));
  // prevent stacking on redraw
  if (c._chart) { c._chart.destroy(); }
  c._chart = new Chart(ctx, {
    type:'line',
    data:{ labels:data.map((_,i)=>i+1), datasets:[{ data, pointRadius:0, tension:.3 }]},
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false }, y:{ display:false } } }
  });
}

/** ============== TABLE ============== **/
function renderTable(data){
  lastFiltered = data;

  const rows = data.map(r => {
    const comp = computeStatusByPolicy(r.date, r.signIn, r.signOut);
    const statusDisplay = POLICY.recompute ? comp : (r.status || comp);
    return ({
      Month: r.month, Date: r.date, Employee: r.employee,
      In: r.signIn, Out: r.signOut,
      Hours: isFinite(r.totalHours)? r.totalHours : null,
      Status: statusDisplay, _raw:r
    });
  });

  const colDefs = [
    { title:'Month', data:'Month' },
    { title:'Date', data:'Date' },
    { title:'Employee', data:'Employee', render:(d)=> `<a href="#" class="emp-link" data-emp="${d}">${d}</a>` },
    { title:'First In', data:'In' },
    { title:'Last Out', data:'Out' },
    { title:'Hours', data:'Hours', className:'text-end', render:d=> d==null?'':fmtHours(d) },
    { title:'Status', data:'Status', render:function(d,type,row){
        const expl = explainStatus(row.Date,row.In,row.Out);
        const cls = `status-${(d||'').replace(/[^A-Za-z0-9]+/g,'_')}`;
        const clickable = (d === 'Need Correction') ? 'data-need-corr="1"' : '';
        return `<span class="status-badge ${cls}" ${clickable}
                 data-emp="${row.Employee}" data-date="${row.Date}"
                 data-in="${row.In||''}" data-out="${row.Out||''}"
                 data-bs-toggle="tooltip" data-bs-title="${expl.replace(/\\"/g,'&quot;')}">
                 ${d||''}${row._raw._edited ? ' <i class="bi bi-pencil ms-1"></i>' : ''}</span>`;
      }
    }
  ];

  if(!DT){
    DT = $('#attendanceTable').DataTable({
      data: rows, columns: colDefs, fixedHeader:true,
      order: [[1,'desc'],[2,'asc']], pageLength: 12,
      dom:'Bfrtip',
      buttons: [
        {extend:'csv', title:'Attendance_Export'},
        {extend:'print', title:'Attendance'},
        {extend:'copy'}
      ],
      createdRow: function(row, data){
        const s = (data.Status||'');
        if(s==='Need Correction') row.style.backgroundColor = 'rgba(245,158,11,.10)';
        else if(s==='Absent') row.style.backgroundColor = 'rgba(185,28,28,.06)';
        else if(s==='Half Day') row.style.backgroundColor = 'rgba(124,58,237,.06)';
        else if(s.includes('Left Early') && s.includes('Late')) row.style.backgroundColor = 'rgba(245,158,11,.06)';
        else if(s.includes('Left Early')) row.style.backgroundColor = 'rgba(239,68,68,.06)';
        else if(s.includes('Late')) row.style.backgroundColor = 'rgba(245,158,11,.06)';
        else if(s==='Present') row.style.backgroundColor = 'rgba(22,163,74,.06)';
      },
      drawCallback: function(){
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=> new bootstrap.Tooltip(el));
      }
    });
  } else {
    DT.clear().rows.add(rows).draw();
  }
}

/** ============== FILTERS & URL ============== **/
function populateSelect(id, values, placeholder){
  const sel=document.getElementById(id); sel.innerHTML='';
  [...new Set(values.filter(Boolean))].sort((a,b)=> a.localeCompare(b)).forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
  });
  $(`#${id}`).select2({ placeholder, allowClear:true, width:'100%' });
}
function getCriteria(){
  const sd = document.getElementById('startDate');
  const ed = document.getElementById('endDate');
  const qs = document.getElementById('quickSearch');
  return {
    employees: $('#employeeFilter').val()||[],
    months: $('#monthFilter').val()||[],
    statuses: $('#statusFilter').val()||[],
    start: sd ? sd.value : '',
    end: ed ? ed.value : '',
    q: (qs && qs.value ? qs.value : '').toLowerCase(),
    policy: document.getElementById('policySwitch').checked
  };
}
function applyFilters(){
  POLICY.recompute = document.getElementById('policySwitch').checked;
  PREFS.hoursFormat = document.getElementById('decimalSwitch').checked ? 'decimal' : 'hms';
  saveLS(LS_KEYS.prefs, PREFS);

  const c=getCriteria();
  const filtered = CANON.filter(r=>{
    const statusComp = computeStatusByPolicy(r.date, r.signIn, r.signOut);
    const statusDisp = POLICY.recompute ? statusComp : (r.status || statusComp);
    if(c.employees.length && !c.employees.includes(r.employee)) return false;
    if(c.months.length && !c.months.includes(r.month)) return false;
    if(c.statuses.length && !c.statuses.includes(statusDisp)) return false;
    if(c.start && r.date < c.start) return false;
    if(c.end && r.date > c.end) return false;
    if(c.q && !`${r.employee} ${r.date} ${statusDisp}`.toLowerCase().includes(c.q)) return false;
    return true;
  });

  renderTable(filtered);
  renderKPIs(filtered);
  renderCharts(filtered);
  updateURLFromFilters();
  computeAndRenderAnomalies(filtered);
}
function resetFilters(){
  $('#employeeFilter').val(null).trigger('change');
  $('#monthFilter').val(null).trigger('change');
  $('#statusFilter').val(null).trigger('change');
  const sd = document.getElementById('startDate');
  const ed = document.getElementById('endDate');
  const qs = document.getElementById('quickSearch');
  if (sd) sd.value = '';
  if (ed) ed.value = '';
  if (qs) qs.value = '';
  document.getElementById('policySwitch').checked = POLICY.recompute;
  document.getElementById('decimalSwitch').checked = (PREFS.hoursFormat==='decimal');
  applyFilters();
}
function updateURLFromFilters(){
  const c=getCriteria(); const p=new URLSearchParams();
  if(c.employees.length) p.set('emp', c.employees.join(','));
  if(c.months.length)    p.set('month', c.months.join(','));
  if(c.statuses.length)  p.set('status', c.statuses.join(','));
  if(c.start) p.set('start', c.start); if(c.end) p.set('end', c.end);
  if(c.q) p.set('q', c.q); if(c.policy) p.set('policy','1');
  if(PREFS.hoursFormat==='decimal') p.set('fmt','dec');
  history.replaceState(null,'',`${location.pathname}?${p.toString()}`);
}
function readFiltersFromURL(){
  const p=new URLSearchParams(location.search);
  const getList = k => p.get(k)? p.get(k).split(',').filter(Boolean) : [];
  const employees = getList('emp'), months = getList('month'), statuses=getList('status');
  const start = p.get('start')||'', end = p.get('end')||'', q = p.get('q')||'';
  const policy = p.get('policy') === '1';
  const fmt = p.get('fmt') === 'dec' ? 'decimal' : PREFS.hoursFormat;

  if(employees.length) $('#employeeFilter').val(employees).trigger('change');
  if(months.length) $('#monthFilter').val(months).trigger('change');
  if(statuses.length) $('#statusFilter').val(statuses).trigger('change');
  const sd=document.getElementById('startDate'); const ed=document.getElementById('endDate'); const qs=document.getElementById('quickSearch');
  if (sd) sd.value = start; if (ed) ed.value = end; if (qs) qs.value = q;
  document.getElementById('policySwitch').checked = policy || POLICY.recompute;
  PREFS.hoursFormat = fmt;
  document.getElementById('decimalSwitch').checked = (PREFS.hoursFormat==='decimal');
}

/** ============== HEATMAP ============== **/
function renderHeatmap(){
  const wrap=document.getElementById('heatmap'); if(!wrap) return;
  wrap.innerHTML=''; if(!lastFiltered.length) return;

  const p = document.getElementById('heatmapMonth').value;
  let monthISO = p || (lastFiltered.map(r=>r.date).sort().slice(-1)[0] || DateTime.now().toISODate()).slice(0,7);
  document.getElementById('heatmapMonth').value = monthISO;

  const first = DateTime.fromISO(monthISO+'-01'); const days=first.daysInMonth;
  const totals = {};
  lastFiltered.forEach(r => { if(r.date.startsWith(monthISO)) totals[r.date] = (totals[r.date]||0) + (isFinite(r.totalHours)? r.totalHours:0); });
  const max = Math.max(1, ...Object.values(totals));

  let startOffset = first.weekday % 7; // Sunday=0
  for(let i=0;i<startOffset;i++){ const cell=document.createElement('div'); cell.className='heat-cell'; cell.style.background='transparent'; wrap.appendChild(cell); }

  for(let d=1; d<=days; d++){
    const iso = first.set({day:d}).toISODate(); const val = totals[iso]||0;
    const ratio = Math.min(1, val/max);
    let bg = 'var(--heat-none)'; if(ratio>0){ if(ratio<0.34) bg='var(--heat-low)'; else if(ratio<0.67) bg='var(--heat-mid)'; else bg='var(--heat-high)'; }
    const cell = document.createElement('div'); cell.className='heat-cell'; cell.style.background=bg;
    cell.setAttribute('data-bs-toggle','tooltip'); cell.setAttribute('data-bs-title', `${iso}: ${fmtHours(val)} total`);
    cell.innerHTML = `<span class="d">${d}</span>`; wrap.appendChild(cell);
  }
  document.querySelectorAll('#heatmap [data-bs-toggle="tooltip"]').forEach(el=> new bootstrap.Tooltip(el));
}

/** ============== ANOMALIES ============== **/
function computeAnomalies(data){
  const missing=[];
  for(const r of data){
    const working = isWorkingDay(r.date);
    const hasIn  = !!(r.signIn && String(r.signIn).trim());
    const hasOut = !!(r.signOut && String(r.signOut).trim());
    if(working && ((hasIn && !hasOut) || (!hasIn && hasOut))) missing.push(r);
  }
  return { missing };
}
function computeAndRenderAnomalies(data){
  const a = computeAnomalies(data);
  document.getElementById('anomalyBadge').textContent = a.missing.length;
  const body = document.getElementById('anomaliesBody'); body.innerHTML='';

  const col=document.createElement('div'); col.className='col-lg-6';
  const html = [
    `<div class="glass p-3 h-100">`,
    `<div class="d-flex justify-content-between align-items-center mb-2"><strong>Missing punches (working days)</strong><span class="badge text-bg-secondary">${a.missing.length}</span></div>`,
    `<div class="table-responsive"><table class="table table-sm table-striped mb-0">`,
    `<thead><tr><th>Date</th><th>Employee</th><th>Why</th><th>Action</th></tr></thead><tbody>`
  ];
  a.missing.slice(0,150).forEach(r=>{
    const hasIn  = !!(r.signIn && String(r.signIn).trim());
    const why = hasIn ? 'Missing Sign-Out' : 'Missing Sign-In';
    html.push(`<tr>
      <td>${r.date}</td>
      <td>${r.employee}</td>
      <td>${why}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-warning fix-missing-btn"
                data-emp="${r.employee}" data-date="${r.date}"
                data-in="${r.signIn||''}" data-out="${r.signOut||''}">
          <i class="bi bi-pencil-square me-1"></i>Fix
        </button>
      </td>
    </tr>`);
  });
  if(!a.missing.length) html.push(`<tr><td colspan="4" class="text-secondary">None üéâ</td></tr>`);
  html.push(`</tbody></table></div></div>`);
  col.innerHTML = html.join(''); body.appendChild(col);
}

/** ============== EMPLOYEE DRAWER ============== **/
function openEmpDrawer(name){
  const rows = lastFiltered.filter(r=> r.employee===name).sort((a,b)=> a.date.localeCompare(b.date));
  const counts = rows.reduce((acc,r)=>{ const s=computeStatusByPolicy(r.date,r.signIn,r.signOut); acc[s]=(acc[s]||0)+1; return acc; },{});
  const totalH = rows.reduce((a,b)=> a+(isFinite(b.totalHours)?b.totalHours:0), 0);
  const ontimeRate = rows.length? Math.round(100*(counts['Present']||0)/rows.length):0;

  let lateM=0, earlyM=0;
  rows.forEach(r=>{ const m=lateEarlyMinutes(r.date,r.signIn,r.signOut); lateM+=m.lateM; earlyM+=m.earlyM; });

  document.getElementById('empDrawerLabel').textContent = name;
  document.getElementById('empMeta').innerHTML =
    `<div class="row g-2">
      <div class="col-6"><div class="chip w-100">Days: <b>${rows.length}</b></div></div>
      <div class="col-6"><div class="chip w-100">Hours: <b>${fmtHours(totalH)}</b></div></div>
      <div class="col-6"><div class="chip w-100">On-time: <b>${ontimeRate}%</b></div></div>
      <div class="col-6"><div class="chip w-100">Late: <b>${counts['Late']||0}</b> ‚Ä¢ Left Early: <b>${(counts['Left Early']||0)+(counts['Late & Left Early']||0)}</b></div></div>
      <div class="col-12"><div class="chip w-100">Late min: <b>${lateM}</b> ‚Ä¢ Early min: <b>${earlyM}</b></div></div>
    </div>`;

  const labels = rows.map(r=> r.date); const data = rows.map(r=> isFinite(r.totalHours)? r.totalHours:0);
  empChart && empChart.destroy();
  empChart = new Chart(document.getElementById('empChart'), {
    type:'line', data:{ labels, datasets:[{ label:'Hours', data, tension:.3, fill:false }]},
    options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#64748b'}}, y:{ ticks:{ color:'#64748b'}}}}
  });

  const head = `<thead><tr><th>Date</th><th>In</th><th>Out</th><th class="text-end">Hours</th><th>Status</th></tr></thead>`;
  const body = rows.slice(-60).reverse().map(r=>{
    const s=computeStatusByPolicy(r.date,r.signIn,r.signOut);
    const cls = `status-${(s||'').replace(/[^A-Za-z0-9]+/g,'_')}`;
    const expl= explainStatus(r.date,r.signIn,r.signOut);
    return `<tr>
      <td>${r.date}</td><td>${r.signIn||''}</td><td>${r.signOut||''}</td>
      <td class="text-end">${fmtHours(r.totalHours)}</td>
      <td><span class="status-badge ${cls}" data-bs-toggle="tooltip" data-bs-title="${expl.replace(/\\"/g,'&quot;')}">${s||''}</span></td>
    </tr>`;
  }).join('');
  document.getElementById('empTable').innerHTML=head+'<tbody>'+body+'</tbody>';
  document.querySelectorAll('#empTable [data-bs-toggle="tooltip"]').forEach(el=> new bootstrap.Tooltip(el));
  new bootstrap.Offcanvas('#empDrawer').show();
}

/** ============== CORRECTION FLOW (Approval-aware) ============== **/
let __corrCtx = null;
function openCorrectionModal(rowLike){
  const hasIn  = !!(rowLike.In  && String(rowLike.In).trim());
  const hasOut = !!(rowLike.Out && String(rowLike.Out).trim());
  const kind = (!hasIn && hasOut) ? 'IN' : (hasIn && !hasOut) ? 'OUT' : (!hasIn && !hasOut ? 'BOTH' : 'NONE');

  __corrCtx = { ...rowLike, kind };
  document.getElementById('corrEmp').value = rowLike.Employee;
  document.getElementById('corrDate').value = rowLike.Date;

  document.getElementById('grpIn').style.display  = (kind==='IN'||kind==='BOTH') ? '' : 'none';
  document.getElementById('grpOut').style.display = (kind==='OUT'||kind==='BOTH') ? '' : 'none';
  document.getElementById('corrIn').value=''; document.getElementById('corrOut').value='';
  document.getElementById('corrApprovalPass').value='';
  document.getElementById('approvalModeBadge').textContent = POLICY.requireApproval ? 'Queue' : 'Immediate';
  document.getElementById('corrAlert').classList.add('d-none');

  new bootstrap.Modal('#corrModal').show();
}
async function applyLocalCorrection(){
  const emp  = document.getElementById('corrEmp').value;
  const date = document.getElementById('corrDate').value;
  const inVal  = document.getElementById('corrIn').value.trim();
  const outVal = document.getElementById('corrOut').value.trim();
  const pass   = document.getElementById('corrApprovalPass').value.trim();
  const al=document.getElementById('corrAlert');

  if (__corrCtx.kind==='IN'  && !inVal){ al.textContent='Please enter Sign-In time.';  al.classList.remove('d-none'); return; }
  if (__corrCtx.kind==='OUT' && !outVal){ al.textContent='Please enter Sign-Out time.'; al.classList.remove('d-none'); return; }
  if (__corrCtx.kind==='BOTH' && (!inVal || !outVal)){ al.textContent='Please enter both times.'; al.classList.remove('d-none'); return; }

  const rowLike = { Employee: emp, Date: date, In: inVal || __corrCtx.In || '', Out: outVal || __corrCtx.Out || '' };

  try {
    const approvalNeeded = !!POLICY.requireApproval;
    const passOK = (!!pass && pass === (POLICY.approvalPass||'12345678'));
    if (approvalNeeded && !passOK) {
      await sendQueue(rowLike, 'Approval required');
    } else {
      if (__corrCtx.kind === 'IN' || __corrCtx.kind === 'BOTH')  await sendWriteback('IN',  { ...rowLike, In: inVal });
      if (__corrCtx.kind === 'OUT' || __corrCtx.kind === 'BOTH') await sendWriteback('OUT', { ...rowLike, Out: outVal });
    }
  } catch (e) {
    console.warn('Writeback/Queue failed:', e);
    al.textContent = 'Saved locally, but server update failed. Export now, or try again.';
    al.classList.remove('d-none');
  }

  let patched=false;
  for(const r of CANON){
    if(r.employee===emp && r.date===date){
      if(__corrCtx.kind==='IN'||__corrCtx.kind==='BOTH')  r.signIn  = inVal || r.signIn;
      if(__corrCtx.kind==='OUT'||__corrCtx.kind==='BOTH') r.signOut = outVal || r.signOut;
      const si=r.date?parsePunchWithDate(r.date,r.signIn):null;
      const so=r.date?parsePunchWithDate(r.date,r.signOut):null;
      r.totalHours = (si&&so)? so.diff(si,'hours').hours : 0;
      r._edited = true;
      patched=true; break;
    }
  }
  if(!patched){ al.textContent='Could not find the row in current data.'; al.classList.remove('d-none'); return; }

  bootstrap.Modal.getInstance(document.getElementById('corrModal')).hide();
  applyFilters();
}

/** ============== EXPORTS ============== **/
async function downloadFullReport(){
  const el=document.body; const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL('image/png');
  const doc={content:[{image:img,width:520}]};
  pdfMake.createPdf(doc).download('Attendance_Report.pdf');
}
function toCSV(rows){
  if(!rows.length) return '';
  const cols=Object.keys(rows[0]);
  const esc=v=> '"'+String(v??'').replace(/"/g,'""')+'"';
  const lines=[cols.join(',')].concat(rows.map(r=> cols.map(c=>esc(r[c])).join(',')));
  return lines.join('\n');
}
async function exportPack(){
  const zip = new JSZip();
  const simpleRows = lastFiltered.map(r=>({
    Month:r.month, Date:r.date, Employee:r.employee,
    FirstIn:r.signIn, LastOut:r.signOut,
    Hours:(isFinite(r.totalHours)? r.totalHours:0).toFixed(2),
    Status: computeStatusByPolicy(r.date,r.signIn,r.signOut)
  }));
  zip.file('attendance_filtered.csv', toCSV(simpleRows));

  const wb = XLSX.utils.book_new();
  const groups={}; lastFiltered.forEach(r=>{ (groups[r.employee] ||= []).push({
    Date:r.date, In:r.signIn, Out:r.signOut,
    Hours:r.totalHours, Status: computeStatusByPolicy(r.date,r.signIn,r.signOut)
  }); });
  Object.entries(groups).forEach(([emp,rows])=>{
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, emp.substring(0,31));
  });
  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  zip.file('attendance_by_employee.xlsx', wbout);

  const blob = await zip.generateAsync({type:'blob'}); saveAs(blob,'attendance_export_pack.zip');
}
async function exportMonthlyPacks(){
  const zip = new JSZip();
  const byEmpMonth = {};
  lastFiltered.forEach(r=>{
    const mk = monthKey(r.date); if(!mk) return;
    const key = `${r.employee}::${mk}`;
    (byEmpMonth[key] ||= []).push(r);
  });
  Object.entries(byEmpMonth).forEach(([key,rows])=>{
    const [emp, mk] = key.split('::');
    const folder = zip.folder(`${mk}/${emp}`);
    const csvRows = rows.map(r=>({
      Date:r.date, In:r.signIn, Out:r.signOut,
      Hours:(isFinite(r.totalHours)? r.totalHours:0).toFixed(2),
      Status: computeStatusByPolicy(r.date,r.signIn,r.signOut)
    }));
    folder.file(`${emp}_${mk}.csv`, toCSV(csvRows));
    const hours = rows.reduce((a,b)=>a+(isFinite(b.totalHours)?b.totalHours:0),0).toFixed(2);
    const present = rows.filter(r=>computeStatusByPolicy(r.date,r.signIn,r.signOut)==='Present').length;
    const half = rows.filter(r=>computeStatusByPolicy(r.date,r.signIn,r.signOut)==='Half Day').length;
    const abs  = rows.filter(r=>computeStatusByPolicy(r.date,r.signIn,r.signOut)==='Absent').length;
    folder.file(`${emp}_${mk}_summary.txt`, `Employee: ${emp}\nMonth: ${mk}\nHours: ${hours}\nPresent: ${present}\nHalf: ${half}\nAbsent: ${abs}\nGenerated: ${new Date().toISOString()}`);
  });
  const blob = await zip.generateAsync({type:'blob'}); saveAs(blob,'monthly_packs.zip');
}
function exportICS(){
  const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Attendance//ICS//EN'];
  const uidBase = Date.now();
  lastFiltered.forEach((r,i)=>{
    const s = computeStatusByPolicy(r.date,r.signIn,r.signOut);
    if(s==='Absent' || s==='Half Day'){
      const dtStart = r.date.replace(/-/g,'');
      const dtEnd   = DateTime.fromISO(r.date).plus({days:1}).toISODate().replace(/-/g,''); // exclusive end
      const uid = `${uidBase}-${i}@attendance`;
      const title = `${s} - ${r.employee}`;
      lines.push(
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${dtStart}T000000Z`,
        `DTSTART;VALUE=DATE:${dtStart}`,
        `DTEND;VALUE=DATE:${dtEnd}`,
        `SUMMARY:${title}`,
        'END:VEVENT'
      );
    }
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], {type:'text/calendar;charset=utf-8'});
  saveAs(blob, 'absences_halfdays.ics');
}

/** ============== SETTINGS UI ============== **/
function renderWeekendChecks(){
  const cont=document.getElementById('weekendChecks'); if(!cont) return; cont.innerHTML='';
  const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  for(let i=1;i<=7;i++){
    const col=document.createElement('div'); col.className='col-6 col-md-3';
    const id=`wkd_${i}`;
    col.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" id="${id}" ${(WEEKEND.includes(i)?'checked':'')}><label class="form-check-label" for="${id}">${i}. ${names[i-1]}</label></div>`;
    cont.appendChild(col);
  }
}
function openSettings(){
  document.getElementById('setStart').value = POLICY.dayStart;
  document.getElementById('setEnd').value = POLICY.dayEnd;
  document.getElementById('setGraceMin').value = POLICY.graceMin;
  document.getElementById('setEarlyGraceMin').value = POLICY.earlyGraceMin;
  document.getElementById('setBreakMin').value = POLICY.breakMin;
  document.getElementById('setWorkdayHours').value = POLICY.workdayHours;
  document.getElementById('setUseCalcTarget').checked = POLICY.useCalcTarget;
  document.getElementById('setAbsentEnabled').checked = !!POLICY.markAbsentOnWorkingDay;
  document.getElementById('setHalfDayHours').value = POLICY.halfDayThresholdHours;
  document.getElementById('setHalfDayUseNet').checked = POLICY.halfDayUseNet;
  document.getElementById('setRequireApproval').checked = !!POLICY.requireApproval;
  document.getElementById('setApprovalPass').value = POLICY.approvalPass || '12345678';
  renderWeekendChecks();
  document.getElementById('holidayText').value = HOLIDAYS.join('\n');
  new bootstrap.Modal('#settingsModal').show();
}
function saveSettings(){
  POLICY.dayStart = document.getElementById('setStart').value || DEFAULT_POLICY.dayStart;
  POLICY.dayEnd   = document.getElementById('setEnd').value || DEFAULT_POLICY.dayEnd;
  POLICY.graceMin = parseInt(document.getElementById('setGraceMin').value || DEFAULT_POLICY.graceMin);
  POLICY.earlyGraceMin = parseInt(document.getElementById('setEarlyGraceMin').value || DEFAULT_POLICY.earlyGraceMin);
  POLICY.breakMin = parseInt(document.getElementById('setBreakMin').value || DEFAULT_POLICY.breakMin);
  POLICY.workdayHours = parseFloat(document.getElementById('setWorkdayHours').value || DEFAULT_POLICY.workdayHours);
  POLICY.useCalcTarget = document.getElementById('setUseCalcTarget').checked;
  POLICY.markAbsentOnWorkingDay = document.getElementById('setAbsentEnabled').checked;
  POLICY.halfDayThresholdHours = parseFloat(document.getElementById('setHalfDayHours').value || DEFAULT_POLICY.halfDayThresholdHours);
  POLICY.halfDayUseNet = document.getElementById('setHalfDayUseNet').checked;
  POLICY.requireApproval = document.getElementById('setRequireApproval').checked;
  POLICY.approvalPass = document.getElementById('setApprovalPass').value || '12345678';
  saveLS(LS_KEYS.policy, POLICY);

  const wk=[]; for(let i=1;i<=7;i++) if(document.getElementById(`wkd_${i}`)?.checked) wk.push(i);
  if(wk.length){ WEEKEND = wk; saveLS(LS_KEYS.weekend, WEEKEND); }

  const lines = document.getElementById('holidayText').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  HOLIDAYS = Array.from(new Set(lines)); HOLIDAYS_SET = new Set(HOLIDAYS); saveLS(LS_KEYS.holidays, HOLIDAYS);

  applyFilters();
}

/** ============== IO & LOAD ============== **/
async function fetchCSVNetwork(){
  let lastErr;
  for(const url of candidateURLs()){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }catch(e){ lastErr=e; console.warn('Fetch failed', url, e); }
  }
  throw lastErr || new Error('All endpoints failed');
}
async function fetchCSV(){
  const cached = localStorage.getItem(LS_KEYS.csv);
  if(cached){
    setTimeout(()=>refreshFromNetwork(true), 0);
    return cached;
  }
  return await refreshFromNetwork(false);
}
async function refreshFromNetwork(silent){
  try{
    const txt = await fetchCSVNetwork();
    const old = localStorage.getItem(LS_KEYS.csv);
    if(!old || old !== txt){ localStorage.setItem(LS_KEYS.csv, txt); if(silent) parseAndRender(txt); }
    return txt;
  }catch(e){ if(!silent) throw e; return null; }
}
function parseAndRender(csv){
  const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
  CANON = parsed.data.map(r => mapRow(normalizeHeaders(r))).filter(r => r.employee && r.date);

  populateSelect('employeeFilter', CANON.map(r=>r.employee), 'Employees');
  populateSelect('monthFilter', CANON.map(r=>r.month), 'Months');
  populateSelect('statusFilter', CANON.map(r=> computeStatusByPolicy(r.date,r.signIn,r.signOut)), 'Statuses');

  readFiltersFromURL(); applyFilters();

  const lastDate = CANON.map(r=>r.date).sort().slice(-1)[0];
  const mo = lastDate? lastDate.slice(0,7) : DateTime.now().toISODate().slice(0,7);
  document.getElementById('heatmapMonth').value = mo;
  renderHeatmap();
}
async function loadData(){
  try{
    const csv = await fetchCSV(); parseAndRender(csv);
    const refreshed = await refreshFromNetwork(true);
    document.getElementById('lastSync').textContent = "Last auto-refresh: " + new Date().toLocaleTimeString();
    return refreshed;
  } catch(e){ console.error(e); alert('Failed to load data: '+e.message); }
}

/** ============== EVENTS ============== **/
document.getElementById('themeBtn').addEventListener('click', ()=>{ const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; applyTheme(next); });
document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('settingsSave').addEventListener('click', saveSettings);
document.getElementById('settingsReset').addEventListener('click', ()=>{ POLICY={...DEFAULT_POLICY}; saveLS(LS_KEYS.policy,POLICY); WEEKEND=[...DEFAULT_WEEKEND]; saveLS(LS_KEYS.weekend,WEEKEND); HOLIDAYS=[...DEFAULT_HOLIDAYS]; HOLIDAYS_SET=new Set(HOLIDAYS); saveLS(LS_KEYS.holidays,HOLIDAYS); openSettings(); });
document.getElementById('holidayAddBtn').addEventListener('click', ()=>{ const inp=document.getElementById('holidayAdd'); if(!inp) return; const v=inp.value.trim(); if(!v) return; const ta=document.getElementById('holidayText'); const lines=ta.value.split(/\n+/).filter(Boolean); if(!lines.includes(v)) lines.push(v); ta.value=lines.join('\n'); inp.value=''; });

document.getElementById('pdfBtn').addEventListener('click', downloadFullReport);
document.getElementById('packBtn').addEventListener('click', exportPack);
document.getElementById('packsMonthlyBtn').addEventListener('click', exportMonthlyPacks);
document.getElementById('icsBtn').addEventListener('click', exportICS);
document.getElementById('applyBtn').addEventListener('click', applyFilters);
document.getElementById('resetBtn').addEventListener('click', resetFilters);
document.getElementById('refreshBtn').addEventListener('click', loadData);
document.getElementById('quickSearch').addEventListener('input', applyFilters);
document.getElementById('heatmapMonth').addEventListener('change', renderHeatmap);
document.getElementById('corrSave').addEventListener('click', applyLocalCorrection);

// Links
document.addEventListener('click', (e)=>{
  const a=e.target.closest('.emp-link'); if(a){ e.preventDefault(); openEmpDrawer(a.dataset.emp); }
});
document.addEventListener('click', (e)=>{
  const el=e.target.closest('.status-badge[data-need-corr="1"]'); if(!el) return;
  e.preventDefault();
  openCorrectionModal({ Employee:el.dataset.emp, Date:el.dataset.date, In:el.dataset.in||'', Out:el.dataset.out||'', Status:'Need Correction' });
});
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('.fix-missing-btn'); if(!btn) return;
  e.preventDefault();
  openCorrectionModal({ Employee:btn.dataset.emp, Date:btn.dataset.date, In:btn.dataset.in||'', Out:btn.dataset.out||'', Status:'Need Correction' });
});

// periodic refresh (5 min)
setTimeout(()=> loadData(), Math.random()*60_000); // stagger first load
setInterval(()=>{ if(document.visibilityState==='visible') loadData(); }, REFRESH_MS);

// boot
initTheme();
document.getElementById('buildStamp').textContent = `${BUILD} ‚Ä¢ ${DateTime.now().setZone(TZ).toFormat('yyyy-LL-dd HH:mm')}`;

/** ============== INLINE TESTS (console) ============== **/
(function tests(){
  function ok(n,cond){ (cond?console.log:console.error)(`[TEST] ${n}: ${cond?'OK':'FAIL'}`); }
  ok('cachebust URL', /cachebust=\d+/.test(candidateURLs()[0]||''));
  ok('policy.persisted', !!POLICY && typeof POLICY.graceMin==='number');
  ok('approval default pass', (POLICY.approvalPass||'12345678').length>=4);
})();
  </script>
</body>
</html>
