<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance & Leave Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables + Buttons -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <!-- pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <!-- Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body.dark-mode { background: #181a1f; color: #eee; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .filter-bar { position: sticky; top: 0; z-index: 10; background: inherit; padding: 10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
    .leave-row { background-color: #d1ecf1 !important; }
  </style>
</head>
<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📊 Attendance & Leave Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">🌙/☀️</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow filter-bar mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-lg-3">
        <label class="form-label">Employee</label>
        <select id="employeeFilter" multiple></select>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control" />
      </div>
      <div class="col-lg-3">
        <label class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control" />
      </div>
      <div class="col-lg-3">
        <label class="form-label">Quick Search</label>
        <input type="text" id="quickSearch" class="form-control" placeholder="Search..." />
      </div>
      <div class="col-12 text-end mt-3">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Days Count</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- Attendance Table -->
  <div class="card shadow mb-4"><div class="card-body">
    <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
  </div></div>

  <!-- Charts -->
  <div class="row">
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
    <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
  </div>

  <!-- Settings -->
  <div class="card shadow my-4"><div class="card-body row g-3">
    <h5>⚙️ Settings</h5>
    <div class="col-md-3"><label class="form-label">Late After (HH:MM)</label><input type="time" id="lateThreshold" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Early Leave Before (HH:MM)</label><input type="time" id="earlyThreshold" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Half-day Max Hours</label><input type="number" id="halfDayHours" class="form-control" /></div>
    <div class="col-md-3"><label class="form-label">Overtime Min Hours</label><input type="number" id="overtimeHours" class="form-control" /></div>
  </div></div>

  <!-- Holiday Manager -->
  <div class="card shadow mb-4"><div class="card-body">
    <h5>📅 Holiday Manager</h5>
    <div class="input-group mb-3">
      <input type="date" id="holidayDate" class="form-control" />
      <input type="text" id="holidayName" class="form-control" placeholder="Holiday Name (optional)" />
      <button class="btn btn-primary" onclick="addHoliday()">Add</button>
    </div>
    <ul id="holidayList" class="list-group"></ul>
  </div></div>

  <!-- Leave Manager -->
  <div class="card shadow mb-4"><div class="card-body">
    <h5>🗓 Leave Manager</h5>
    <div class="input-group mb-3">
      <input type="date" id="leaveDate" class="form-control" />
      <select id="leaveEmployee" class="form-control"></select>
      <select id="leaveType" class="form-control"><option value="AL">Annual Leave</option><option value="SL">Sick Leave</option></select>
      <select id="leaveDuration" class="form-control"><option value="1">Full Day</option><option value="0.5">Half Day</option></select>
      <button class="btn btn-primary" onclick="addLeave()">Add Leave</button>
    </div>
    <ul id="leaveList" class="list-group"></ul>
  </div></div>

  <!-- Balance Manager -->
  <div class="card shadow mb-4"><div class="card-body">
    <h5>🧾 Balance Manager</h5>
    <table class="table table-sm"><thead>
      <tr><th>Employee</th><th>Annual Leave (AL)</th><th>Sick Leave (SL)</th><th>Action</th></tr>
    </thead><tbody id="balanceTableBody"></tbody></table>
  </div></div>
</div>

<script>
/* ----------------------------------------------------------
 * CONFIG
 * ---------------------------------------------------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbzb6v9Jpy45naxtDNugAflHxXXnrgGXn-v3uvOSqght/dev";
const API_TOKEN = "a9fj32klsdfj0932LKJSDF90wef9";

let CANON = [];          // AttendanceSummary (expanded)
let HOLIDAYS = [];
let LEAVES = [];
let BALANCES = [];
let SETTINGS = [];
let DT = null;

// Charts
let barChartHandle = null;
let pieChartHandle = null;
let lineChartHandle = null;

/* ----------------------------------------------------------
 * UTILITIES
 * ---------------------------------------------------------- */
function toggleDark() { document.body.classList.toggle("dark-mode"); }
function normalizeDate(d) {
  if (!d) return "";
  const s = String(d).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if (s.includes("/")) {
    const [dd, mm, yy] = s.split("/");
    return `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
  }
  return "";
}

/* ----------------------------------------------------------
 * API SYNC
 * ---------------------------------------------------------- */
async function fetchData() {
  const res = await fetch(`${API_URL}?token=${API_TOKEN}`);
  const data = await res.json();
  if (!data.ok) { alert("API error: " + data.error); return; }
  HOLIDAYS = data.holidays || [];
  LEAVES = data.leaves || [];
  BALANCES = data.balances || [];
  SETTINGS = data.settings || [];
  CANON = data.attendance || [];
  populateEmployeeFilter();
  renderHolidayList();
  renderLeaveList();
  renderBalanceTable();
  applyFilters();
}
async function pushData() {
  const body = { holidays: HOLIDAYS, leaves: LEAVES, balances: BALANCES, settings: SETTINGS, attendance: CANON };
  await fetch(`${API_URL}?token=${API_TOKEN}`, { method: "POST", body: JSON.stringify(body) });
}

/* ----------------------------------------------------------
 * FILTERS
 * ---------------------------------------------------------- */
function getCriteria() {
  return {
    employees: $("#employeeFilter").val() || [],
    start: document.getElementById("startDate").value,
    end: document.getElementById("endDate").value,
    q: (document.getElementById("quickSearch").value || "").toLowerCase()
  };
}
function applyFilters() {
  const c = getCriteria();
  const filtered = CANON.filter(r => {
    if (c.employees.length && !c.employees.includes(r.employee)) return false;
    if (c.start && r.date < c.start) return false;
    if (c.end && r.date > c.end) return false;
    if (c.q && !`${r.employee} ${r.date}`.toLowerCase().includes(c.q)) return false;
    return true;
  });
  renderTable(filtered);
}
function resetFilters() {
  $("#employeeFilter").val(null).trigger("change");
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  document.getElementById("quickSearch").value = "";
  applyFilters();
}

/* ----------------------------------------------------------
 * TABLE + KPIs
 * ---------------------------------------------------------- */
function renderTable(data) {
  const rows = data.map(r => [ r.date || "", r.employee || "", r.signIn || "", r.signOut || "", isFinite(r.totalHours) ? r.totalHours.toFixed(2) : "", "" ]);
  if (!DT) {
    DT = $("#attendanceTable").DataTable({
      data: rows,
      columns: [
        { title: "Date" }, { title: "Employee" }, { title: "Sign In" },
        { title: "Sign Out" }, { title: "Total Hours" }, { title: "Status" }
      ],
      dom: "Bfrtip", buttons: ["csv", "excel", "pdf", "print"], pageLength: 10
    });
  } else { DT.clear().rows.add(rows).draw(); }

  // KPIs
  let sum = 0; const days = new Set();
  data.forEach(r => { if (r.totalHours) sum += parseFloat(r.totalHours); if (r.date) days.add(r.date); });
  document.getElementById("totalHours").textContent = sum.toFixed(2);
  document.getElementById("avgHours").textContent = (days.size ? sum/days.size : 0).toFixed(2);
  document.getElementById("daysCount").textContent = days.size;
  document.getElementById("lateCount").textContent = 0;
  document.getElementById("earlyCount").textContent = 0;
  document.getElementById("absentCount").textContent = 0;
  renderCharts(data);
}

/* ----------------------------------------------------------
 * CHARTS
 * ---------------------------------------------------------- */
function renderCharts(data) {
  if (barChartHandle) barChartHandle.destroy();
  if (pieChartHandle) pieChartHandle.destroy();
  if (lineChartHandle) lineChartHandle.destroy();
  const byDate = {}, byEmp = {};
  data.forEach(r => {
    if (r.date) byDate[r.date] = (byDate[r.date]||0) + (parseFloat(r.totalHours)||0);
    if (r.employee) byEmp[r.employee] = (byEmp[r.employee]||0) + (parseFloat(r.totalHours)||0);
  });
  barChartHandle = new Chart(document.getElementById("barChart"), { type: "bar", data: { labels: Object.keys(byDate), datasets:[{label:"Hours", data:Object.values(byDate), backgroundColor:"#0d6efd"}]} });
  pieChartHandle = new Chart(document.getElementById("pieChart"), { type: "pie", data: { labels: Object.keys(byEmp), datasets:[{data:Object.values(byEmp), backgroundColor:["#0d6efd","#00c9a7","#ff7e5f","#6f42c1","#ffc107","#20c997","#fd7e14"]}]} });
  lineChartHandle = new Chart(document.getElementById("lineChart"), { type: "line", data: { labels: Object.keys(byDate), datasets:[{label:"Hours", data:Object.values(byDate), borderColor:"#28a745", fill:false}]} });
}

/* ----------------------------------------------------------
 * HOLIDAY MANAGER
 * ---------------------------------------------------------- */
function renderHolidayList() {
  const list=document.getElementById("holidayList"); list.innerHTML="";
  HOLIDAYS.forEach((h,i)=>{ const li=document.createElement("li"); li.className="list-group-item d-flex justify-content-between align-items-center"; li.innerHTML=`<span>${h.date} - ${h.name||""}</span><button class="btn btn-sm btn-danger" onclick="removeHoliday(${i})">Remove</button>`; list.appendChild(li); });
}
function addHoliday() {
  const date=document.getElementById("holidayDate").value; const name=document.getElementById("holidayName").value;
  if (!date) return alert("Pick a date");
  HOLIDAYS.push({date,name}); renderHolidayList(); pushData();
}
function removeHoliday(i) { HOLIDAYS.splice(i,1); renderHolidayList(); pushData(); }

/* ----------------------------------------------------------
 * LEAVE MANAGER (with balance update)
 * ---------------------------------------------------------- */
function renderLeaveList() {
  const list=document.getElementById("leaveList"); list.innerHTML="";
  LEAVES.forEach((l,i)=>{ const li=document.createElement("li"); li.className="list-group-item d-flex justify-content-between align-items-center"; li.innerHTML=`<span>${l.date} - ${l.employee} (${l.type}, ${l.duration})</span><button class="btn btn-sm btn-danger" onclick="removeLeave(${i})">Remove</button>`; list.appendChild(li); });
}
function addLeave() {
  const date=document.getElementById("leaveDate").value; const employee=document.getElementById("leaveEmployee").value; const type=document.getElementById("leaveType").value; const duration=parseFloat(document.getElementById("leaveDuration").value);
  if (!date || !employee) return alert("Fill fields");
  LEAVES.push({date,employee,type,duration});
  const bal=BALANCES.find(b=>b.employee===employee);
  if (bal) { if (type==="AL") bal.al=parseFloat(bal.al)-duration; if (type==="SL") bal.sl=parseFloat(bal.sl)-duration; }
  renderLeaveList(); renderBalanceTable(); pushData();
}
function removeLeave(i) {
  const leave=LEAVES[i]; LEAVES.splice(i,1);
  const bal=BALANCES.find(b=>b.employee===leave.employee);
  if (bal) { if (leave.type==="AL") bal.al=parseFloat(bal.al)+parseFloat(leave.duration); if (leave.type==="SL") bal.sl=parseFloat(bal.sl)+parseFloat(leave.duration); }
  renderLeaveList(); renderBalanceTable(); pushData();
}

/* ----------------------------------------------------------
 * BALANCE MANAGER
 * ---------------------------------------------------------- */
function renderBalanceTable() {
  const tbody=document.getElementById("balanceTableBody"); tbody.innerHTML="";
  BALANCES.forEach((b,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${b.employee}</td><td><input type="number" class="form-control form-control-sm" value="${b.al}" onchange="updateBalance(${i},'al',this.value)" /></td><td><input type="number" class="form-control form-control-sm" value="${b.sl}" onchange="updateBalance(${i},'sl',this.value)" /></td><td><button class="btn btn-sm btn-danger" onclick="removeBalance(${i})">Remove</button></td>`; tbody.appendChild(tr); });
}
function updateBalance(i,key,val){ BALANCES[i][key]=parseFloat(val)||0; pushData(); }
function removeBalance(i){ BALANCES.splice(i,1); renderBalanceTable(); pushData(); }

/* ----------------------------------------------------------
 * EMPLOYEE FILTER & LEAVE SELECT
 * ---------------------------------------------------------- */
function populateEmployeeFilter() {
  const sel=document.getElementById("employeeFilter"); sel.innerHTML="";
  const employees=[...new Set(CANON.map(r=>r.employee).filter(Boolean))].sort();
  employees.forEach(emp=>{ const opt=document.createElement("option"); opt.value=emp; opt.textContent=emp; sel.appendChild(opt); });
  $("#employeeFilter").select2({ placeholder:"Select employees...", allowClear:true, width:"100%" });
  const leaveSel=document.getElementById("leaveEmployee"); leaveSel.innerHTML="";
  employees.forEach(emp=>{ const opt=document.createElement("option"); opt.value=emp; opt.textContent=emp; leaveSel.appendChild(opt); });
}

/* ----------------------------------------------------------
 * REPORT DOWNLOAD
 * ---------------------------------------------------------- */
async function downloadFullReport() {
  const el=document.getElementById("reportArea");
  const canvas=await html2canvas(el,{scale:2, backgroundColor:document.body.classList.contains("dark-mode")?"#181a1f":"#fff"});
  const img=canvas.toDataURL("image/png"); pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");
}

/* ----------------------------------------------------------
 * INIT
 * ---------------------------------------------------------- */
fetchData();
</script>
</body>
</html>
