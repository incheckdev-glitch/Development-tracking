<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* THEME VARIABLES */
    body {
      --bg: #f4f6f9;
      --text: #1f2a37;
      --card: #ffffff;
      --muted: #6b7280;
      --brand: #0d6efd;
      --accent: #00c9a7;
      --soft-red: #fcebea;
      --soft-yellow: #fff8e5;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    body.dark-mode {
      --bg: #181a1f;
      --text: #e5e7eb;
      --card: #1f232b;
      --muted: #9ca3af;
      --brand: #5aa2ff;
      --accent: #11e3c5;
      --soft-red: #402b2b;
      --soft-yellow: #3a3424;
    }

    /* SIDEBAR */
    .sidebar {
      min-height: 100vh;
      background: #15171c;
      color: #fff;
      padding: 20px;
    }
    .sidebar h4 { color: var(--accent); font-weight: 700; }
    .sidebar .nav-link { color: #b8bccc; border-radius: 6px; }
    .sidebar .nav-link:hover { color: #fff; background: #2c2f38; }

    /* CARDS */
    .card { background: var(--card); border-radius: 16px; border: none; }
    .kpi-card { color: #fff; }
    .kpi-blue { background: linear-gradient(135deg, #007bff, #00c6ff); }
    .kpi-green { background: linear-gradient(135deg, #28a745, #00e68a); }
    .kpi-orange { background: linear-gradient(135deg, #ff7e5f, #feb47b); }
    .kpi-purple { background: linear-gradient(135deg, #6f42c1, #b47bff); }
    .kpi-red { background: linear-gradient(135deg, #dc3545, #ff6b6b); }

    /* FILTERS */
    .filter-bar { background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }

    /* TABLE */
    .table-soft-danger { background-color: var(--soft-red) !important; }
    .table-soft-warning { background-color: var(--soft-yellow) !important; }

    /* GANTT */
    .gantt-container { overflow-x: auto; padding-bottom: 10px; border-radius: 12px; background: var(--card); }
    .gantt-row { display: flex; align-items: center; gap: 10px; padding: 6px 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .gantt-label { width: 160px; flex-shrink: 0; color: var(--muted); }
    .gantt-track { position: relative; height: 26px; flex-grow: 1; background: rgba(13,110,253,0.05); border-radius: 6px; }
    .gantt-bar { position: absolute; top: 3px; height: 20px; border-radius: 4px; background-color: #4dabf7; }

    .badge-space { gap: 6px; display: inline-flex; flex-wrap: wrap; }
    .form-hint { font-size: 0.8rem; color: var(--muted); }
    .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;}
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 sidebar d-flex flex-column">
        <h4>ðŸ“Š Attendance</h4>
        <ul class="nav flex-column mt-3">
          <li class="nav-item"><a class="nav-link" href="#summary">Summary</a></li>
          <li class="nav-item"><a class="nav-link" href="#filters">Filters</a></li>
          <li class="nav-item"><a class="nav-link" href="#charts">Charts</a></li>
          <li class="nav-item"><a class="nav-link" href="#gantt">Timeline</a></li>
          <li class="nav-item"><a class="nav-link" href="#table">Table</a></li>
        </ul>
        <div class="mt-auto">
          <button id="toggleThemeBtn" class="btn btn-outline-light w-100">ðŸŒ™ Dark Mode</button>
        </div>
      </div>

      <!-- Main -->
      <div class="col-lg-10 p-4">
        <div id="reportArea">
          <div class="d-flex align-items-center justify-content-between flex-wrap">
            <h2 class="mb-3">Employee Attendance Dashboard</h2>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" id="refreshBtn">ðŸ”„ Refresh</button>
              <button class="btn btn-primary" onclick="downloadFullReport()">ðŸ“„ Download Report</button>
            </div>
          </div>

          <!-- Filters -->
          <a id="filters" class="sr-only">Filters</a>
          <div class="filter-bar">
            <div class="row g-3">
              <div class="col-lg-3">
                <label class="form-label"><i class="bi bi-people"></i> Employee(s)</label>
                <select id="employeeFilter" class="form-select form-select-sm" multiple></select>
                <div class="form-hint">CTRL/CMD for multi-select</div>
              </div>
              <div class="col-lg-2">
                <label class="form-label"><i class="bi bi-calendar-event"></i> Start</label>
                <input type="date" id="startDate" class="form-control form-control-sm">
              </div>
              <div class="col-lg-2">
                <label class="form-label"><i class="bi bi-calendar-check"></i> End</label>
                <input type="date" id="endDate" class="form-control form-control-sm">
              </div>
              <div class="col-lg-2">
                <label class="form-label"><i class="bi bi-hourglass-split"></i> Hours</label>
                <div class="d-flex gap-1">
                  <input type="number" step="0.1" id="minHours" class="form-control form-control-sm" placeholder="Min">
                  <input type="number" step="0.1" id="maxHours" class="form-control form-control-sm" placeholder="Max">
                </div>
              </div>
              <div class="col-lg-2">
                <label class="form-label"><i class="bi bi-sunrise"></i> Shift</label>
                <select id="shiftFilter" class="form-select form-select-sm">
                  <option value="">All</option>
                  <option value="morning">Morning (&lt;12:00)</option>
                  <option value="afternoon">Afternoon (â‰¥12:00)</option>
                </select>
              </div>
              <div class="col-lg-1 d-flex align-items-end">
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">Reset</button>
              </div>
              <div class="col-lg-3">
                <label class="form-label"><i class="bi bi-search"></i> Quick Search</label>
                <input type="search" id="quickSearch" class="form-control form-control-sm" placeholder="e.g. Omar 2025-09-15">
              </div>
            </div>
          </div>

          <!-- KPIs -->
          <a id="summary" class="sr-only">Summary</a>
          <div class="row g-3 mb-4 text-center">
            <div class="col-md-2"><div class="card kpi-card kpi-blue p-3"><h6>Total Hours</h6><h2 id="totalHours">0</h2></div></div>
            <div class="col-md-2"><div class="card kpi-card kpi-green p-3"><h6>Avg Hours/Day</h6><h2 id="avgHours">0</h2></div></div>
            <div class="col-md-2"><div class="card kpi-card kpi-orange p-3"><h6>Days Count</h6><h2 id="daysCount">0</h2></div></div>
            <div class="col-md-2"><div class="card kpi-card kpi-purple p-3"><h6>Late Count</h6><h2 id="lateCount">0</h2></div></div>
            <div class="col-md-2"><div class="card kpi-card kpi-red p-3"><h6>Early Leaves</h6><h2 id="earlyCount">0</h2></div></div>
          </div>

          <!-- Charts -->
          <a id="charts" class="sr-only">Charts</a>
          <div class="row g-3 mb-4">
            <div class="col-lg-6"><div class="card shadow p-3"><h6>Daily Total Hours</h6><canvas id="barChart"></canvas></div></div>
            <div class="col-lg-6"><div class="card shadow p-3"><h6>Hours by Employee</h6><canvas id="pieChart"></canvas></div></div>
            <div class="col-12"><div class="card shadow p-3"><h6>Trend Over Time</h6><canvas id="lineChart"></canvas></div></div>
          </div>

          <!-- Timeline / Gantt -->
          <a id="gantt" class="sr-only">Timeline</a>
          <div class="card p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="m-0">Work Hours Timeline</h6>
              <small class="text-muted">Bars span Sign In â†’ Sign Out (scaled 06:00â€“20:00)</small>
            </div>
            <div class="gantt-container" id="ganttContainer"></div>
          </div>

          <!-- Table -->
          <a id="table" class="sr-only">Table</a>
          <div class="card shadow p-3">
            <h5>Attendance Log</h5>
            <table id="attendanceTable" class="table table-striped table-hover" style="width:100%">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Date</th>
                  <th>Employee</th>
                  <th>Sign In</th>
                  <th>Sign Out</th>
                  <th>Total Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div><!-- /reportArea -->
      </div>
    </div>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
let CANON = [], dataTable = null;

// Theme toggle
document.getElementById("toggleThemeBtn").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  const isDark = document.body.classList.contains("dark-mode");
  localStorage.setItem("theme", isDark ? "dark" : "light");
  document.getElementById("toggleThemeBtn").textContent = isDark ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
});
(function(){ if(localStorage.getItem("theme")==="dark"){document.body.classList.add("dark-mode");document.getElementById("toggleThemeBtn").textContent="â˜€ï¸ Light Mode";}})();

// Parse & normalize
function normalizeHeaders(row) {
  const o={}; Object.entries(row).forEach(([k,v])=>{if(!k)return; const key=k.toLowerCase().trim();o[key]=v}); return o;
}
function parseDate(s){if(!s)return null; return new Date(s);}
function hoursBetween(a,b){if(!a||!b)return null;return (b-a)/36e5;}
function mapRow(r){const emp=r["employee name"]||r["employee"]||"";const sin=parseDate(r["sign in time"]);const sout=parseDate(r["sign out time"]);let th=parseFloat(r["total hours"]);if(isNaN(th)&&sin&&sout)th=hoursBetween(sin,sout);return{month:r["month"],date:r["date"],employee:emp,signIn:r["sign in time"],signOut:r["sign out time"],signInDT:sin,signOutDT:sout,totalHours:th||0};}
function computeStatus(r){let s=[];if(r.signInDT&&r.signOutDT){const inLim=new Date(r.signInDT);inLim.setHours(8,15,0,0);const outLim=new Date(r.signOutDT);outLim.setHours(16,30,0,0);if(r.signInDT>inLim)s.push("Late");if(r.signOutDT<outLim)s.push("Early Leave");if(!s.length)s.push("On Time");}else{s.push("Missing");}return s;}

// Load
async function loadData(){const res=await fetch(CSV_URL);const csv=await res.text();const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});CANON=parsed.data.map(r=>mapRow(normalizeHeaders(r)));applyFilters();}
document.getElementById("refreshBtn").addEventListener("click", loadData);

// Filters
function getCriteria(){return{empSel:Array.from(document.getElementById("employeeFilter").selectedOptions).map(o=>o.value),start:document.getElementById("startDate").value,end:document.getElementById("endDate").value,minH:parseFloat(document.getElementById("minHours").value),maxH:parseFloat(document.getElementById("maxHours").value),shift:document.getElementById("shiftFilter").value,q:document.getElementById("quickSearch").value.toLowerCase().trim()};}
function applyFilters(){const c=getCriteria();let data=CANON.filter(r=>{if(c.empSel.length&&!c.empSel.includes(r.employee))return false;if(c.start&&r.signInDT&&r.signInDT<new Date(c.start))return false;if(c.end&&r.signOutDT&&r.signOutDT>new Date(c.end))return false;if(!isNaN(c.minH)&&r.totalHours<c.minH)return false;if(!isNaN(c.maxH)&&r.totalHours>c.maxH)return false;if(c.shift==="morning"&&r.signInDT&&r.signInDT.getHours()>=12)return false;if(c.shift==="afternoon"&&r.signInDT&&r.signInDT.getHours()<12)return false;if(c.q&&!`${r.employee} ${r.date}`.toLowerCase().includes(c.q))return false;return true});renderTable(data);}
["employeeFilter","startDate","endDate","minHours","maxHours","shiftFilter","quickSearch"].forEach(id=>{document.getElementById(id).addEventListener("input",applyFilters);});
function resetFilters(){["employeeFilter","startDate","endDate","minHours","maxHours","shiftFilter","quickSearch"].forEach(id=>document.getElementById(id).value="");applyFilters();}

// Render
function renderTable(data){
  if(dataTable){dataTable.clear().destroy();}
  const tbody=document.querySelector("#attendanceTable tbody");tbody.innerHTML="";
  let sum=0,days=new Set(),late=0,early=0;data.forEach(r=>{
    const st=computeStatus(r);
    if(st.includes("Late"))late++;
    if(st.includes("Early Leave"))early++;
    if(r.totalHours)sum+=r.totalHours;
    if(r.date)days.add(r.date);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.month}</td><td>${r.date}</td><td>${r.employee}</td><td>${r.signIn||""}</td><td>${r.signOut||""}</td><td>${r.totalHours.toFixed(2)}</td><td class="badge-space">${st.map(s=>`<span class="badge ${s==="Late"?"bg-danger":s==="Early Leave"?"bg-warning text-dark":s==="On Time"?"bg-success":"bg-secondary"}">${s}</span>`).join(" ")}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("totalHours").textContent=sum.toFixed(2);
  document.getElementById("avgHours").textContent=(days.size?sum/days.size:0).toFixed(2);
  document.getElementById("daysCount").textContent=days.size;
  document.getElementById("lateCount").textContent=late;
  document.getElementById("earlyCount").textContent=early;

  dataTable=$("#attendanceTable").DataTable({paging:true,searching:true,dom:"Bfrtip",buttons:["csv","excel","pdf","print"]});
  renderCharts(data); renderGantt(data);
}
let barChart,pieChart,lineChart;
function renderCharts(data){
  if(barChart)barChart.destroy(); if(pieChart)pieChart.destroy(); if(lineChart)lineChart.destroy();
  const grouped={}; data.forEach(r=>{if(r.date)grouped[r.date]=(grouped[r.date]||0)+r.totalHours;});
  barChart=new Chart(document.getElementById("barChart"),{type:"bar",data:{labels:Object.keys(grouped),datasets:[{label:"Hours",data:Object.values(grouped),backgroundColor:"#0d6efd"}]}});
  const per={}; data.forEach(r=>{if(r.employee)per[r.employee]=(per[r.employee]||0)+r.totalHours;});
  pieChart=new Chart(document.getElementById("pieChart"),{type:"pie",data:{labels:Object.keys(per),datasets:[{data:Object.values(per),backgroundColor:["#0d6efd","#00c9a7","#ff7e5f","#6f42c1","#ffc107"]}]}});
  lineChart=new Chart(document.getElementById("lineChart"),{type:"line",data:{labels:Object.keys(grouped),datasets:[{label:"Hours",data:Object.values(grouped),borderColor:"#28a745",fill:false}]}});
}
function renderGantt(data){
  const c=document.getElementById("ganttContainer");c.innerHTML="";
  const min=6,max=20,range=max-min;
  data.forEach(r=>{
    const row=document.createElement("div");row.className="gantt-row";
    const label=document.createElement("div");label.className="gantt-label";label.textContent=`${r.employee} (${r.date})`;row.appendChild(label);
    const track=document.createElement("div");track.className="gantt-track";
    if(r.signInDT&&r.signOutDT){
      const start=(r.signInDT.getHours()+r.signInDT.getMinutes()/60-min)/range*100;
      const end=(r.signOutDT.getHours()+r.signOutDT.getMinutes()/60-min)/range*100;
      const bar=document.createElement("div");bar.className="gantt-bar";bar.style.left=start+"%";bar.style.width=(end-start)+"%";track.appendChild(bar);
    }
    row.appendChild(track);c.appendChild(row);
  });
}

// Report
async function downloadFullReport(){
  const el=document.getElementById("reportArea");
  const canvas=await html2canvas(el,{scale:2,backgroundColor:document.body.classList.contains("dark-mode")?"#181a1f":"#fff"});
  const img=canvas.toDataURL("image/png");const pdf=new pdfMake.createPdf({content:[{image:img,width:500}]});pdf.download("Attendance_Report.pdf");
}

loadData();
</script>
</body>
</html>
