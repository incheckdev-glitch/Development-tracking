<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Intelligence — Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ======================= CSS LIBS ======================= -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- ======================= PAGE STYLES ======================= -->
  <style>
    /* Light theme (default) */
    :root{
      --bg: #f7f8fb;
      --card: #ffffff;
      --elev: #ffffff;
      --fg: #0f172a;
      --muted: #5b6477;
      --border: #e4e7ee;
      --accent: #7c3aed;
      --good: #16a34a;
      --warn: #f59e0b;
      --bad:  #ef4444;
      --chip: #eef2ff;
    }
    /* Dark theme override */
    body.dark-mode{
      --bg: #0b1220;
      --card: #101828;
      --elev: #0f172a;
      --fg: #e6edf7;
      --muted: #94a3b8;
      --border: #1f2a44;
      --accent: #7c3aed;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad:  #ef4444;
      --chip: #172554;
    }

    body { background: var(--bg); color: var(--fg); }
    .container-xxl{ max-width: 1400px; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3)); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 8px 30px rgba(15,23,42,.08); }
    body.dark-mode .glass { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); box-shadow: 0 8px 40px rgba(0,0,0,.35); }
    .toolbar { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(8px); }

    .kpi-card{ border-radius: 16px; padding: 16px; border: 1px solid var(--border); background: var(--card); }
    .kpi-title{ color: var(--muted); font-weight: 600; letter-spacing: .4px; }
    .kpi-value{ font-size: 1.9rem; font-weight: 800; }
    .chip{ padding: 2px 10px; border-radius: 999px; font-size: .75rem; border:1px solid var(--border); background: var(--chip); color: var(--muted); }

    .status-badge{ padding:.35rem .6rem; border-radius: 10px; font-weight:600; font-size:.78rem; display:inline-block; }
    .status-Present{ background: rgba(22,163,74,.12); color: var(--good); border:1px solid rgba(22,163,74,.35); }
    .status-Late, .status-Late\.\ Left\.\ Early{ background: rgba(245,158,11,.12); color: var(--warn); border:1px solid rgba(245,158,11,.35); }
    .status-Left\.\ Early{ background: rgba(239,68,68,.12); color: var(--bad); border:1px solid rgba(239,68,68,.35); }

    .datatable-wrap{ border-radius: 16px; overflow: hidden; border: 1px solid var(--border); background: var(--elev); }
    table.dataTable tbody tr:hover{ background: rgba(124,58,237,.08) !important; }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select{
      background: var(--bg); border:1px solid var(--border); color: var(--fg);
    }

    .select2-container--default .select2-selection--multiple{ background: var(--bg); color:var(--fg); border:1px solid var(--border); min-height: 38px; }
    .select2-container .select2-selection--multiple .select2-selection__choice{ background:#eaeefc; border:1px solid var(--border); color:var(--fg); }
    body.dark-mode .select2-container .select2-selection--multiple .select2-selection__choice{ background:#172036; }

    .btn-ghost{ background:transparent; border:1px solid var(--border); color: var(--fg); }
    .btn-ghost:hover{ background: rgba(124,58,237,.08); }

    .spark{ width:100%; height:46px; }
  </style>
</head>

<body>
  <!-- ===== Toolbar ===== -->
  <div class="toolbar glass py-3 mb-4">
    <div class="container-xxl d-flex justify-content-between align-items-center gap-3">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-graph-up-arrow fs-3" style="color: var(--accent)"></i>
        <div>
          <div class="fw-bold">Attendance Intelligence</div>
          <div class="text-secondary small">Live from Google Sheets</div>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="themeBtn" class="btn btn-ghost" title="Toggle light/dark"><i id="themeIcon" class="bi bi-moon-stars"></i></button>
        <button id="refreshBtn" class="btn btn-ghost"><i class="bi bi-arrow-repeat me-2"></i>Refresh</button>
        <button class="btn btn-primary" id="pdfBtn"><i class="bi bi-filetype-pdf me-2"></i>Export PDF</button>
      </div>
    </div>
  </div>

  <div class="container-xxl">
    <!-- ===== KPIs (only Working Days + Total Hours) ===== -->
    <div class="row g-3 mb-3">
      <div class="col-sm-6">
        <div class="kpi-card d-flex justify-content-between align-items-end">
          <div>
            <div class="kpi-title">Working Days</div>
            <div class="kpi-value" id="kpiDays">–</div>
          </div>
          <canvas id="sparkDays" class="spark"></canvas>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="kpi-card d-flex justify-content-between align-items-end">
          <div>
            <div class="kpi-title">Total Hours</div>
            <div class="kpi-value" id="kpiHours">–</div>
          </div>
          <canvas id="sparkHours" class="spark"></canvas>
        </div>
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <span class="chip">Last updated: <span id="kpiUpdated">–</span></span>
          <span class="chip">Auto-refresh: 60s</span>
        </div>
      </div>
    </div>

    <!-- ===== Filters ===== -->
    <div class="glass p-3 mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Month</label>
          <select id="monthFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Status</label>
          <select id="statusFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Date range</label>
          <div class="d-flex gap-2">
            <input type="date" id="startDate" class="form-control"/>
            <input type="date" id="endDate" class="form-control"/>
          </div>
        </div>
        <div class="col-lg-6">
          <label class="form-label">Quick Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search name, date, status..."/>
        </div>
        <div class="col-lg-6 text-end">
          <button class="btn btn-primary" id="applyBtn"><i class="bi bi-funnel me-2"></i>Apply</button>
          <button class="btn btn-ghost" id="resetBtn"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset</button>
        </div>
      </div>
    </div>

    <!-- ===== Table ===== -->
    <div class="datatable-wrap mb-4">
      <table id="attendanceTable" class="display nowrap" style="width:100%"></table>
    </div>

    <!-- ===== Charts ===== -->
    <div class="glass p-3 mb-5">
      <div class="row g-3">
        <div class="col-lg-6">
          <h6 class="text-secondary">Hours by Employee</h6>
          <canvas id="chartByEmp" height="160"></canvas>
        </div>
        <div class="col-lg-6">
          <h6 class="text-secondary">Hours over Time</h6>
          <canvas id="chartOverTime" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= JS LIBS ======================= -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ======================= APP SCRIPT ======================= -->
  <script>
    // === CONFIG ===
    const PUBLISHED_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=390845393&single=true&output=csv";
    const REFRESH_MS = 60_000;
    const TZ = "Asia/Beirut";

    function candidateURLs(){
      const t = Date.now();
      return [`${PUBLISHED_CSV}&cachebust=${t}`];
    }

    // === STATE ===
    let CANON = [];
    let DT = null;
    let chartByEmp, chartOverTime, sparkDays, sparkHours;

    const { DateTime } = luxon;

    // ==== THEME ==== //
    function applyTheme(mode){
      const root = document.body;
      if(mode === 'dark'){ root.classList.add('dark-mode'); }
      else { root.classList.remove('dark-mode'); }
      localStorage.setItem('theme', mode);
      document.getElementById('themeIcon').className = (mode==='dark') ? 'bi bi-brightness-high' : 'bi bi-moon-stars';
    }
    function initTheme(){
      const saved = localStorage.getItem('theme');
      if(saved){ applyTheme(saved); return; }
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    // ==== HELPERS ==== //
    function hmsFromHours(hours){
      if(!isFinite(hours)) return '';
      const sign = hours < 0 ? '-' : '';
      const total = Math.abs(hours);
      const h = Math.floor(total);
      const m = Math.round((total - h) * 60);
      return `${sign}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }
    function normalizeHeaders(r){ const o={}; for(const k in r){ if(!k) continue; o[k.trim().toLowerCase()]=r[k]; } return o; }
    function toISODate(s){
      if(!s) return ""; const x=String(s).trim(); if(!x) return "";
      const c=[DateTime.fromFormat(x,'d/M/yyyy'),DateTime.fromFormat(x,'d/M/yy'),DateTime.fromFormat(x,'yyyy-MM-dd'),DateTime.fromFormat(x,'d-M-yyyy'),DateTime.fromFormat(x,'M/d/yyyy'),DateTime.fromISO(x)];
      for(const t of c){ if(t.isValid) return t.toISODate(); }
      const d=new Date(x); return isNaN(d)?"":d.toISOString().slice(0,10);
    }
    function parsePunchWithDate(dateISO,val){ if(!dateISO||!val) return null; const s=String(val).trim(); if(!s||s==='-')return null; const a=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd H:mm'); if(a.isValid)return a; const b=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd H:mm:ss'); if(b.isValid)return b; const c=DateTime.fromFormat(`${dateISO} ${s}`,'yyyy-MM-dd h:mm a'); if(c.isValid)return c; const iso=DateTime.fromISO(s); if(iso.isValid)return iso; const d=new Date(`${dateISO}T${s.length===5?s+':00':s}`); return isNaN(d)?null:DateTime.fromJSDate(d); }

    function mapRow(r){
      const month = r['month name'] || r['month'] || '';
      const dateISO = toISODate(r['date'] || r['day'] || '');
      const siRaw = r['first in'] || r['sign in'] || r['in'] || '';
      const soRaw = r['last out']  || r['sign out'] || r['out'] || '';
      const hoursRaw = r['hours'];
      let total = !isNaN(parseFloat(hoursRaw)) ? parseFloat(hoursRaw) : NaN;
      if(!isFinite(total)){
        const si=dateISO?parsePunchWithDate(dateISO,siRaw):null; const so=dateISO?parsePunchWithDate(dateISO,soRaw):null; total = (si&&so)? so.diff(si,'hours').hours : 0;
      }
      const status = r['status'] || '';
      return { month: month || (dateISO?DateTime.fromISO(dateISO).toFormat('LLLL'):''), date: dateISO, employee: r['employee name']||r['employee']||r['name']||'', signIn: siRaw||'', signOut: soRaw||'', totalHours: total, status };
    }

    // ==== RENDER ==== //
    function renderKPIs(data){
      const uniqueDays = new Set(data.map(d=>d.date).filter(Boolean)).size;
      const hours = data.reduce((a,b)=> a + (isFinite(b.totalHours)? b.totalHours : 0), 0);
      document.getElementById('kpiDays').textContent = uniqueDays.toLocaleString();
      document.getElementById('kpiHours').textContent = hmsFromHours(hours);
      document.getElementById('kpiUpdated').textContent = DateTime.now().setZone(TZ).toFormat('yyyy-LL-dd HH:mm:ss ZZZZ');
      igniteSpark('sparkDays', uniqueDays || 1);
      igniteSpark('sparkHours', Math.round(hours) || 1);
    }

    function renderTable(data){
      const rows = data.map(r => ({
        Month: r.month, Date: r.date, Employee: r.employee, In: r.signIn, Out: r.signOut,
        Hours: isFinite(r.totalHours)? r.totalHours : null, Status: r.status
      }));
      const colDefs = [
        { title:'Month', data:'Month' },
        { title:'Date', data:'Date' },
        { title:'Employee', data:'Employee' },
        { title:'First In', data:'In' },
        { title:'Last Out', data:'Out' },
        { title:'Hours', data:'Hours', className:'text-end', render:d=> d==null?'':hmsFromHours(d) },
        { title:'Status', data:'Status', render:d=> `<span class="status-badge status-${(d||'').replace(/\s/g,'_')}">${d||''}</span>` }
      ];
      if(!DT){
        DT = $('#attendanceTable').DataTable({
          data: rows, columns: colDefs, responsive: true, fixedHeader: true,
          order: [[1,'desc'],[2,'asc']], pageLength: 12,
          dom: 'Bfrtip', buttons: [ { extend:'csv', title:'Attendance_Export' }, { extend:'print', title:'Attendance' }, { extend:'copy' } ],
          createdRow: function(row, data){
            if((data.Status||'').includes('Late')) row.style.backgroundColor = 'rgba(245,158,11,.06)';
            if((data.Status||'').includes('Left Early')) row.style.backgroundColor = 'rgba(239,68,68,.06)';
            if((data.Status||'')==='Present') row.style.backgroundColor = 'rgba(22,163,74,.06)';
          },
          footerCallback: function(){
            const api = this.api();
            const colIdx = 5; // Hours
            const sum = api.column(colIdx, { page: 'current' }).data().toArray().reduce((a,v)=> a + (typeof v==='number'?v:0), 0);
            if(!$(api.table().footer()).length){
              $(api.table().node()).append('<tfoot><tr></tr></tfoot>');
              const cells = colDefs.map(()=>'<th></th>');
              cells[colIdx] = `<th class="text-end">${hmsFromHours(sum)}</th>`;
              $(api.table().footer()).find('tr').html(cells.join(''));
            } else { $(api.table().footer()).find('th').eq(colIdx).html(hmsFromHours(sum)); }
          }
        });
      } else { DT.clear().rows.add(rows).draw(); }
    }

    function aggregateBy(data, keyFn, valFn){
      const m = new Map();
      for(const r of data){ const k = keyFn(r); const v = valFn(r) || 0; m.set(k, (m.get(k)||0) + v); }
      return Object.fromEntries(m);
    }

    function renderCharts(data){
      const byEmp = aggregateBy(data, r=>r.employee, r=>r.totalHours);
      const byDate = aggregateBy(data, r=>r.date, r=>r.totalHours);
      const empLabels = Object.keys(byEmp).sort((a,b)=> byEmp[b]-byEmp[a]).slice(0,15);
      const empData = empLabels.map(k=> byEmp[k]);
      const dateLabels = Object.keys(byDate).sort();
      const dateData = dateLabels.map(k=> byDate[k]);
      chartByEmp && chartByEmp.destroy();
      chartOverTime && chartOverTime.destroy();
      chartByEmp = new Chart(document.getElementById('chartByEmp'), { type:'bar', data:{ labels:empLabels, datasets:[{ label:'Hours', data:empData }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#64748b' } }, y:{ ticks:{ color:'#64748b' } } } } });
      chartOverTime = new Chart(document.getElementById('chartOverTime'), { type:'line', data:{ labels:dateLabels, datasets:[{ label:'Hours', data:dateData, tension:.3, fill:false }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#64748b' } }, y:{ ticks:{ color:'#64748b' } } } } });
    }

    function igniteSpark(id, value){
      const c = document.getElementById(id); if(!c) return;
      const ctx = c.getContext('2d'); const data = Array.from({length:8}, (_,i)=> Math.max(1, Math.round((i+1)*(value/10))));
      new Chart(ctx, { type:'line', data:{ labels:data.map((_,i)=>i+1), datasets:[{ data, pointRadius:0, tension:.3 }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false }, y:{ display:false } } } });
    }

    // ==== FILTERS ==== //
    function getCriteria(){
      return {
        employees: $('#employeeFilter').val() || [],
        months: $('#monthFilter').val() || [],
        statuses: $('#statusFilter').val() || [],
        start: startDate.value, end: endDate.value,
        q: (quickSearch.value || '').toLowerCase()
      };
    }
    function applyFilters(){
      const c = getCriteria();
      const filtered = CANON.filter(r => {
        if(c.employees.length && !c.employees.includes(r.employee)) return false;
        if(c.months.length && !c.months.includes(r.month)) return false;
        if(c.statuses.length && !c.statuses.includes(r.status)) return false;
        if(c.start && r.date < c.start) return false;
        if(c.end && r.date > c.end) return false;
        if(c.q && !`${r.employee} ${r.date} ${r.status}`.toLowerCase().includes(c.q)) return false;
        return true;
      });
      renderTable(filtered); renderKPIs(filtered); renderCharts(filtered);
    }
    function resetFilters(){
      $('#employeeFilter').val(null).trigger('change'); $('#monthFilter').val(null).trigger('change'); $('#statusFilter').val(null).trigger('change');
      startDate.value = ''; endDate.value = ''; quickSearch.value = ''; applyFilters();
    }
    function populateSelect(id, values, placeholder){
      const sel = document.getElementById(id); sel.innerHTML = '';
      [...new Set(values.filter(Boolean))].sort((a,b)=> a.localeCompare(b)).forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      $(`#${id}`).select2({ placeholder, allowClear:true, width:'100%' });
    }

    // ==== IO ==== //
    async function downloadFullReport(){
      const el = document.body; const canvas = await html2canvas(el, { scale: 2 }); const img = canvas.toDataURL('image/png');
      const doc = { content: [{ image: img, width: 520 }] }; pdfMake.createPdf(doc).download('Attendance_Pro_Report.pdf');
    }
    async function fetchCSV(){
      let lastErr; for(const url of candidateURLs()){ try{ const res = await fetch(url, { cache:'no-store' }); if(!res.ok) throw new Error(`HTTP ${res.status}`); return await res.text(); } catch(e){ lastErr=e; console.warn('Fetch failed', url, e);} }
      throw lastErr || new Error('All endpoints failed');
    }
    async function loadData(){
      try{
        const csv = await fetchCSV(); const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
        CANON = parsed.data.map(r => mapRow(normalizeHeaders(r))).filter(r => r.employee && r.date);
        populateSelect('employeeFilter', CANON.map(r=>r.employee), 'Employees');
        populateSelect('monthFilter', CANON.map(r=>r.month), 'Months');
        populateSelect('statusFilter', CANON.map(r=>r.status), 'Statuses');
        applyFilters();
      } catch(e){ console.error(e); alert('Failed to load data: '+e.message); }
    }

    // ==== EVENTS ==== //
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      applyTheme(next);
    });
    document.getElementById('pdfBtn').addEventListener('click', downloadFullReport);
    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', resetFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('quickSearch').addEventListener('input', applyFilters);

    setInterval(()=>{ if(document.visibilityState==='visible') loadData(); }, 60_000);

    // Kick-off
    initTheme();
    loadData();

    // Minimal tests (console)
    (function tests(){
      function ok(n,c){ (c?console.log:console.error)(`[TEST] ${n}: ${c?'OK':'FAIL'}`); }
      ok('candidateURLs returns cachebusted CSV', candidateURLs()[0].includes('output=csv') && candidateURLs()[0].includes('cachebust='));
    })();
  </script>
</body>
</html>
