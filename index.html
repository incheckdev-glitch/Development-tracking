<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS LIBS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

  <!-- JS LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body.dark-mode { background: #181a1f; color: #eee; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>

<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📊 Attendance Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">🌙/☀️</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Working Days</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Holidays</h5><h3 id="holidayCount">0</h3></div></div></div>
  </div>

  <!-- TABLE -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
    </div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
let CANON = [];
let DT = null;
let customHolidays = JSON.parse(localStorage.getItem("holidays") || "[]");

function toggleDark(){ document.body.classList.toggle("dark-mode"); }
function normalizeDate(d){
  if(!d) return "";
  const s = String(d).trim();
  if(s.includes("/")){
    const [dd,mm,yy] = s.split("/");
    if(dd && mm && yy){ return `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`; }
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  return "";
}
function parsePunchWithDate(dateISO, val){
  if(!val) return null;
  const s = String(val).trim();
  if(!s || s==="-" || s.toLowerCase()==="null") return null;
  if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){
    const t = s.length===5 ? s+":00" : s;
    const dt = new Date(`${dateISO}T${t}`);
    return isNaN(dt)? null: dt;
  }
  const dt = new Date(s);
  return isNaN(dt)? null: dt;
}
function mapRow(r){
  const dateISO = normalizeDate(r["date"]||"");
  const siRaw = r["sign in"]||"";
  const soRaw = r["sign out"]||"";
  const signInDT = dateISO? parsePunchWithDate(dateISO, siRaw): null;
  const signOutDT = dateISO? parsePunchWithDate(dateISO, soRaw): null;
  const totalHours = r["total hours"]? parseFloat(r["total hours"]):(signInDT && signOutDT? (signOutDT-signInDT)/36e5:0);
  return { month:r["month"]|| (dateISO? dateISO.slice(0,7):""), date:dateISO, employee:r["employee"]||"", signIn:siRaw, signOut:soRaw, signInDT, signOutDT, totalHours };
}
function computeStatus(row){
  if(!row.signInDT && !row.signOutDT) return ["Absent"];
  if((row.signInDT && !row.signOutDT)||(!row.signInDT && row.signOutDT)) return ["Needs Correction"];
  const status=[]; 
  const inMin=row.signInDT? row.signInDT.getHours()*60+row.signInDT.getMinutes():null;
  const outMin=row.signOutDT? row.signOutDT.getHours()*60+row.signOutDT.getMinutes():null;
  if(inMin!==null && inMin>495) status.push("Late"); // after 08:15
  if(outMin!==null && outMin<990) status.push("Early Leave"); // before 16:30
  if(row.totalHours>0 && row.totalHours<4) status.push("Half-day");
  if(row.totalHours>=9) status.push("Overtime");
  if(!status.length) status.push("On Time");
  return status;
}
function renderTable(data){
  const rows = data.map(r=>{
    const st=computeStatus(r);
    const badge = st.map(label=>`<span class="badge bg-${label==="Late"?"danger":label==="Early Leave"?"warning text-dark":label==="On Time"?"success":label==="Absent"?"dark":"secondary"}">${label}</span>`).join(" ");
    return [r.month||"",r.date||"",r.employee||"",r.signIn||"",r.signOut||"",isFinite(r.totalHours)? r.totalHours.toFixed(2):"",badge];
  });
  if(!DT){
    DT=$("#attendanceTable").DataTable({data:rows,columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Total Hours"},{title:"Status"}],dom:"Bfrtip",buttons:["csv","excel","pdf","print"],pageLength:10,order:[[1,"asc"]]});
  } else { DT.clear().rows.add(rows).draw(); }

  let sum=0, workingDays=new Set(), late=0,early=0,absent=0,holidays=0;
  data.forEach(r=>{
    const st=computeStatus(r);
    if(st.includes("Late")) late++;
    if(st.includes("Early Leave")) early++;
    if(st.includes("Absent")) absent++;
    if(r.totalHours) sum+=r.totalHours;
    if(r.date){
      const dow=new Date(`${r.date}T00:00:00`).getDay();
      const isWeekend=(dow===0||dow===6);
      const isHoliday=customHolidays.some(h=>h.date===r.date);
      if(!isWeekend && !isHoliday) workingDays.add(r.date);
      if(isHoliday) holidays++;
    }
  });

  document.getElementById("totalHours").textContent=sum.toFixed(2);
  document.getElementById("avgHours").textContent=(workingDays.size? (sum/workingDays.size):0).toFixed(2);
  document.getElementById("daysCount").textContent=workingDays.size;
  document.getElementById("lateCount").textContent=late;
  document.getElementById("earlyCount").textContent=early;
  document.getElementById("holidayCount").textContent=holidays;
}

async function loadData(){
  const res=await fetch(CSV_URL);
  const csv=await res.text();
  const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
  CANON=parsed.data.map(r=>mapRow(r)).filter(r=>r.employee && r.date);
  renderTable(CANON);
}
loadData();
</script>
</body>
</html>
