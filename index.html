<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body.dark-mode { background:#181a1f; color:#eee; }
    .card { transition:all 0.3s ease; }
    .card:hover { transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,0.1); }
    .holiday-row { background:#ffeeba!important; }
    .weekend-row { background:#f0f0f0!important; }
  </style>
</head>
<body>
<div class="container-fluid p-4" id="reportArea">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📊 Attendance Dashboard</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleDark()">🌙/☀️</button>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      <button class="btn btn-primary" onclick="saveToServer()">💾 Save</button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4 text-center">
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Days</h5><h3 id="daysCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Late</h5><h3 id="lateCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Early</h5><h3 id="earlyCount">0</h3></div></div></div>
    <div class="col-md-2"><div class="card"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
  </div>

  <!-- Leave & Holiday Summary -->
  <div class="row mb-4 text-center">
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Annual Leave</h5><h3 id="alCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Sick Leave</h5><h3 id="slCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Unpaid Leave</h5><h3 id="ulCount">0</h3></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><h5>Holidays</h5><h3 id="holidayCount">0</h3></div></div></div>
  </div>

  <!-- Attendance Table -->
  <div class="card mb-4"><div class="card-body">
    <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
  </div></div>

  <!-- Balances -->
  <div class="card mb-4"><div class="card-body">
    <h5>Employee Balances</h5>
    <table class="table table-bordered" id="balanceTable">
      <thead><tr><th>Employee</th><th>AL Entitled</th><th>AL Used</th><th>AL Remaining</th><th>SL Entitled</th><th>SL Used</th><th>SL Remaining</th></tr></thead>
      <tbody></tbody>
    </table>
  </div></div>

  <!-- Leave Manager -->
  <div class="card mb-4"><div class="card-body">
    <h5>📅 Leave Manager</h5>
    <div class="row g-2">
      <div class="col-md-3"><input type="date" id="leaveDate" class="form-control"/></div>
      <div class="col-md-3"><input type="text" id="leaveEmployee" class="form-control" placeholder="Employee"/></div>
      <div class="col-md-3">
        <select id="leaveType" class="form-control">
          <option value="Annual Leave">Annual Leave</option>
          <option value="Sick Leave">Sick Leave</option>
          <option value="Unpaid Leave">Unpaid Leave</option>
        </select>
      </div>
      <div class="col-md-3"><button class="btn btn-primary" onclick="addLeave()">Add Leave</button></div>
    </div>
    <ul id="leaveList" class="list-group mt-3"></ul>
  </div></div>

  <!-- Balance Manager -->
  <div class="card mb-4"><div class="card-body">
    <h5>⚖️ Balance Manager</h5>
    <div class="row g-2">
      <div class="col-md-3"><input type="text" id="balEmployee" class="form-control" placeholder="Employee"/></div>
      <div class="col-md-2"><input type="number" id="balAL" class="form-control" placeholder="AL Entitled"/></div>
      <div class="col-md-2"><input type="number" id="balSL" class="form-control" placeholder="SL Entitled"/></div>
      <div class="col-md-2"><button class="btn btn-primary" onclick="setBalance()">Set Balance</button></div>
    </div>
  </div></div>
</div>

<script>
const CSV_SUMMARY="https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
const API_URL="https://script.google.com/macros/s/AKfycbwJQUkt5YlHZZk5fwKBU-p3ltTgkPpyj_KpSKayGX6Aqqp-wjO54dKi8RlNrzGCMwIw1A/exec";
const API_TOKEN="a9fj32klsdfj0932LKJSDF90wef9";

let CANON=[], table, HOLIDAYS=[], LEAVES=[], BALANCES=[];

// Helpers
function normalizeDate(d){if(!d) return "";const s=String(d).trim();if(s.includes("/")){const [m,dd,y]=s.split("/");return `${y}-${m.padStart(2,"0")}-${dd.padStart(2,"0")}`;}return s;}
function parseTime(dateStr,timeStr){if(!dateStr||!timeStr) return null;return new Date(`${dateStr}T${timeStr}`);}
function toggleDark(){document.body.classList.toggle("dark-mode");}
function computeStatus(r){
  const found=LEAVES.find(l=>l.date===r.date&&l.employee===r.employee);
  if(found) return [found.type];
  if(!r.signIn && !r.signOut) return ["Absent"];
  return ["On Time"];
}

// Load Data
async function loadData(){
  // Attendance
  const res=await fetch(CSV_SUMMARY);const raw=Papa.parse(await res.text(),{header:true}).data;
  CANON=raw.map(row=>{
    const r={};for(const k in row){if(!k) continue;r[k.trim()]=row[k];}
    const d=normalizeDate(r["Date"]);
    return {month:r["Month"]||"",date:d,employee:r["Employee Name"]||"",signIn:r["Sign In Time"]||"",signOut:r["Sign Out Time"]||"",signInDT:parseTime(d,r["Sign In Time"]),signOutDT:parseTime(d,r["Sign Out Time"]),totalHours:parseFloat(r["Total Hours"]||0)};
  }).filter(r=>r.employee&&r.date);

  // Holidays / Leaves / Balances
  const apiRes=await fetch(`${API_URL}?token=${API_TOKEN}`);const j=await apiRes.json();
  if(j.ok){HOLIDAYS=j.holidays;LEAVES=j.leaves;BALANCES=j.balances;}else{console.warn("API error",j);}
  renderTable(CANON);renderBalances();renderLeaves();
}

// Attendance Table
function renderTable(data){
  if(table){table.destroy();document.getElementById("attendanceTable").innerHTML="";}
  const rows=data.map(r=>[r.month,r.date,r.employee,r.signIn,r.signOut,(r.totalHours?r.totalHours.toFixed(2):"0.00"),computeStatus(r).join(",")]);
  table=$("#attendanceTable").DataTable({data:rows,columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Hours"},{title:"Status"}],dom:"Bfrtip",buttons:["copy","csv","excel","print"],scrollX:true});

  // KPIs
  let total=0,days=0,abs=0,al=0,sl=0,ul=0;
  data.forEach(r=>{
    const st=computeStatus(r);
    if(st.includes("Absent")) abs++;
    if(st.includes("Annual Leave")) al++;
    if(st.includes("Sick Leave")) sl++;
    if(st.includes("Unpaid Leave")) ul++;
    if(st[0]==="On Time"){total+=r.totalHours||0;days++;}
  });
  document.getElementById("totalHours").textContent=total.toFixed(1);
  document.getElementById("daysCount").textContent=days;
  document.getElementById("avgHours").textContent=days?(total/days).toFixed(1):0;
  document.getElementById("absentCount").textContent=abs;
  document.getElementById("alCount").textContent=al;
  document.getElementById("slCount").textContent=sl;
  document.getElementById("ulCount").textContent=ul;
  document.getElementById("holidayCount").textContent=HOLIDAYS.length;
}

// Render Balances
function renderBalances(){
  const tb=document.querySelector("#balanceTable tbody");tb.innerHTML="";
  BALANCES.forEach(b=>{
    const usedAL=LEAVES.filter(l=>l.employee===b.employee&&l.type==="Annual Leave").length;
    const usedSL=LEAVES.filter(l=>l.employee===b.employee&&l.type==="Sick Leave").length;
    tb.innerHTML+=`<tr><td>${b.employee}</td><td>${b.al}</td><td>${usedAL}</td><td>${b.al-usedAL}</td><td>${b.sl}</td><td>${usedSL}</td><td>${b.sl-usedSL}</td></tr>`;
  });
}

// Render Leaves
function renderLeaves(){
  const ul=document.getElementById("leaveList");ul.innerHTML="";
  LEAVES.forEach((l,i)=>{ul.innerHTML+=`<li class="list-group-item d-flex justify-content-between"><span>${l.date} - ${l.employee} (${l.type})</span><button class="btn btn-sm btn-danger" onclick="removeLeave(${i})">X</button></li>`;});
}

// Add Leave
function addLeave(){
  const date=document.getElementById("leaveDate").value;
  const emp=document.getElementById("leaveEmployee").value;
  const type=document.getElementById("leaveType").value;
  if(!date||!emp) return alert("Fill all fields");
  LEAVES.push({date,employee:emp,type});
  renderLeaves();renderBalances();renderTable(CANON);
}

// Remove Leave
function removeLeave(i){LEAVES.splice(i,1);renderLeaves();renderBalances();renderTable(CANON);}

// Set Balance
function setBalance(){
  const emp=document.getElementById("balEmployee").value;
  const al=parseInt(document.getElementById("balAL").value||0);
  const sl=parseInt(document.getElementById("balSL").value||0);
  const idx=BALANCES.findIndex(b=>b.employee===emp);
  if(idx>=0){BALANCES[idx].al=al;BALANCES[idx].sl=sl;}else{BALANCES.push({employee:emp,al,sl});}
  renderBalances();
}

// PDF
async function downloadFullReport(){
  const el=document.getElementById("reportArea");
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");
}

// Save
async function saveToServer(){
  const body={holidays:HOLIDAYS,leaves:LEAVES,balances:BALANCES,settings:[]};
  const res=await fetch(`${API_URL}?token=${API_TOKEN}`,{method:"POST",body:JSON.stringify(body)});
  alert("Saved: "+await res.text());
}

// Start
loadData();
</script>
</body>
</html>
