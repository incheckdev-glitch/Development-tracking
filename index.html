<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      /* Status colors */
      --status-resolved:#10b981;
      --status-underdev:#3b82f6;
      --status-rejected:#ef4444;
      --status-onhold:#f59e0b;
      --status-notstarted:#6b7280;
      --status-sent:#8b5cf6;
      --status-onstage:#0ea5e9;

      /* Priority colors */
      --priority-high:#ef4444;
      --priority-medium:#f59e0b;
      --priority-low:#10b981;

      /* Theme (dark default) */
      --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280; --border:#1e2643;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(79,140,255,.35);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff; --card:#ffffff; --muted:#5a678c; --text:#0d1326;
      --accent:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
      --info:#1d4ed8; --purple:#7c3aed; --neutral:#374151; --border:#e7eaf6;
      --shadow:0 10px 24px rgba(16,24,40,.08);
      --focus: 0 0 0 3px rgba(37,99,235,.25);
    }

    * { box-sizing:border-box }
    html,body { height:100% }
    body {
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); transition:background .3s,color .3s;
    }
    :focus-visible { outline: none; box-shadow: var(--focus); border-radius: 8px; }

    /* Topbar */
    header {
      position:sticky; top:0; z-index:20; background:var(--card);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      box-shadow:var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; }
    .brand .logo {
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--accent),#9b8cff);
      color:#fff; font-weight:800; box-shadow:0 6px 18px rgba(79,140,255,.35);
    }
    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn, .select, .input {
      padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:transparent; color:inherit; font:inherit;
      transition: all .2s;
    }
    .btn { cursor:pointer; font-weight:600; background:var(--card) }
    .btn.primary { background:var(--accent); border-color:transparent; color:#fff }
    .btn:hover { opacity:.92; transform:translateY(-1px) }
    .icon { font-size:18px; line-height:1 }

    /* Layout */
    .wrap { display:grid; grid-template-columns:280px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto }
    @media(max-width:980px){ .wrap { grid-template-columns:1fr } }

    /* Sidebar */
    .sidebar {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      position:sticky; top:76px; height:fit-content; max-height:calc(100vh - 96px); overflow:auto;
    }
    .sidebar h3 { margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em }

    /* Content */
    .content { display:grid; gap:18px }
    .grid { display:grid; gap:16px }
    .grid.cols-4 { grid-template-columns:repeat(4,1fr) }
    @media(max-width:980px){ .grid.cols-4{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:600px){ .grid.cols-4{ grid-template-columns:1fr } }

    /* Cards */
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      box-shadow:var(--shadow); transition:transform .2s, box-shadow .2s;
    }
    .card:hover { transform:translateY(-2px) }

    /* KPI */
    .kpi { cursor:pointer; text-align:center; }
    .kpi .label { font-size:12px; color:var(--muted); text-transform:uppercase }
    .kpi .value { font-size:26px; font-weight:800; margin-top:6px }
    .kpi .sub { font-size:12px; color:var(--muted); margin-top:4px }

    /* Charts */
    .charts { display:grid; grid-template-columns:repeat(2,1fr); gap:16px }
    @media(max-width:980px){ .charts{ grid-template-columns:1fr } }

    /* Table */
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    thead th {
      position:sticky; top:0; background:var(--card); text-align:left; padding:12px 10px;
      border-bottom:1px solid var(--border); user-select:none; cursor:pointer;
    }
    tbody td { padding:11px 10px; border-bottom:1px solid var(--border) }
    tr:hover { background:rgba(255,255,255,.05) }
    .table-wrap { max-height:460px; overflow:auto; border-radius:10px; border:1px solid var(--border) }

    .pill { padding:2px 8px; border-radius:12px; font-size:12px; font-weight:700; display:inline-block }
    .status-Resolved { background: var(--status-resolved); color:#fff }
    .status-Under\ Development { background: var(--status-underdev); color:#fff }
    .status-Rejected { background: var(--status-rejected); color:#fff }
    .status-On\ Hold { background: var(--status-onhold); color:#fff }
    .status-Not\ Started\ Yet { background: var(--status-notstarted); color:#fff }
    .status-Sent { background: var(--status-sent); color:#fff }
    .status-On\ Stage { background: var(--status-onstage); color:#fff }

    .priority-High { background: var(--priority-high); color:#fff }
    .priority-Medium { background: var(--priority-medium); color:#fff }
    .priority-Low { background: var(--priority-low); color:#fff }

    /* Spinner */
    .spinner { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:120; align-items:center; justify-content:center }
    .spinner .ring { width:54px; height:54px; border:5px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; background:transparent }
    @keyframes spin { to { transform:rotate(360deg) } }

    .toast {
      position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--danger);
      color:#fff; padding:10px 12px; border-radius:10px; z-index:130; box-shadow:var(--shadow); display:none
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">IC</div><div>InCheck Issues</div></div>
    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Searchâ€¦" />
      <select id="themeSelect" class="select">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button id="refreshNow" class="btn">ðŸ”„ Refresh</button>
      <button id="exportBtn" class="btn">ðŸ“¸ Export Report</button>
    </div>
  </header>

  <div class="wrap">
    <aside class="sidebar">
      <h3>Filters</h3>
      <label>Module <select id="moduleFilter" class="select"></select></label>
      <label>Priority <select id="priorityFilter" class="select"></select></label>
      <label>Status <select id="statusFilter" class="select"></select></label>
    </aside>
    <main class="content">
      <div class="grid cols-4" id="kpis"></div>
      <div class="charts">
        <div class="card"><canvas id="byModule" height="140"></canvas></div>
        <div class="card"><canvas id="byPriority" height="140"></canvas></div>
        <div class="card"><canvas id="byStatus" height="140"></canvas></div>
        <div class="card"><canvas id="byType" height="140"></canvas></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Issues</strong><span id="rowCount" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table id="issuesTable">
            <thead><tr>
              <th>ID</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th><th>Type</th><th>Date</th>
            </tr></thead>
            <tbody><tr><td colspan="7" style="text-align:center;color:var(--muted)">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div class="spinner" id="spinner"><div class="ring"></div></div>
  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_zyuaejPwZomAhzvaDOUwajunj7jYsAeWR4_yFQsYtubfaFCa6tWKeqP7hklvSRDM97BOyoPWTVSh/pub?output=csv";

  const els = {
    tableBody: document.querySelector('#issuesTable tbody'),
    rowCount: document.querySelector('#rowCount'),
    moduleFilter: document.querySelector('#moduleFilter'),
    priorityFilter: document.querySelector('#priorityFilter'),
    statusFilter: document.querySelector('#statusFilter'),
    refresh: document.querySelector('#refreshNow'),
    search: document.querySelector('#searchInput'),
    themeSelect: document.querySelector('#themeSelect'),
    spinner: document.querySelector('#spinner'),
    toast: document.querySelector('#toast'),
    exportBtn: document.querySelector('#exportBtn')
  };

  let rows = [], filtered = [], charts = {};

  function normalizeRow(r){
    return {
      id: r["Incheck Id"] || "",
      module: r["Module"] || "Unspecified",
      title: r["Title"] || "",
      priority: r["Priority"] || "",
      status: r["Task Status"] || "",
      type: r["Type"] || "",
      date: r["Date"] || ""
    };
  }

  function parseCsv(t){ 
    return Papa.parse(t,{header:true,skipEmptyLines:true}).data.map(normalizeRow);
  }

  function renderTable(){
    els.tableBody.innerHTML = filtered.map(r=>`
      <tr>
        <td>${r.id}</td>
        <td>${r.module}</td>
        <td>${r.title}</td>
        <td><span class="pill priority-${r.priority}">${r.priority}</span></td>
        <td><span class="pill status-${r.status.replace(/\s/g,'\\ ')}">${r.status}</span></td>
        <td>${r.type}</td>
        <td>${r.date}</td>
      </tr>
    `).join('');
    els.rowCount.textContent = `${filtered.length} rows`;
  }

  function groupCount(list,key){
    return list.reduce((a, r) => {
      const val = r[key] || 'Unspecified';
      a[val] = (a[val]||0)+1;
      return a;
    },{});
  }

  function drawCharts(){
    const ctx = id => document.getElementById(id);
    const make = (id,type,data) => {
      if(charts[id]) charts[id].destroy();
      const labels = Object.keys(data), values = Object.values(data);
      charts[id] = new Chart(ctx(id),{
        type,
        data:{labels,datasets:[{data:values,backgroundColor:['#4f8cff','#10b981','#f59e0b','#ef4444','#8b5cf6','#0ea5e9']}]},
        options:{responsive:true,plugins:{legend:{display:type!=='bar'}}}
      });
    };
    make('byModule','bar',groupCount(filtered,'module'));
    make('byPriority','doughnut',groupCount(filtered,'priority'));
    make('byStatus','bar',groupCount(filtered,'status'));
    make('byType','bar',groupCount(filtered,'type'));
  }

  async function loadSheet(){
    try{
      els.spinner.style.display='flex';
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      rows = parseCsv(text);
      filtered=[...rows];
      renderTable(); drawCharts();
    }catch(e){ els.toast.textContent="Error loading sheet"; els.toast.style.display="block"; }
    finally{ els.spinner.style.display='none'; }
  }

  // Export screenshot
  els.exportBtn.addEventListener('click', () => {
    const target = document.querySelector('.wrap');
    html2canvas(target, { backgroundColor: getComputedStyle(document.body).backgroundColor })
      .then(canvas => {
        const link = document.createElement('a');
        link.download = `InCheck_Report_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
  });

  // Theme
  els.themeSelect.addEventListener('change', ()=> {
    const v=els.themeSelect.value;
    if(v==='system') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme',v);
  });

  els.refresh.addEventListener('click', loadSheet);

  loadSheet();
});
</script>
</body>
</html>
